# 09-æ’åºä¸åˆ†é¡µ

> æŒæ¡ORDER BYæ’åºå’ŒLIMITåˆ†é¡µï¼Œå®ç°é«˜æ•ˆçš„æ•°æ®å±•ç¤º

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- æŒæ¡ORDER BYçš„å„ç§æ’åºæ–¹å¼
- æŒæ¡LIMITåˆ†é¡µæŸ¥è¯¢
- ç†è§£æ·±åˆ†é¡µé—®é¢˜åŠè§£å†³æ–¹æ¡ˆ
- æŒæ¡æ’åºæ€§èƒ½ä¼˜åŒ–æŠ€å·§
- å®ç°å¸¸è§çš„æ’åºåˆ†é¡µåœºæ™¯

---

## ä¸€ã€ORDER BYæ’åº

### 1.1 å•å­—æ®µæ’åº

```sql
-- å‡åºï¼ˆASCï¼Œé»˜è®¤ï¼‰
SELECT * FROM products ORDER BY price_cents;
SELECT * FROM products ORDER BY price_cents ASC;

-- é™åºï¼ˆDESCï¼‰
SELECT * FROM products ORDER BY price_cents DESC;

-- æŒ‰åˆ›å»ºæ—¶é—´é™åºï¼ˆæœ€æ–°çš„åœ¨ï¿½ï¿½ï¼‰
SELECT * FROM articles ORDER BY created_at DESC;

-- æŒ‰é”€é‡é™åº
SELECT * FROM products ORDER BY sales_count DESC;
```

### 1.2 å¤šå­—æ®µæ’åº

```sql
-- å…ˆæŒ‰åˆ†ç±»å‡åºï¼ŒåŒåˆ†ç±»å†…æŒ‰ä»·æ ¼é™åº
SELECT * FROM products
ORDER BY category_id ASC, price_cents DESC;

-- å…ˆæŒ‰çŠ¶æ€ï¼Œå†æŒ‰åˆ›å»ºæ—¶é—´
SELECT * FROM orders
ORDER BY status ASC, created_at DESC;

-- å®æˆ˜ç¤ºä¾‹ï¼šå•†å“åˆ—è¡¨
SELECT
    id,
    name,
    price_cents / 100 AS price,
    sales_count,
    stock
FROM products
WHERE status = 1
ORDER BY
    sales_count DESC,  -- é”€é‡é«˜çš„åœ¨å‰
    created_at DESC    -- é”€é‡ç›¸åŒæ—¶ï¼Œï¿½ï¿½ï¿½å“åœ¨å‰
LIMIT 20;
```

**æ’åºè§„åˆ™**ï¼š
- ä¼˜å…ˆæŒ‰ç¬¬ä¸€ä¸ªå­—æ®µæ’åº
- ç¬¬ä¸€ä¸ªå­—æ®µç›¸åŒæ—¶ï¼ŒæŒ‰ç¬¬äºŒä¸ªå­—æ®µæ’åº
- ä»¥æ­¤ç±»æ¨

### 1.3 è¡¨è¾¾å¼æ’åº

```sql
-- æŒ‰ä»·æ ¼ï¼ˆå…ƒï¼‰é™åº
SELECT
    id,
    name,
    price_cents,
    price_cents / 100 AS price_yuan
FROM products
ORDER BY (price_cents / 100) DESC;

-- æŒ‰æŠ˜æ‰£åŠ›åº¦æ’åº
SELECT
    id,
    name,
    original_price,
    current_price,
    (original_price - current_price) AS discount
FROM products
ORDER BY (original_price - current_price) DESC;

-- æŒ‰å­—ç¬¦ä¸²é•¿åº¦æ’åº
SELECT id, title
FROM articles
ORDER BY CHAR_LENGTH(title) DESC;

-- æŒ‰éšæœºæ’åº
SELECT * FROM products
ORDER BY RAND()
LIMIT 10;
-- âš ï¸ æ³¨æ„ï¼šRAND()æ€§èƒ½å¾ˆå·®ï¼Œä¸é€‚åˆå¤§è¡¨
```

### 1.4 CASE WHENè‡ªå®šä¹‰æ’åº

```sql
-- æŒ‰çŠ¶æ€è‡ªå®šä¹‰æ’åºï¼šå¾…æ”¯ä»˜ > å·²æ”¯ä»˜ > å…¶ä»–
SELECT
    id,
    order_no,
    status,
    created_at
FROM orders
ORDER BY
    CASE status
        WHEN 1 THEN 1  -- å¾…æ”¯ä»˜
        WHEN 2 THEN 2  -- å·²æ”¯ä»˜
        ELSE 3         -- å…¶ä»–
    END,
    created_at DESC;

-- æŒ‡å®šå€¼ä¼˜å…ˆæ’åº
SELECT
    id,
    name,
    category_id
FROM products
ORDER BY
    CASE category_id
        WHEN 5 THEN 1   -- åˆ†ç±»5ä¼˜å…ˆ
        WHEN 3 THEN 2   -- åˆ†ç±»3æ¬¡ä¹‹
        ELSE 3          -- å…¶ä»–æœ€å
    END,
    sales_count DESC;
```

### 1.5 FIELDè‡ªå®šä¹‰æ’åº

```sql
-- æŒ‰æŒ‡å®šé¡ºåºæ’åº
SELECT * FROM users
WHERE id IN (5, 2, 8, 1, 3)
ORDER BY FIELD(id, 5, 2, 8, 1, 3);
-- ç»“æœæŒ‰ï¼š5, 2, 8, 1, 3 é¡ºåºè¿”å›

-- å®æˆ˜ç¤ºä¾‹ï¼šå•†å“åˆ—è¡¨æŒ‰æŒ‡å®šé¡ºåºå±•ç¤º
SET @product_ids = '100,205,103,201';

SELECT * FROM products
WHERE id IN (100, 205, 103, 201)
ORDER BY FIELD(id, 100, 205, 103, 201);
```

### 1.6 NULLå€¼æ’åº

```sql
-- ç¤ºä¾‹æ•°æ®
CREATE TABLE test_null (
    id INT,
    score INT
);

INSERT INTO test_null VALUES
(1, 80),
(2, NULL),
(3, 90),
(4, NULL),
(5, 70);

-- å‡åºï¼šNULLåœ¨å‰
SELECT * FROM test_null ORDER BY score ASC;
-- ç»“æœï¼šNULL, NULL, 70, 80, 90

-- é™åºï¼šNULLåœ¨å‰
SELECT * FROM test_null ORDER BY score DESC;
-- ç»“æœï¼šNULL, NULL, 90, 80, 70

-- NULLæ’åœ¨æœ€åï¼ˆASCï¼‰
SELECT * FROM test_null
ORDER BY IFNULL(score, 999999) ASC;
-- æˆ–
SELECT * FROM test_null
ORDER BY score IS NULL, score ASC;

-- NULLæ’åœ¨æœ€åï¼ˆDESCï¼‰
SELECT * FROM test_null
ORDER BY score IS NULL, score DESC;
```

---

## äºŒã€LIMITåˆ†é¡µ

### 2.1 LIMITåŸºç¡€

```sql
-- é™åˆ¶è¿”å›è¡Œæ•°
SELECT * FROM users LIMIT 10;  -- å‰10æ¡

-- ç­‰ä»·äº
SELECT * FROM users LIMIT 0, 10;

-- LIMIT offset, count
SELECT * FROM users LIMIT 0, 10;   -- ç¬¬1-10æ¡
SELECT * FROM users LIMIT 10, 10;  -- ç¬¬11-20æ¡
SELECT * FROM users LIMIT 20, 10;  -- ç¬¬21-30æ¡

-- LIMIT count OFFSET offsetï¼ˆMySQL 8.0+ï¼‰
SELECT * FROM users LIMIT 10 OFFSET 0;   -- ç¬¬1-10æ¡
SELECT * FROM users LIMIT 10 OFFSET 10;  -- ç¬¬11-20æ¡
SELECT * FROM users LIMIT 10 OFFSET 20;  -- ç¬¬21-30æ¡
```

### 2.2 åˆ†é¡µè®¡ç®—

```sql
-- åˆ†é¡µå…¬å¼ï¼šLIMIT (page - 1) * page_size, page_size

-- ç¬¬1é¡µï¼Œæ¯é¡µ20æ¡
-- page = 1, page_size = 20
-- offset = (1 - 1) * 20 = 0
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 0, 20;

-- ç¬¬2é¡µï¼Œæ¯é¡µ20æ¡
-- page = 2, page_size = 20
-- offset = (2 - 1) * 20 = 20
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 20, 20;

-- ç¬¬3é¡µï¼Œæ¯é¡µ20æ¡
-- page = 3, page_size = 20
-- offset = (3 - 1) * 20 = 40
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 40, 20;
```

**åˆ†é¡µæŸ¥è¯¢å®Œæ•´ç¤ºä¾‹**ï¼š

```sql
-- åº”ç”¨å±‚ä»£ç ï¼ˆPythonç¤ºä¾‹ï¼‰
def get_articles(page, page_size):
    offset = (page - 1) * page_size

    sql = """
        SELECT
            id,
            title,
            author_username,
            created_at
        FROM articles
        WHERE status = 2
        AND deleted_at IS NULL
        ORDER BY created_at DESC
        LIMIT %s OFFSET %s
    """

    return db.query(sql, (page_size, offset))

# è·å–ç¬¬1é¡µ
articles = get_articles(page=1, page_size=20)

# è·å–ç¬¬2é¡µ
articles = get_articles(page=2, page_size=20)
```

### 2.3 åˆ†é¡µæ€»æ•°æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æ€»è®°å½•æ•°
SELECT COUNT(*) AS total FROM articles
WHERE status = 2
AND deleted_at IS NULL;

-- åˆ†é¡µæ•°æ®
SELECT
    id,
    title,
    author_username,
    created_at
FROM articles
WHERE status = 2
AND deleted_at IS NULL
ORDER BY created_at DESC
LIMIT 0, 20;

-- è®¡ç®—æ€»é¡µæ•°
-- total_pages = CEIL(total_count / page_size)
-- ç¤ºä¾‹ï¼štotal_count = 95, page_size = 20
-- total_pages = CEIL(95 / 20) = CEIL(4.75) = 5
```

**ä¼˜åŒ–ï¼šä½¿ç”¨SQL_CALC_FOUND_ROWS**

```sql
-- ä¸€æ¬¡æŸ¥è¯¢è·å–æ•°æ®å’Œæ€»æ•°ï¼ˆä¸æ¨èï¼Œæ€§èƒ½å·®ï¼‰
SELECT SQL_CALC_FOUND_ROWS
    id,
    title,
    created_at
FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 0, 20;

-- è·å–æ€»æ•°
SELECT FOUND_ROWS() AS total;

-- æ¨èåšæ³•ï¼š
-- 1. æ€»æ•°æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆRedisï¼‰
-- 2. æˆ–è€…åªåœ¨ç¬¬ä¸€é¡µæŸ¥è¯¢æ€»æ•°
-- 3. æˆ–è€…ä½¿ç”¨ä¼°ç®—å€¼ï¼ˆEXPLAINï¼‰
```

### 2.4 æ·±åˆ†é¡µé—®é¢˜

```sql
-- é—®é¢˜ï¼šæ·±åˆ†é¡µæ€§èƒ½å·®

-- ç¬¬1é¡µï¼ˆå¿«ï¼‰
SELECT * FROM users
ORDER BY created_at DESC
LIMIT 0, 20;
-- æ‰«æï¼š0 + 20 = 20è¡Œ

-- ç¬¬100é¡µï¼ˆæ…¢ï¼‰
SELECT * FROM users
ORDER BY created_at DESC
LIMIT 1980, 20;
-- æ‰«æï¼š1980 + 20 = 2000è¡Œ

-- ç¬¬10000é¡µï¼ˆå¾ˆæ…¢ï¼‰
SELECT * FROM users
ORDER BY created_at DESC
LIMIT 199980, 20;
-- æ‰«æï¼š199980 + 20 = 200000è¡Œ

-- MySQLéœ€è¦å…ˆæ‰«æ199980è¡Œï¼Œç„¶åä¸¢å¼ƒï¼Œåªè¿”å›æœ€å20è¡Œ
```

**æ·±åˆ†é¡µé—®é¢˜åŸå› **ï¼š
- LIMIT offset, count éœ€è¦å…ˆæ‰«æ offset + count è¡Œ
- offsetè¶Šå¤§ï¼Œæ‰«æçš„è¡Œæ•°è¶Šå¤š
- ä¸¢å¼ƒå‰é¢çš„offsetè¡Œï¼Œæµªè´¹èµ„æº

---

## ä¸‰ã€æ·±åˆ†é¡µä¼˜åŒ–

### 3.1 å­æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ æ…¢æŸ¥è¯¢ï¼šç›´æ¥LIMITæ·±åˆ†é¡µ
SELECT * FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 100000, 20;

-- âœ… ä¼˜åŒ–ï¼šå­æŸ¥è¯¢åªæŸ¥ID
SELECT * FROM articles
WHERE id >= (
    SELECT id FROM articles
    WHERE status = 2
    ORDER BY created_at DESC
    LIMIT 100000, 1
)
AND status = 2
ORDER BY created_at DESC
LIMIT 20;

-- åŸç†ï¼š
-- 1. å­æŸ¥è¯¢åªè¿”å›idï¼ˆè¦†ç›–ç´¢å¼•ï¼Œå¿«ï¼‰
-- 2. å¤–å±‚æŸ¥è¯¢ç”¨idèŒƒå›´è¿‡æ»¤ï¼ˆå‡å°‘å›è¡¨ï¼‰
```

### 3.2 å»¶è¿Ÿå…³è”ä¼˜åŒ–

```sql
-- âŒ æ…¢æŸ¥è¯¢
SELECT * FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 100000, 20;

-- âœ… ä¼˜åŒ–ï¼šå»¶è¿Ÿå…³è”
SELECT a.*
FROM articles a
INNER JOIN (
    SELECT id FROM articles
    WHERE status = 2
    ORDER BY created_at DESC
    LIMIT 100000, 20
) AS t ON a.id = t.id;

-- åŸç†ï¼š
-- 1. å­æŸ¥è¯¢åªæŸ¥idï¼ˆè¦†ç›–ç´¢å¼•ï¼‰
-- 2. å¤–å±‚JOINå›è¡¨è·å–å®Œæ•´æ•°æ®
-- 3. å‡å°‘äº†å›è¡¨çš„è¡Œæ•°
```

### 3.3 è®°å½•ä¸Šæ¬¡ä½ç½®ï¼ˆæ¨èï¼‰

```sql
-- âŒ ä¼ ç»Ÿåˆ†é¡µ
-- ç¬¬1é¡µ
SELECT * FROM articles
WHERE status = 2
ORDER BY id DESC
LIMIT 20;

-- ç¬¬2é¡µ
SELECT * FROM articles
WHERE status = 2
ORDER BY id DESC
LIMIT 20, 20;

-- âœ… æ¸¸æ ‡åˆ†é¡µï¼ˆè®°å½•ä¸Šæ¬¡ä½ç½®ï¼‰
-- ç¬¬1é¡µ
SELECT * FROM articles
WHERE status = 2
ORDER BY id DESC
LIMIT 20;
-- è¿”å›ï¼šidæœ€å°å€¼ = 9980

-- ç¬¬2é¡µï¼ˆä½¿ç”¨ä¸Šä¸€é¡µçš„æœ€å°idï¼‰
SELECT * FROM articles
WHERE status = 2
AND id < 9980  -- ä½¿ç”¨ä¸Šä¸€é¡µçš„æœ€å°id
ORDER BY id DESC
LIMIT 20;
-- è¿”å›ï¼šidæœ€å°å€¼ = 9960

-- ç¬¬3é¡µ
SELECT * FROM articles
WHERE status = 2
AND id < 9960
ORDER BY id DESC
LIMIT 20;

-- ä¼˜ç‚¹ï¼š
-- 1. æ€§èƒ½ç¨³å®šï¼Œä¸éšé¡µæ•°å¢åŠ è€Œå˜æ…¢
-- 2. å¯ä»¥ä½¿ç”¨ç´¢å¼•
-- 3. é€‚åˆæ— é™æ»šåŠ¨åŠ è½½

-- ç¼ºç‚¹ï¼š
-- 1. ä¸èƒ½è·³é¡µ
-- 2. åªèƒ½é¡ºåºç¿»é¡µ
```

**åº”ç”¨å±‚å®ç°ï¼ˆPythonç¤ºä¾‹ï¼‰**ï¼š

```python
def get_articles(last_id=None, page_size=20):
    if last_id:
        sql = """
            SELECT id, title, created_at
            FROM articles
            WHERE status = 2
            AND id < %s
            ORDER BY id DESC
            LIMIT %s
        """
        results = db.query(sql, (last_id, page_size))
    else:
        # ç¬¬ä¸€é¡µ
        sql = """
            SELECT id, title, created_at
            FROM articles
            WHERE status = 2
            ORDER BY id DESC
            LIMIT %s
        """
        results = db.query(sql, (page_size,))

    return results

# ç¬¬1é¡µ
articles = get_articles(last_id=None, page_size=20)
last_id = articles[-1]['id']  # 9980

# ç¬¬2é¡µ
articles = get_articles(last_id=9980, page_size=20)
last_id = articles[-1]['id']  # 9960

# ç¬¬3é¡µ
articles = get_articles(last_id=9960, page_size=20)
```

### 3.4 åªå…è®¸æŸ¥çœ‹å‰Né¡µ

```sql
-- é™åˆ¶æœ€å¤§é¡µæ•°
SET @max_page = 100;
SET @page_size = 20;
SET @max_offset = (@max_page - 1) * @page_size;  -- 1980

-- åº”ç”¨å±‚é™åˆ¶
IF page > 100:
    raise Exception("æœ€å¤šåªèƒ½æŸ¥çœ‹å‰100é¡µ")

-- æˆ–è¿”å›æç¤º
SELECT * FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 1980, 20;
-- å¦‚æœpage > 100ï¼Œè¿”å›é”™è¯¯æˆ–è·³è½¬åˆ°ç¬¬100é¡µ
```

---

## å››ã€æ’åºæ€§èƒ½ä¼˜åŒ–

### 4.1 ç´¢å¼•æ’åº vs æ–‡ä»¶æ’åº

```sql
-- åˆ›å»ºç´¢å¼•
CREATE TABLE articles (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    view_count INT UNSIGNED NOT NULL DEFAULT 0,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_created_at (created_at)
) ENGINE=InnoDB;

-- âœ… ä½¿ç”¨ç´¢å¼•æ’åºï¼ˆå¿«ï¼‰
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 20;

-- æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 20;
-- Extra: Using index

-- âŒ æ— æ³•ä½¿ç”¨ç´¢å¼•æ’åºï¼ˆæ…¢ï¼‰
SELECT * FROM articles
ORDER BY view_count DESC  -- view_countæ²¡æœ‰ç´¢å¼•
LIMIT 20;

-- æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM articles
ORDER BY view_count DESC
LIMIT 20;
-- Extra: Using filesortï¼ˆæ–‡ä»¶æ’åºï¼Œæ…¢ï¼‰
```

**æ–‡ä»¶æ’åºï¼ˆfilesortï¼‰è¿‡ç¨‹**ï¼š
1. MySQLæ‰«æè¡¨ï¼Œè¯»å–æ‰€æœ‰è¡Œ
2. åœ¨å†…å­˜æˆ–ä¸´æ—¶æ–‡ä»¶ä¸­æ’åº
3. è¿”å›ç»“æœ

**ç´¢å¼•æ’åºè¿‡ç¨‹**ï¼š
1. MySQLç›´æ¥æŒ‰ç´¢å¼•é¡ºåºè¯»å–æ•°æ®
2. æ— éœ€é¢å¤–æ’åº
3. æ€§èƒ½è¿œä¼˜äºfilesort

### 4.2 è¦†ç›–ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºè”åˆç´¢å¼•
CREATE INDEX idx_status_created ON articles(status, created_at);

-- âœ… è¦†ç›–ç´¢å¼•æŸ¥è¯¢ï¼ˆæœ€å¿«ï¼‰
SELECT id, status, created_at
FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 20;

-- æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT id, status, created_at
FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 20;
-- Extra: Using indexï¼ˆè¦†ç›–ç´¢å¼•ï¼Œä¸å›è¡¨ï¼‰

-- âŒ éœ€è¦å›è¡¨ï¼ˆè¾ƒæ…¢ï¼‰
SELECT *  -- åŒ…å«äº†ç´¢å¼•å¤–çš„å­—æ®µ
FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 20;

-- æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT *
FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 20;
-- Extra: Using index conditionï¼ˆéœ€è¦å›è¡¨ï¼‰
```

### 4.3 ORDER BY + LIMITä¼˜åŒ–

```sql
-- MySQLçš„ORDER BY + LIMITä¼˜åŒ–
-- å¦‚æœLIMITå¾ˆå°ï¼ŒMySQLä¼šä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—æ’åº

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢å‰10æ¡
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 10;

-- MySQLä¼šï¼š
-- 1. ç»´æŠ¤ä¸€ä¸ªå¤§å°ä¸º10çš„ä¼˜å…ˆé˜Ÿåˆ—
-- 2. æ‰«ææ•°æ®æ—¶ï¼Œåªä¿ç•™æœ€å¤§çš„10ä¸ªå€¼
-- 3. ä¸éœ€è¦å®Œæ•´æ’åºæ‰€æœ‰æ•°æ®

-- ä½†å¦‚æœLIMITå¾ˆå¤§ï¼Œä¼˜åŒ–å¤±æ•ˆ
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 100000;
-- éœ€è¦å®Œæ•´æ’åº
```

### 4.4 é¿å…SELECT *

```sql
-- âŒ ä¸æ¨è
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 20;

-- âœ… æ¨èï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
SELECT
    id,
    title,
    author_username,
    view_count,
    created_at
FROM articles
ORDER BY created_at DESC
LIMIT 20;

-- ä¼˜ç‚¹ï¼š
-- 1. å‡å°‘æ•°æ®ä¼ è¾“
-- 2. å¯èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•
-- 3. å‡å°‘å›è¡¨æ¬¡æ•°
```

---

## äº”ã€å®æˆ˜æ¡ˆä¾‹

### 5.1 å•†å“åˆ—è¡¨ï¼ˆå¤šæ¡ä»¶æ’åºï¼‰

```sql
-- éœ€æ±‚ï¼šå•†å“åˆ—è¡¨ï¼ŒæŒ‰é”€é‡é™åºï¼Œé”€é‡ç›¸åŒæŒ‰ä»·æ ¼å‡åºï¼Œä»·æ ¼ç›¸åŒæŒ‰ä¸Šæ¶æ—¶é—´é™åº

SELECT
    id,
    name,
    price_cents / 100 AS price,
    sales_count,
    stock,
    created_at
FROM products
WHERE status = 1           -- ä¸Šæ¶
AND stock > 0              -- æœ‰åº“å­˜
AND deleted_at IS NULL
ORDER BY
    sales_count DESC,      -- é”€é‡é«˜çš„åœ¨å‰
    price_cents ASC,       -- ä»·æ ¼ä½çš„åœ¨å‰
    created_at DESC        -- æ–°å“åœ¨å‰
LIMIT 20 OFFSET 0;

-- åˆ›å»ºè”åˆç´¢å¼•
CREATE INDEX idx_status_stock_sales_price_created
ON products(status, stock, sales_count DESC, price_cents ASC, created_at DESC);
```

### 5.2 æ–‡ç« åˆ—è¡¨ï¼ˆæ— é™æ»šåŠ¨ï¼‰

```sql
-- ç¬¬1æ¬¡åŠ è½½
SELECT
    id,
    title,
    author_username,
    view_count,
    created_at
FROM articles
WHERE status = 2
AND deleted_at IS NULL
ORDER BY id DESC
LIMIT 20;
-- è¿”å›ï¼šidèŒƒå›´ 10000 ~ 9981

-- ç¬¬2æ¬¡åŠ è½½ï¼ˆä½¿ç”¨ä¸Šæ¬¡çš„æœ€å°idï¼‰
SELECT
    id,
    title,
    author_username,
    view_count,
    created_at
FROM articles
WHERE status = 2
AND deleted_at IS NULL
AND id < 9981  -- ä¸Šæ¬¡çš„æœ€å°id
ORDER BY id DESC
LIMIT 20;
-- è¿”å›ï¼šidèŒƒå›´ 9980 ~ 9961

-- ç´¢å¼•
CREATE INDEX idx_status_deleted_id
ON articles(status, deleted_at, id DESC);
```

### 5.3 ç”¨æˆ·æ’è¡Œæ¦œï¼ˆTop Nï¼‰

```sql
-- æŸ¥è¯¢æ¶ˆè´¹æ’è¡Œæ¦œå‰100å
SELECT
    u.id,
    u.username,
    SUM(o.pay_amount) / 100 AS total_spent
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE o.status IN (2, 3, 4)  -- å·²æ”¯ä»˜ã€å·²å‘è´§ã€å·²å®Œæˆ
AND o.deleted_at IS NULL
GROUP BY u.id, u.username
ORDER BY total_spent DESC
LIMIT 100;

-- ä¼˜åŒ–ï¼šä½¿ç”¨å†—ä½™å­—æ®µ
ALTER TABLE users
ADD COLUMN total_spent BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ç´¯è®¡æ¶ˆè´¹ï¼ˆåˆ†ï¼‰',
ADD INDEX idx_total_spent (total_spent DESC);

-- æŸ¥è¯¢æ’è¡Œæ¦œï¼ˆä½¿ç”¨å†—ä½™å­—æ®µï¼‰
SELECT
    id,
    username,
    total_spent / 100 AS total_spent_yuan
FROM users
WHERE deleted_at IS NULL
ORDER BY total_spent DESC
LIMIT 100;

-- ç»´æŠ¤å†—ä½™å­—æ®µï¼ˆè®¢å•å®Œæˆæ—¶ï¼‰
UPDATE users
SET total_spent = total_spent + :pay_amount
WHERE id = :user_id;
```

### 5.4 çƒ­é—¨å†…å®¹ï¼ˆç»¼åˆæ’åºï¼‰

```sql
-- éœ€æ±‚ï¼šç»¼åˆæ’åº = æµè§ˆé‡ * 0.3 + ç‚¹èµæ•° * 0.5 + è¯„è®ºæ•° * 0.2

-- æ–¹å¼1ï¼šå®æ—¶è®¡ç®—
SELECT
    id,
    title,
    view_count,
    like_count,
    comment_count,
    (view_count * 0.3 + like_count * 0.5 + comment_count * 0.2) AS hot_score
FROM articles
WHERE status = 2
ORDER BY hot_score DESC
LIMIT 50;

-- æ–¹å¼2ï¼šå†—ä½™çƒ­åº¦åˆ†æ•°å­—æ®µï¼ˆæ¨èï¼‰
ALTER TABLE articles
ADD COLUMN hot_score DECIMAL(10, 2) NOT NULL DEFAULT 0 COMMENT 'çƒ­åº¦åˆ†æ•°',
ADD INDEX idx_hot_score (hot_score DESC);

-- å®šæ—¶è®¡ç®—çƒ­åº¦åˆ†æ•°ï¼ˆæ¯å°æ—¶ï¼‰
UPDATE articles
SET hot_score = view_count * 0.3 + like_count * 0.5 + comment_count * 0.2
WHERE status = 2;

-- æŸ¥è¯¢
SELECT
    id,
    title,
    view_count,
    like_count,
    comment_count,
    hot_score
FROM articles
WHERE status = 2
ORDER BY hot_score DESC
LIMIT 50;
```

### 5.5 åˆ†é¡µ+ç­›é€‰+æ’åºç»¼åˆç¤ºä¾‹

```sql
-- éœ€æ±‚ï¼šå•†å“åˆ—è¡¨ï¼Œæ”¯æŒåˆ†ç±»ç­›é€‰ã€ä»·æ ¼åŒºé—´ç­›é€‰ã€å…³é”®è¯æœç´¢ã€å¤šç§æ’åºæ–¹å¼

-- åº”ç”¨å±‚ä»£ç ï¼ˆPythonç¤ºä¾‹ï¼‰
def get_products(
    category_id=None,
    min_price=None,
    max_price=None,
    keyword=None,
    sort_by='sales',  # sales, price_asc, price_desc, newest
    page=1,
    page_size=20
):
    conditions = ["status = 1", "stock > 0", "deleted_at IS NULL"]
    params = []

    # åˆ†ç±»ç­›é€‰
    if category_id:
        conditions.append("category_id = %s")
        params.append(category_id)

    # ä»·æ ¼åŒºé—´
    if min_price is not None:
        conditions.append("price_cents >= %s")
        params.append(min_price * 100)

    if max_price is not None:
        conditions.append("price_cents <= %s")
        params.append(max_price * 100)

    # å…³é”®è¯æœç´¢
    if keyword:
        conditions.append("name LIKE %s")
        params.append(f"%{keyword}%")

    # æ’åº
    order_map = {
        'sales': 'sales_count DESC',
        'price_asc': 'price_cents ASC',
        'price_desc': 'price_cents DESC',
        'newest': 'created_at DESC'
    }
    order_by = order_map.get(sort_by, 'sales_count DESC')

    # åˆ†é¡µ
    offset = (page - 1) * page_size

    # æ„å»ºSQL
    where_clause = " AND ".join(conditions)
    sql = f"""
        SELECT
            id,
            name,
            price_cents / 100 AS price,
            sales_count,
            stock,
            created_at
        FROM products
        WHERE {where_clause}
        ORDER BY {order_by}
        LIMIT %s OFFSET %s
    """

    params.extend([page_size, offset])

    return db.query(sql, params)

# ä½¿ç”¨ç¤ºä¾‹
products = get_products(
    category_id=1,
    min_price=100,
    max_price=500,
    keyword='æ‰‹æœº',
    sort_by='price_asc',
    page=1,
    page_size=20
)
```

---

## å…­ã€æ’åºä¸åˆ†é¡µæœ€ä½³å®è·µ

### 6.1 ç´¢å¼•è®¾è®¡åŸåˆ™

```sql
-- 1. ORDER BYå­—æ®µåŠ ç´¢å¼•
CREATE INDEX idx_created_at ON articles(created_at);

-- 2. WHERE + ORDER BYï¼šè”åˆç´¢å¼•
CREATE INDEX idx_status_created ON articles(status, created_at);

-- 3. å¤šå­—æ®µæ’åºï¼šè”åˆç´¢å¼•ï¼ˆæ³¨æ„é¡ºåºï¼‰
CREATE INDEX idx_sales_price_created
ON products(sales_count DESC, price_cents ASC, created_at DESC);

-- 4. è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«SELECTçš„å­—æ®µï¼‰
CREATE INDEX idx_status_created_id
ON articles(status, created_at, id);
```

### 6.2 åˆ†é¡µè®¾è®¡å»ºè®®

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç¤ºä¾‹ |
|------|---------|------|
| æ™®é€šåˆ—è¡¨ï¼ˆ<100é¡µï¼‰ | LIMIT OFFSET | å•†å“åˆ—è¡¨ |
| æ·±åˆ†é¡µ | æ¸¸æ ‡åˆ†é¡µï¼ˆè®°å½•ä½ç½®ï¼‰ | æ— é™æ»šåŠ¨ |
| æ’è¡Œæ¦œ | å†—ä½™æ’åºå­—æ®µ | ç”¨æˆ·æ’è¡Œ |
| æœç´¢ç»“æœ | é™åˆ¶æœ€å¤§é¡µæ•° | æœç´¢å¼•æ“ |

### 6.3 å¸¸è§é”™è¯¯

```sql
-- âŒ é”™è¯¯1ï¼šORDER BYéç´¢å¼•å­—æ®µ
SELECT * FROM articles
ORDER BY RAND()  -- æ€§èƒ½æå·®
LIMIT 10;

-- âœ… æ­£ç¡®ï¼šå…ˆæŸ¥IDï¼Œå†éšæœº
SELECT * FROM articles
WHERE id IN (
    SELECT id FROM (
        SELECT id FROM articles
        ORDER BY RAND()
        LIMIT 10
    ) AS tmp
);

-- âŒ é”™è¯¯2ï¼šæ·±åˆ†é¡µä¸ä¼˜åŒ–
SELECT * FROM articles
ORDER BY created_at DESC
LIMIT 1000000, 20;  -- ææ…¢

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
SELECT * FROM articles
WHERE id < :last_id
ORDER BY id DESC
LIMIT 20;

-- âŒ é”™è¯¯3ï¼šåˆ†é¡µæ²¡æœ‰ORDER BY
SELECT * FROM articles LIMIT 20;
-- ç»“æœé¡ºåºä¸ç¡®å®šï¼Œå¯èƒ½æ¯æ¬¡ä¸åŒ

-- âœ… æ­£ç¡®ï¼šæ€»æ˜¯åŠ ORDER BY
SELECT * FROM articles
ORDER BY id DESC
LIMIT 20;
```

---

## ä¸ƒã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ORDER BYæ’åº**ï¼š
   - å•å­—æ®µã€å¤šå­—æ®µæ’åº
   - è¡¨è¾¾å¼æ’åº
   - CASE WHENã€FIELDè‡ªå®šä¹‰æ’åº
   - NULLå€¼æ’åºå¤„ç†

2. **LIMITåˆ†é¡µ**ï¼š
   - åŸºç¡€è¯­æ³•ï¼šLIMIT offset, count
   - åˆ†é¡µè®¡ç®—ï¼šoffset = (page - 1) * page_size
   - æ·±åˆ†é¡µé—®é¢˜ï¼šoffsetè¶Šå¤§è¶Šæ…¢

3. **æ·±åˆ†é¡µä¼˜åŒ–**ï¼š
   - å­æŸ¥è¯¢ä¼˜åŒ–
   - å»¶è¿Ÿå…³è”
   - æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰
   - é™åˆ¶æœ€å¤§é¡µæ•°

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ç´¢å¼•æ’åº > æ–‡ä»¶æ’åº
   - è¦†ç›–ç´¢å¼•é¿å…å›è¡¨
   - ORDER BY + LIMITä¼˜åŒ–
   - é¿å…SELECT *

5. **å®æˆ˜åº”ç”¨**ï¼š
   - å•†å“åˆ—è¡¨ï¼ˆå¤šæ¡ä»¶æ’åºï¼‰
   - æ— é™æ»šåŠ¨ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰
   - æ’è¡Œæ¦œï¼ˆå†—ä½™å­—æ®µï¼‰
   - ç»¼åˆæ’åºï¼ˆçƒ­åº¦åˆ†æ•°ï¼‰

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… ç¼–å†™å„ç§ORDER BYæ’åºæŸ¥è¯¢
- âœ… å®ç°é«˜æ•ˆçš„åˆ†é¡µåŠŸèƒ½
- âœ… è§£å†³æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜
- âœ… ä¼˜åŒ–æ’åºæŸ¥è¯¢æ€§èƒ½

**ğŸ‰ æ­å–œå®Œæˆç¬¬äºŒç« ï¼**

ä¸‹ä¸€ç« ï¼š[ç¬¬ä¸‰ç«  - å¤šè¡¨æŸ¥è¯¢](./10-è¡¨å…³è”æŸ¥è¯¢åŸºç¡€.md)
