# 06-å•è¡¨å¢åˆ æ”¹æŸ¥åŸºç¡€

> æŒæ¡MySQLå•è¡¨çš„CRUDæ“ä½œï¼Œå»ºç«‹æ‰å®çš„SQLåŸºç¡€

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- æŒæ¡CREATE TABLEçš„å®Œæ•´è¯­æ³•
- æŒæ¡INSERTçš„å„ç§æ–¹å¼
- æŒæ¡SELECTçš„åŸºç¡€æŸ¥è¯¢
- æŒæ¡UPDATEçš„å„ç§åœºæ™¯
- æŒæ¡DELETEå’ŒTRUNCATEçš„åŒºåˆ«
- ç†è§£è½¯åˆ é™¤çš„å®ç°

---

## ä¸€ã€CREATE TABLEï¼ˆå»ºè¡¨ï¼‰

### 1.1 åŸºç¡€è¯­æ³•

```sql
CREATE TABLE table_name (
    column1 datatype constraints,
    column2 datatype constraints,
    ...,
    table_constraints
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¡¨æ³¨é‡Š';
```

### 1.2 å®Œæ•´ç¤ºä¾‹

```sql
CREATE TABLE users (
    -- ä¸»é”®
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT 'ç”¨æˆ·ID',

    -- åŸºæœ¬å­—æ®µ
    username VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) NOT NULL COMMENT 'é‚®ç®±',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç ',

    -- å¯é€‰å­—æ®µ
    nickname VARCHAR(50) NOT NULL DEFAULT '' COMMENT 'æ˜µç§°',
    avatar VARCHAR(255) NOT NULL DEFAULT '' COMMENT 'å¤´åƒURL',
    phone VARCHAR(20) NOT NULL DEFAULT '' COMMENT 'æ‰‹æœºå·',

    -- çŠ¶æ€å­—æ®µ
    status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ2-ç¦ç”¨',

    -- æ—¶é—´æˆ³
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    deleted_at DATETIME DEFAULT NULL COMMENT 'åˆ é™¤æ—¶é—´',

    -- çº¦æŸ
    UNIQUE KEY uniq_username (username),
    UNIQUE KEY uniq_email (email),
    INDEX idx_phone (phone),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB AUTO_INCREMENT=10000 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·è¡¨';
```

### 1.3 å­—æ®µçº¦æŸ

```sql
CREATE TABLE products (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- NOT NULLï¼šä¸å…è®¸ä¸ºç©º
    name VARCHAR(200) NOT NULL,

    -- DEFAULTï¼šé»˜è®¤å€¼
    price_cents BIGINT UNSIGNED NOT NULL DEFAULT 0,
    stock INT UNSIGNED NOT NULL DEFAULT 0,

    -- UNIQUEï¼šå”¯ä¸€çº¦æŸ
    sku VARCHAR(50) NOT NULL UNIQUE,

    -- CHECKï¼šæ£€æŸ¥çº¦æŸï¼ˆMySQL 8.0.16+ï¼‰
    rating DECIMAL(3, 2) CHECK (rating >= 0 AND rating <= 5),

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;
```

### 1.4 è¡¨é€‰é¡¹

```sql
-- å­˜å‚¨å¼•æ“
ENGINE=InnoDB           -- æ¨èï¼šæ”¯æŒäº‹åŠ¡ã€å¤–é”®ã€è¡Œé”

-- å­—ç¬¦é›†
DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci

-- è‡ªå¢èµ·å§‹å€¼
AUTO_INCREMENT=10000

-- è¡¨æ³¨é‡Š
COMMENT='å•†å“è¡¨'

-- è¡Œæ ¼å¼
ROW_FORMAT=DYNAMIC

-- å®Œï¿½ï¿½ç¤ºä¾‹
CREATE TABLE orders (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    order_no VARCHAR(32) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_order_no (order_no)
) ENGINE=InnoDB
  AUTO_INCREMENT=100000
  DEFAULT CHARSET=utf8mb4
  COLLATE=utf8mb4_unicode_ci
  ROW_FORMAT=DYNAMIC
  COMMENT='è®¢å•è¡¨';
```

### 1.5 æŸ¥çœ‹è¡¨ç»“æ„

```sql
-- æ–¹å¼1ï¼šDESCRIBEï¼ˆç®€å†™DESCï¼‰
DESC users;
DESCRIBE users;

-- æ–¹å¼2ï¼šSHOW COLUMNS
SHOW COLUMNS FROM users;
SHOW FULL COLUMNS FROM users;  -- æ˜¾ç¤ºæ›´å¤šä¿¡æ¯

-- æ–¹å¼3ï¼šSHOW CREATE TABLE
SHOW CREATE TABLE users;

-- æ–¹å¼4ï¼šinformation_schema
SELECT
    COLUMN_NAME,
    COLUMN_TYPE,
    IS_NULLABLE,
    COLUMN_DEFAULT,
    COLUMN_COMMENT
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = 'crud_practice'
AND TABLE_NAME = 'users';
```

---

## äºŒã€INSERTï¼ˆæ’å…¥æ•°æ®ï¼‰

### 2.1 å•æ¡æ’å…¥

```sql
-- åŸºç¡€è¯­æ³•ï¼šæŒ‡å®šæ‰€æœ‰å­—æ®µ
INSERT INTO users (username, email, password, nickname, status)
VALUES ('zhangsan', 'zhangsan@example.com', 'hashed_password', 'å¼ ä¸‰', 1);

-- çœç•¥å­—æ®µåï¼ˆä¸æ¨èï¼‰
INSERT INTO users
VALUES (NULL, 'lisi', 'lisi@example.com', 'hashed_password', 'æå››', '', '', 1, NOW(), NOW(), NULL);

-- ä½¿ç”¨DEFAULT
INSERT INTO users (username, email, password)
VALUES ('wangwu', 'wangwu@example.com', 'hashed_password');
-- nicknameã€avatarç­‰ä½¿ç”¨DEFAULTå€¼

-- è·å–æ’å…¥çš„ID
INSERT INTO users (username, email, password) VALUES ('zhaoliu', 'zhaoliu@example.com', 'pwd');
SELECT LAST_INSERT_ID();  -- è¿”å›æœ€åæ’å…¥çš„è‡ªå¢ID
```

### 2.2 æ‰¹é‡æ’å…¥

```sql
-- ä¸€æ¬¡æ’å…¥å¤šè¡Œï¼ˆæ¨èï¼Œæ€§èƒ½å¥½ï¼‰
INSERT INTO users (username, email, password) VALUES
('user1', 'user1@example.com', 'pwd1'),
('user2', 'user2@example.com', 'pwd2'),
('user3', 'user3@example.com', 'pwd3'),
('user4', 'user4@example.com', 'pwd4'),
('user5', 'user5@example.com', 'pwd5');

-- æ‰¹é‡æ’å…¥çš„æ€§èƒ½ä¼˜åŠ¿
-- æ–¹å¼1ï¼šå•æ¡æ’å…¥ï¼ˆæ…¢ï¼‰
INSERT INTO users (username, email, password) VALUES ('user1', 'email1', 'pwd1');
INSERT INTO users (username, email, password) VALUES ('user2', 'email2', 'pwd2');
-- ...éœ€è¦æ‰§è¡Œ1000æ¬¡

-- æ–¹å¼2ï¼šæ‰¹é‡æ’å…¥ï¼ˆå¿«ï¼‰
INSERT INTO users (username, email, password) VALUES
('user1', 'email1', 'pwd1'),
('user2', 'email2', 'pwd2'),
-- ...
('user1000', 'email1000', 'pwd1000');
-- åªéœ€è¦æ‰§è¡Œ1æ¬¡ï¼Œæ€§èƒ½æå‡10-100å€
```

### 2.3 INSERT IGNOREï¼ˆå¿½ç•¥é‡å¤ï¼‰

```sql
-- æ™®é€šINSERTï¼šé‡åˆ°é‡å¤ä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ä¼šæŠ¥é”™
INSERT INTO users (id, username, email, password)
VALUES (1, 'zhangsan', 'zhangsan@example.com', 'pwd');
-- ERROR: Duplicate entry '1' for key 'PRIMARY'

-- INSERT IGNOREï¼šé‡åˆ°é‡å¤åˆ™å¿½ç•¥ï¼Œä¸æŠ¥é”™
INSERT IGNORE INTO users (id, username, email, password)
VALUES (1, 'zhangsan', 'zhangsan@example.com', 'pwd');
-- Query OK, 0 rows affected (ä¸æ’å…¥ï¼Œä¸æŠ¥é”™)

-- æ‰¹é‡æ’å…¥æ—¶ä½¿ç”¨IGNORE
INSERT IGNORE INTO users (username, email, password) VALUES
('user1', 'user1@example.com', 'pwd1'),  -- å‡è®¾å·²å­˜åœ¨
('user2', 'user2@example.com', 'pwd2'),  -- æ–°ç”¨æˆ·
('user3', 'user3@example.com', 'pwd3');  -- æ–°ç”¨æˆ·
-- ç»“æœï¼šåªæ’å…¥user2å’Œuser3ï¼Œuser1è¢«å¿½ç•¥

-- åº”ç”¨åœºæ™¯ï¼šå¯¼å…¥æ•°æ®æ—¶é¿å…é‡å¤
INSERT IGNORE INTO tags (name) VALUES
('MySQL'),
('æ•°æ®åº“'),
('MySQL'),  -- é‡å¤ï¼Œå¿½ç•¥
('æ•™ç¨‹');
```

### 2.4 INSERT ... ON DUPLICATE KEY UPDATEï¼ˆæ’å…¥æˆ–æ›´æ–°ï¼‰

```sql
-- æ’å…¥ï¼Œå¦‚æœä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•å†²çªåˆ™æ›´æ–°
INSERT INTO users (id, username, email, password, nickname)
VALUES (1, 'zhangsan', 'zhangsan@example.com', 'new_pwd', 'æ–°æ˜µç§°')
ON DUPLICATE KEY UPDATE
    password = VALUES(password),
    nickname = VALUES(nickname),
    updated_at = NOW();

-- å¦‚æœid=1ä¸å­˜åœ¨ï¼Œæ’å…¥æ–°è®°å½•
-- å¦‚æœid=1å­˜åœ¨ï¼Œæ›´æ–°passwordå’Œnickname

-- å®æˆ˜ç¤ºä¾‹ï¼šç”¨æˆ·ç­¾åˆ°
CREATE TABLE user_sign_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    sign_date DATE NOT NULL,
    points INT UNSIGNED NOT NULL DEFAULT 1,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_user_date (user_id, sign_date)
) ENGINE=InnoDB;

-- ç­¾åˆ°ï¼šå¦‚æœä»Šå¤©å·²ç­¾åˆ°åˆ™å¢åŠ ç§¯åˆ†
INSERT INTO user_sign_logs (user_id, sign_date, points)
VALUES (1, CURDATE(), 1)
ON DUPLICATE KEY UPDATE
    points = points + 1;

-- å®æˆ˜ç¤ºä¾‹ï¼šç»Ÿè®¡å­—æ®µæ›´æ–°
CREATE TABLE articles (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    view_count INT UNSIGNED NOT NULL DEFAULT 0
) ENGINE=InnoDB;

-- å¢åŠ æµè§ˆé‡
INSERT INTO articles (id, view_count)
VALUES (1, 1)
ON DUPLICATE KEY UPDATE
    view_count = view_count + 1;
```

### 2.5 REPLACE INTOï¼ˆæ›¿æ¢æ’å…¥ï¼‰

```sql
-- REPLACEï¼šå¦‚æœå­˜åœ¨åˆ™åˆ é™¤åæ’å…¥ï¼Œä¸å­˜åœ¨åˆ™æ’å…¥
REPLACE INTO users (id, username, email, password)
VALUES (1, 'zhangsan', 'new@example.com', 'new_pwd');

-- ç­‰ä»·äº
DELETE FROM users WHERE id = 1;
INSERT INTO users (id, username, email, password) VALUES (1, 'zhangsan', 'new@example.com', 'new_pwd');

-- æ³¨æ„ï¼šREPLACEä¼šå¯¼è‡´è‡ªå¢IDè·³è·ƒ
REPLACE INTO users (id, username, email, password) VALUES (10, 'user10', 'email', 'pwd');
-- å®é™…æ‰§è¡Œï¼šDELETE id=10ï¼Œç„¶åINSERTï¼ˆå¯èƒ½å¯¼è‡´è‡ªå¢IDå˜æˆ11ï¼‰

-- ä¸€èˆ¬ä¸æ¨èä½¿ç”¨REPLACEï¼Œå»ºè®®ä½¿ç”¨INSERT ... ON DUPLICATE KEY UPDATE
```

### 2.6 INSERT INTO ... SELECTï¼ˆä»æŸ¥è¯¢ç»“æœæ’å…¥ï¼‰

```sql
-- ä»ä¸€å¼ è¡¨æ’å…¥åˆ°å¦ä¸€å¼ è¡¨
INSERT INTO users_backup (id, username, email, created_at)
SELECT id, username, email, created_at
FROM users
WHERE created_at < '2024-01-01';

-- å¤åˆ¶è¡¨ç»“æ„å’Œæ•°æ®
CREATE TABLE users_copy LIKE users;  -- å¤åˆ¶ç»“æ„
INSERT INTO users_copy SELECT * FROM users;  -- å¤åˆ¶æ•°æ®

-- å®æˆ˜ç¤ºä¾‹ï¼šæ•°æ®å½’æ¡£
CREATE TABLE orders_archive LIKE orders;

INSERT INTO orders_archive
SELECT * FROM orders
WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);

DELETE FROM orders
WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

---

## ä¸‰ã€SELECTï¼ˆæŸ¥è¯¢æ•°æ®ï¼‰

### 3.1 åŸºç¡€æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
SELECT * FROM users;

-- æŸ¥è¯¢æŒ‡å®šå­—æ®µï¼ˆæ¨èï¼‰
SELECT id, username, email, created_at FROM users;

-- å­—æ®µåˆ«å
SELECT
    id,
    username AS user_name,
    email AS user_email,
    created_at AS register_time
FROM users;

-- è®¡ç®—å­—æ®µ
SELECT
    id,
    username,
    price_cents,
    price_cents / 100 AS price_yuan,  -- åˆ†è½¬å…ƒ
    price_cents / 100.0 AS price_yuan_decimal
FROM products;

-- å¸¸é‡å­—æ®µ
SELECT
    id,
    username,
    'VIP' AS user_type,
    100 AS bonus_points
FROM users;
```

### 3.2 WHEREæ¡ä»¶ç­›é€‰

```sql
-- ç­‰å€¼æŸ¥è¯¢
SELECT * FROM users WHERE id = 1;
SELECT * FROM users WHERE username = 'zhangsan';

-- ä¸ç­‰æŸ¥è¯¢
SELECT * FROM users WHERE status != 1;
SELECT * FROM users WHERE status <> 1;  -- åŒä¸Š

-- èŒƒå›´æŸ¥è¯¢
SELECT * FROM products WHERE price_cents > 10000;
SELECT * FROM products WHERE price_cents >= 10000 AND price_cents <= 50000;
SELECT * FROM products WHERE price_cents BETWEEN 10000 AND 50000;  -- åŒä¸Š

-- å¤šå€¼æŸ¥è¯¢
SELECT * FROM users WHERE id IN (1, 2, 3, 4, 5);
SELECT * FROM users WHERE status IN (1, 2);

-- NULLå€¼æŸ¥è¯¢
SELECT * FROM users WHERE deleted_at IS NULL;  -- æœªåˆ é™¤
SELECT * FROM users WHERE deleted_at IS NOT NULL;  -- å·²åˆ é™¤

-- æ¨¡ç³ŠæŸ¥è¯¢
SELECT * FROM users WHERE username LIKE 'zhang%';  -- zhangå¼€å¤´
SELECT * FROM users WHERE username LIKE '%san';    -- sanç»“å°¾
SELECT * FROM users WHERE username LIKE '%ang%';   -- åŒ…å«ang

-- ç»„åˆæ¡ä»¶
SELECT * FROM users
WHERE status = 1
AND created_at > '2024-01-01'
AND (username LIKE 'zhang%' OR email LIKE '%@qq.com');
```

### 3.3 ORDER BYæ’åº

```sql
-- å•å­—æ®µæ’åº
SELECT * FROM users ORDER BY created_at;       -- å‡åºï¼ˆé»˜è®¤ï¼‰
SELECT * FROM users ORDER BY created_at ASC;   -- å‡åºï¼ˆæ˜¾å¼ï¼‰
SELECT * FROM users ORDER BY created_at DESC;  -- é™åº

-- å¤šå­—æ®µæ’åº
SELECT * FROM products
ORDER BY category_id ASC, price_cents DESC;
-- å…ˆæŒ‰åˆ†ç±»å‡åºï¼ŒåŒåˆ†ç±»å†…æŒ‰ä»·æ ¼é™åº

-- è¡¨è¾¾å¼æ’åº
SELECT * FROM products
ORDER BY (price_cents / 100.0) DESC;

-- NULLå€¼æ’åº
SELECT * FROM users ORDER BY deleted_at;  -- NULLåœ¨å‰
SELECT * FROM users ORDER BY deleted_at DESC;  -- NULLåœ¨å
```

### 3.4 LIMITåˆ†é¡µ

```sql
-- é™åˆ¶è¿”å›è¡Œæ•°
SELECT * FROM users LIMIT 10;  -- å‰10æ¡

-- åˆ†é¡µæŸ¥è¯¢
SELECT * FROM users LIMIT 0, 10;   -- ç¬¬1é¡µï¼Œæ¯é¡µ10æ¡
SELECT * FROM users LIMIT 10, 10;  -- ç¬¬2é¡µï¼Œæ¯é¡µ10æ¡
SELECT * FROM users LIMIT 20, 10;  -- ç¬¬3é¡µï¼Œæ¯é¡µ10æ¡

-- æ›´æ¸…æ™°çš„åˆ†é¡µè¯­æ³•ï¼ˆMySQL 8.0+ï¼‰
SELECT * FROM users LIMIT 10 OFFSET 0;   -- ç¬¬1é¡µ
SELECT * FROM users LIMIT 10 OFFSET 10;  -- ç¬¬2é¡µ
SELECT * FROM users LIMIT 10 OFFSET 20;  -- ç¬¬3é¡µ

-- åˆ†é¡µè®¡ç®—
-- page = 1, page_size = 10 â†’ LIMIT 0, 10
-- page = 2, page_size = 10 â†’ LIMIT 10, 10
-- page = n, page_size = m â†’ LIMIT (n-1)*m, m

-- å®æˆ˜åˆ†é¡µæŸ¥è¯¢
SET @page = 2;
SET @page_size = 20;
SELECT * FROM users
WHERE status = 1
ORDER BY created_at DESC
LIMIT @page_size OFFSET (@page - 1) * @page_size;
```

### 3.5 DISTINCTå»é‡

```sql
-- å»é‡æŸ¥è¯¢
SELECT DISTINCT city FROM users;

-- å¤šå­—æ®µå»é‡
SELECT DISTINCT city, age FROM users;
-- è¿”å›å”¯ä¸€çš„(city, age)ç»„åˆ

-- ç»Ÿè®¡ä¸é‡å¤å€¼çš„æ•°é‡
SELECT COUNT(DISTINCT city) AS city_count FROM users;
SELECT COUNT(DISTINCT email) AS user_count FROM users;
```

---

## å››ã€UPDATEï¼ˆæ›´æ–°æ•°æ®ï¼‰

### 4.1 åŸºç¡€æ›´æ–°

```sql
-- æ›´æ–°å•ä¸ªå­—æ®µ
UPDATE users SET nickname = 'æ–°æ˜µç§°' WHERE id = 1;

-- æ›´æ–°å¤šä¸ªå­—æ®µ
UPDATE users
SET
    nickname = 'æ–°æ˜µç§°',
    avatar = 'new_avatar.jpg',
    updated_at = NOW()
WHERE id = 1;

-- æ›´æ–°æ‰€æœ‰è¡Œï¼ˆå±é™©ï¼Œæ…ç”¨ï¼‰
UPDATE users SET status = 1;  -- æ²¡æœ‰WHEREæ¡ä»¶ï¼Œæ›´æ–°æ‰€æœ‰è¡Œ
```

### 4.2 æ¡ä»¶æ›´æ–°

```sql
-- å•æ¡ä»¶æ›´æ–°
UPDATE users SET status = 2 WHERE username = 'zhangsan';

-- å¤šæ¡ä»¶æ›´æ–°
UPDATE users
SET status = 2
WHERE created_at < '2024-01-01'
AND login_count = 0;

-- INæ¡ä»¶æ›´æ–°
UPDATE users SET status = 2 WHERE id IN (1, 2, 3, 4, 5);

-- æ‰¹é‡æ›´æ–°æŒ‡å®šè¡Œ
UPDATE users
SET status = 1
WHERE id IN (SELECT user_id FROM user_blacklist);
```

### 4.3 è¡¨è¾¾å¼æ›´æ–°

```sql
-- å­—æ®µè‡ªå¢
UPDATE articles SET view_count = view_count + 1 WHERE id = 1;

-- å­—æ®µè‡ªå‡
UPDATE products SET stock = stock - 1 WHERE id = 1;

-- å­—æ®µè®¡ç®—
UPDATE products
SET price_cents = price_cents * 0.8  -- 8æŠ˜
WHERE category_id = 1;

-- å­—ç¬¦ä¸²æ‹¼æ¥
UPDATE users
SET username = CONCAT(username, '_old')
WHERE created_at < '2020-01-01';

-- CASE WHENæ›´æ–°
UPDATE users
SET status = CASE
    WHEN login_count = 0 THEN 2  -- æœªç™»å½• â†’ ç¦ç”¨
    WHEN login_count > 100 THEN 3  -- æ´»è·ƒç”¨æˆ· â†’ VIP
    ELSE status
END;
```

### 4.4 å¤šè¡¨æ›´æ–°

```sql
-- æ ¹æ®å¦ä¸€å¼ è¡¨æ›´æ–°
UPDATE users u
JOIN user_profiles up ON u.id = up.user_id
SET u.nickname = up.nickname
WHERE up.updated_at > u.updated_at;

-- å®æˆ˜ç¤ºä¾‹ï¼šåŒæ­¥å†—ä½™å­—æ®µ
UPDATE articles a
JOIN users u ON a.author_id = u.id
SET a.author_username = u.username
WHERE u.updated_at > a.updated_at;
```

### 4.5 æ›´æ–°é™åˆ¶

```sql
-- é™åˆ¶æ›´æ–°è¡Œæ•°
UPDATE users SET status = 2 WHERE login_count = 0 LIMIT 100;

-- å®æˆ˜åœºæ™¯ï¼šåˆ†æ‰¹æ›´æ–°
-- æ›´æ–°100ä¸‡æ•°æ®ï¼Œåˆ†æ‰¹æ¬¡æ›´æ–°é¿å…é”è¡¨
SET @batch_size = 1000;
SET @affected_rows = @batch_size;

WHILE @affected_rows = @batch_size DO
    UPDATE users SET status = 2 WHERE status = 1 LIMIT @batch_size;
    SET @affected_rows = ROW_COUNT();
END WHILE;
```

---

## äº”ã€DELETEï¼ˆåˆ é™¤æ•°æ®ï¼‰

### 5.1 åŸºç¡€åˆ é™¤

```sql
-- åˆ é™¤å•æ¡è®°å½•
DELETE FROM users WHERE id = 1;

-- åˆ é™¤å¤šæ¡è®°å½•
DELETE FROM users WHERE status = 2;
DELETE FROM users WHERE id IN (1, 2, 3, 4, 5);

-- åˆ é™¤æ‰€æœ‰æ•°æ®ï¼ˆå±é™©ï¼ï¼‰
DELETE FROM users;  -- æ…ç”¨ï¼Œä¼šé€è¡Œåˆ é™¤ï¼Œæ…¢
```

### 5.2 æ¡ä»¶åˆ é™¤

```sql
-- å•æ¡ä»¶åˆ é™¤
DELETE FROM users WHERE username = 'zhangsan';

-- å¤šæ¡ä»¶åˆ é™¤
DELETE FROM users
WHERE status = 2
AND created_at < '2020-01-01'
AND login_count = 0;

-- å­æŸ¥è¯¢åˆ é™¤
DELETE FROM users
WHERE id IN (
    SELECT user_id FROM user_blacklist
);
```

### 5.3 é™åˆ¶åˆ é™¤

```sql
-- é™åˆ¶åˆ é™¤è¡Œæ•°
DELETE FROM users WHERE status = 2 LIMIT 100;

-- å®æˆ˜åœºæ™¯ï¼šåˆ†æ‰¹åˆ é™¤
SET @batch_size = 1000;
SET @affected_rows = @batch_size;

WHILE @affected_rows > 0 DO
    DELETE FROM logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 1 YEAR) LIMIT @batch_size;
    SET @affected_rows = ROW_COUNT();
END WHILE;
```

### 5.4 å¤šè¡¨åˆ é™¤

```sql
-- åˆ é™¤usersè¡¨å’Œuser_profilesè¡¨ä¸­çš„æ•°æ®
DELETE u, up
FROM users u
LEFT JOIN user_profiles up ON u.id = up.user_id
WHERE u.status = 2;
```

### 5.5 TRUNCATE vs DELETE

```sql
-- DELETEï¼šé€è¡Œåˆ é™¤ï¼Œå¯ä»¥å›æ»šï¼Œæ…¢
DELETE FROM users;

-- TRUNCATEï¼šç›´æ¥åˆ é™¤è¡¨ï¼Œé‡å»ºç©ºè¡¨ï¼Œå¿«ï¼Œä¸èƒ½å›æ»š
TRUNCATE TABLE users;
```

**DELETE vs TRUNCATEå¯¹æ¯”**ï¼š

| ç‰¹æ€§ | DELETE | TRUNCATE |
|------|--------|----------|
| é€Ÿåº¦ | æ…¢ï¼ˆé€è¡Œåˆ é™¤ï¼‰ | å¿«ï¼ˆç›´æ¥åˆ è¡¨é‡å»ºï¼‰ |
| WHEREæ¡ä»¶ | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| äº‹åŠ¡å›æ»š | âœ… å¯ä»¥ | âŒ ä¸å¯ä»¥ |
| è‡ªå¢ID | ä¸é‡ç½® | é‡ç½®ä¸ºåˆå§‹å€¼ |
| è§¦å‘å™¨ | âœ… è§¦å‘ | âŒ ä¸è§¦å‘ |
| è¿”å›åˆ é™¤è¡Œæ•° | âœ… è¿”å› | âŒ è¿”å›0 |

**ä½¿ç”¨å»ºè®®**ï¼š
- æ¸…ç©ºæ•´å¼ è¡¨ï¼šä½¿ç”¨TRUNCATEï¼ˆå¿«ï¼‰
- æŒ‰æ¡ä»¶åˆ é™¤ï¼šä½¿ç”¨DELETE
- éœ€è¦å›æ»šï¼šä½¿ç”¨DELETEï¼ˆåœ¨äº‹åŠ¡ä¸­ï¼‰

---

## å…­ã€è½¯åˆ é™¤å®ç°

### 6.1 è½¯åˆ é™¤è¡¨è®¾è®¡

```sql
CREATE TABLE users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,

    -- è½¯åˆ é™¤å­—æ®µ
    deleted_at DATETIME DEFAULT NULL COMMENT 'åˆ é™¤æ—¶é—´',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_username (username),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB;
```

### 6.2 è½¯åˆ é™¤æ“ä½œ

```sql
-- è½¯åˆ é™¤
UPDATE users SET deleted_at = NOW() WHERE id = 1;

-- æ‰¹é‡è½¯åˆ é™¤
UPDATE users SET deleted_at = NOW() WHERE status = 2;

-- æ¢å¤åˆ é™¤
UPDATE users SET deleted_at = NULL WHERE id = 1;
```

### 6.3 æŸ¥è¯¢æœªåˆ é™¤æ•°æ®

```sql
-- æ‰€æœ‰æŸ¥è¯¢éƒ½è¦åŠ deleted_at IS NULL
SELECT * FROM users WHERE deleted_at IS NULL;

SELECT * FROM users
WHERE deleted_at IS NULL
AND status = 1
ORDER BY created_at DESC;

-- åˆ›å»ºè§†å›¾ç®€åŒ–æŸ¥è¯¢
CREATE VIEW users_active AS
SELECT * FROM users WHERE deleted_at IS NULL;

-- ä½¿ç”¨è§†å›¾æŸ¥è¯¢
SELECT * FROM users_active WHERE status = 1;
```

### 6.4 ç‰©ç†åˆ é™¤ï¼ˆå®šæœŸæ¸…ç†ï¼‰

```sql
-- æ°¸ä¹…åˆ é™¤90å¤©å‰çš„è½¯åˆ é™¤æ•°æ®
DELETE FROM users
WHERE deleted_at IS NOT NULL
AND deleted_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

---

## ä¸ƒã€å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šç”¨æˆ·æ³¨å†Œ

```sql
-- 1. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
SELECT COUNT(*) FROM users WHERE username = 'zhangsan' AND deleted_at IS NULL;

-- 2. æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
SELECT COUNT(*) FROM users WHERE email = 'zhangsan@example.com' AND deleted_at IS NULL;

-- 3. æ’å…¥ç”¨æˆ·
INSERT INTO users (username, email, password, nickname, status)
VALUES ('zhangsan', 'zhangsan@example.com', 'hashed_password', 'å¼ ä¸‰', 1);

-- 4. è·å–æ–°ç”¨æˆ·ID
SELECT LAST_INSERT_ID();
```

### æ¡ˆä¾‹2ï¼šå•†å“åˆ—è¡¨æŸ¥è¯¢

```sql
-- æŸ¥è¯¢ä¸Šæ¶å•†å“ï¼ŒæŒ‰é”€é‡æ’åºï¼Œåˆ†é¡µ
SELECT
    id,
    name,
    price_cents / 100.0 AS price,
    stock,
    sales_count,
    created_at
FROM products
WHERE status = 1  -- ä¸Šæ¶
AND stock > 0     -- æœ‰åº“å­˜
AND deleted_at IS NULL
ORDER BY sales_count DESC
LIMIT 20 OFFSET 0;
```

### æ¡ˆä¾‹3ï¼šè®¢å•åˆ›å»º

```sql
BEGIN;

-- 1. æ’å…¥è®¢å•ä¸»è¡¨
INSERT INTO orders (order_no, user_id, username, total_amount, status)
VALUES ('ORDER001', 1, 'zhangsan', 10000, 1);

SET @order_id = LAST_INSERT_ID();

-- 2. æ’å…¥è®¢å•æ˜ç»†
INSERT INTO order_items (order_id, product_id, product_name, price_cents, quantity, subtotal)
VALUES
(@order_id, 1, 'iPhone 15', 599900, 1, 599900),
(@order_id, 2, 'AirPods', 129900, 1, 129900);

-- 3. æ‰£å‡åº“å­˜
UPDATE products SET stock = stock - 1 WHERE id = 1;
UPDATE products SET stock = stock - 1 WHERE id = 2;

COMMIT;
```

### æ¡ˆä¾‹4ï¼šæ–‡ç« æµè§ˆé‡æ›´æ–°

```sql
-- å¢åŠ æµè§ˆé‡
UPDATE articles SET view_count = view_count + 1 WHERE id = 1;

-- æˆ–ä½¿ç”¨INSERT ... ON DUPLICATE KEY UPDATE
INSERT INTO article_stats (article_id, view_count)
VALUES (1, 1)
ON DUPLICATE KEY UPDATE view_count = view_count + 1;
```

---

## å…«ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **CREATE TABLE**ï¼š
   - å®Œæ•´å®šä¹‰å­—æ®µã€çº¦æŸã€ç´¢å¼•
   - é€‰æ‹©åˆé€‚çš„å­˜å‚¨å¼•æ“å’Œå­—ç¬¦é›†
   - æ·»åŠ è¡¨æ³¨é‡Šå’Œå­—æ®µæ³¨é‡Š

2. **INSERT**ï¼š
   - æ‰¹é‡æ’å…¥æ€§èƒ½æœ€å¥½
   - INSERT IGNOREï¼šå¿½ç•¥é‡å¤
   - ON DUPLICATE KEY UPDATEï¼šæ’å…¥æˆ–æ›´æ–°

3. **SELECT**ï¼š
   - æŒ‡å®šå­—æ®µæŸ¥è¯¢ï¼ˆé¿å…SELECT *ï¼‰
   - WHEREæ¡ä»¶ç­›é€‰
   - ORDER BYæ’åº
   - LIMITåˆ†é¡µ

4. **UPDATE**ï¼š
   - å¿…é¡»å¸¦WHEREæ¡ä»¶ï¼ˆé¿å…è¯¯æ›´æ–°ï¼‰
   - è¡¨è¾¾å¼æ›´æ–°ï¼ˆè‡ªå¢ã€è‡ªå‡ï¼‰
   - é™åˆ¶æ›´æ–°è¡Œæ•°ï¼ˆåˆ†æ‰¹æ›´æ–°ï¼‰

5. **DELETE**ï¼š
   - å¿…é¡»å¸¦WHEREæ¡ä»¶ï¼ˆé¿å…è¯¯åˆ é™¤ï¼‰
   - TRUNCATEæ¸…ç©ºè¡¨ï¼ˆå¿«ï¼‰
   - è½¯åˆ é™¤ï¼ˆæ¨èï¼‰

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… åˆ›å»ºè§„èŒƒçš„æ•°æ®åº“è¡¨
- âœ… ç†Ÿç»ƒè¿›è¡Œå•è¡¨CRUDæ“ä½œ
- âœ… ç†è§£è½¯åˆ é™¤çš„å®ç°
- âœ… é¿å…å¸¸è§çš„CRUDé”™è¯¯

ä¸‹ä¸€èŠ‚ï¼š[07-WHEREæ¡ä»¶æŸ¥è¯¢](./07-WHEREæ¡ä»¶æŸ¥è¯¢.md)
