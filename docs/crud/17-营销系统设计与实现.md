# 17-è¥é”€ç³»ç»Ÿè®¾è®¡ä¸å®ç°

> ä»é›¶è®¾è®¡å¹¶å®ç°è¥é”€ç³»ç»Ÿï¼ˆä¼˜æƒ åˆ¸ã€ç§¯åˆ†ã€ç­¾åˆ°ã€é‚€è¯·ï¼‰

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- è®¾è®¡ä¼˜æƒ åˆ¸ç³»ç»Ÿ
- è®¾è®¡ç§¯åˆ†ç³»ç»Ÿ
- è®¾è®¡ç­¾åˆ°ç³»ç»Ÿ
- è®¾è®¡é‚€è¯·å¥–åŠ±ç³»ç»Ÿ
- å®ç°è¥é”€æ´»åŠ¨ç»Ÿè®¡

---

## ä¸€ã€ä¼˜æƒ åˆ¸ç³»ç»Ÿ

### 1.1 ä¼˜æƒ åˆ¸è¡¨è®¾è®¡

```sql
-- ä¼˜æƒ åˆ¸å®šä¹‰è¡¨
CREATE TABLE coupons (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- åŸºæœ¬ä¿¡æ¯
    name VARCHAR(100) NOT NULL COMMENT 'ä¼˜æƒ åˆ¸åç§°',
    description VARCHAR(255) NOT NULL DEFAULT '' COMMENT 'æè¿°',

    -- ç±»å‹
    type TINYINT UNSIGNED NOT NULL COMMENT 'ç±»å‹ï¼š1-æ»¡å‡åˆ¸ï¼Œ2-æŠ˜æ‰£åˆ¸ï¼Œ3-ä»£é‡‘åˆ¸',

    -- ä¼˜æƒ è§„åˆ™ï¼ˆå•ä½ï¼šåˆ†ï¼‰
    min_amount BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æœ€ä½æ¶ˆè´¹é‡‘é¢',
    discount_amount BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ä¼˜æƒ é‡‘é¢ï¼ˆæ»¡å‡åˆ¸ã€ä»£é‡‘åˆ¸ï¼‰',
    discount_rate DECIMAL(5, 2) NOT NULL DEFAULT 0 COMMENT 'æŠ˜æ‰£ç‡ï¼ˆæŠ˜æ‰£åˆ¸ï¼Œä¾‹å¦‚0.8è¡¨ç¤º8æŠ˜ï¼‰',
    max_discount_amount BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æœ€å¤§ä¼˜æƒ é‡‘é¢ï¼ˆæŠ˜æ‰£åˆ¸ï¼‰',

    -- å‘æ”¾è§„åˆ™
    total_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å‘è¡Œæ€»é‡ï¼ˆ0è¡¨ç¤ºä¸é™ï¼‰',
    received_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å·²é¢†å–æ•°é‡',
    user_limit INT UNSIGNED NOT NULL DEFAULT 1 COMMENT 'æ¯äººé™é¢†æ•°é‡',

    -- ä½¿ç”¨è§„åˆ™
    valid_days INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æœ‰æ•ˆå¤©æ•°ï¼ˆ0è¡¨ç¤ºä½¿ç”¨å›ºå®šæ—¥æœŸï¼‰',
    start_at DATETIME DEFAULT NULL COMMENT 'æœ‰æ•ˆæœŸå¼€å§‹æ—¶é—´',
    end_at DATETIME DEFAULT NULL COMMENT 'æœ‰æ•ˆæœŸç»“æŸæ—¶é—´',

    -- çŠ¶æ€
    status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æœªå¼€å§‹ï¼Œ2-è¿›è¡Œä¸­ï¼Œ3-å·²ç»“æŸ',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_status (status),
    INDEX idx_start_end (start_at, end_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ä¼˜æƒ åˆ¸å®šä¹‰è¡¨';

-- ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE user_coupons (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    coupon_id BIGINT UNSIGNED NOT NULL COMMENT 'ä¼˜æƒ åˆ¸ID',
    user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',

    -- çŠ¶æ€
    status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æœªä½¿ç”¨ï¼Œ2-å·²ä½¿ç”¨ï¼Œ3-å·²è¿‡æœŸ',

    -- ä½¿ç”¨ä¿¡æ¯
    used_order_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'ä½¿ç”¨çš„è®¢å•ID',
    used_at DATETIME DEFAULT NULL COMMENT 'ä½¿ç”¨æ—¶é—´',

    -- æœ‰æ•ˆæœŸ
    start_at DATETIME NOT NULL COMMENT 'æœ‰æ•ˆæœŸå¼€å§‹',
    end_at DATETIME NOT NULL COMMENT 'æœ‰æ•ˆæœŸç»“æŸ',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id_status (user_id, status),
    INDEX idx_coupon_id (coupon_id),
    INDEX idx_end_at (end_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨';
```

### 1.2 é¢†å–ä¼˜æƒ åˆ¸

```sql
BEGIN;

-- 1. æ£€æŸ¥ä¼˜æƒ åˆ¸æ˜¯å¦å¯é¢†å–
SELECT
    id,
    total_count,
    received_count,
    user_limit,
    status
FROM coupons
WHERE id = :coupon_id
AND status = 2  -- è¿›è¡Œä¸­
FOR UPDATE;

-- 2. æ£€æŸ¥åº“å­˜
IF total_count > 0 AND received_count >= total_count THEN
    ROLLBACK;
    RAISE ERROR 'ä¼˜æƒ åˆ¸å·²æŠ¢å®Œ';
END IF;

-- 3. æ£€æŸ¥ç”¨æˆ·é¢†å–æ¬¡æ•°
SELECT COUNT(*) AS received
FROM user_coupons
WHERE coupon_id = :coupon_id
AND user_id = :user_id;

IF received >= user_limit THEN
    ROLLBACK;
    RAISE ERROR 'å·²è¾¾åˆ°é¢†å–ä¸Šé™';
END IF;

-- 4. è®¡ç®—æœ‰æ•ˆæœŸ
SELECT
    CASE
        WHEN valid_days > 0 THEN DATE_ADD(NOW(), INTERVAL valid_days DAY)
        ELSE end_at
    END AS end_at,
    CASE
        WHEN valid_days > 0 THEN NOW()
        ELSE start_at
    END AS start_at
FROM coupons
WHERE id = :coupon_id;

-- 5. å‘æ”¾ä¼˜æƒ åˆ¸
INSERT INTO user_coupons (
    coupon_id,
    user_id,
    status,
    start_at,
    end_at
) VALUES (
    :coupon_id,
    :user_id,
    1,
    :start_at,
    :end_at
);

-- 6. æ›´æ–°å·²é¢†å–æ•°é‡
UPDATE coupons
SET received_count = received_count + 1
WHERE id = :coupon_id;

COMMIT;
```

### 1.3 ä½¿ç”¨ä¼˜æƒ åˆ¸

```sql
-- æŸ¥è¯¢å¯ç”¨ä¼˜æƒ åˆ¸
SELECT
    uc.id,
    c.name,
    c.type,
    c.min_amount / 100 AS min_amount,
    c.discount_amount / 100 AS discount_amount,
    c.discount_rate,
    uc.start_at,
    uc.end_at
FROM user_coupons uc
JOIN coupons c ON uc.coupon_id = c.id
WHERE uc.user_id = :user_id
AND uc.status = 1  -- æœªä½¿ç”¨
AND uc.start_at <= NOW()
AND uc.end_at >= NOW()
AND c.min_amount <= :order_amount  -- æ»¡è¶³æœ€ä½æ¶ˆè´¹
ORDER BY c.discount_amount DESC;

-- ä½¿ç”¨ä¼˜æƒ åˆ¸ï¼ˆä¸‹å•æ—¶ï¼‰
UPDATE user_coupons
SET
    status = 2,  -- å·²ä½¿ç”¨
    used_order_id = :order_id,
    used_at = NOW()
WHERE id = :user_coupon_id
AND user_id = :user_id
AND status = 1;

-- è®¡ç®—ä¼˜æƒ é‡‘é¢
-- æ»¡å‡åˆ¸
discount = discount_amount

-- æŠ˜æ‰£åˆ¸
discount = MIN(order_amount * (1 - discount_rate), max_discount_amount)

-- ä»£é‡‘åˆ¸
discount = discount_amount
```

### 1.4 ä¼˜æƒ åˆ¸è¿‡æœŸå¤„ç†

```sql
-- å®šæ—¶ä»»åŠ¡ï¼šå°†è¿‡æœŸä¼˜æƒ åˆ¸æ ‡è®°ä¸ºå·²è¿‡æœŸ
UPDATE user_coupons
SET status = 3  -- å·²è¿‡æœŸ
WHERE status = 1
AND end_at < NOW()
LIMIT 1000;
```

---

## äºŒã€ç§¯åˆ†ç³»ç»Ÿ

### 2.1 ç§¯åˆ†è¡¨è®¾è®¡

```sql
-- ç”¨æˆ·ç§¯åˆ†è¡¨
CREATE TABLE user_points (
    user_id BIGINT UNSIGNED PRIMARY KEY,
    total_points INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æ€»ç§¯åˆ†',
    available_points INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å¯ç”¨ç§¯åˆ†',
    used_points INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å·²ä½¿ç”¨ç§¯åˆ†',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_available_points (available_points)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ç§¯åˆ†è¡¨';

-- ç§¯åˆ†æ˜ç»†è¡¨
CREATE TABLE point_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,

    -- ç§¯åˆ†å˜åŠ¨
    points INT NOT NULL COMMENT 'ç§¯åˆ†å˜åŠ¨ï¼ˆæ­£æ•°ä¸ºå¢åŠ ï¼Œè´Ÿæ•°ä¸ºå‡å°‘ï¼‰',
    balance INT UNSIGNED NOT NULL COMMENT 'å˜åŠ¨åä½™é¢',

    -- æ¥æº
    type TINYINT UNSIGNED NOT NULL COMMENT 'ç±»å‹ï¼š1-ç­¾åˆ°ï¼Œ2-æ¶ˆè´¹ï¼Œ3-é€€æ¬¾ï¼Œ4-å…‘æ¢ï¼Œ5-è¿‡æœŸ',
    source_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æ¥æºIDï¼ˆè®¢å•IDç­‰ï¼‰',
    description VARCHAR(255) NOT NULL DEFAULT '' COMMENT 'æè¿°',

    -- è¿‡æœŸæ—¶é—´
    expired_at DATETIME DEFAULT NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ˆNULLè¡¨ç¤ºä¸è¿‡æœŸï¼‰',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_expired_at (expired_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç§¯åˆ†æ˜ç»†è¡¨';
```

### 2.2 å¢åŠ ç§¯åˆ†

```sql
BEGIN;

-- 1. æ›´æ–°ç”¨æˆ·ç§¯åˆ†
INSERT INTO user_points (user_id, total_points, available_points)
VALUES (:user_id, :points, :points)
ON DUPLICATE KEY UPDATE
    total_points = total_points + :points,
    available_points = available_points + :points;

-- 2. è®°å½•ç§¯åˆ†æ˜ç»†
INSERT INTO point_logs (
    user_id,
    points,
    balance,
    type,
    source_id,
    description,
    expired_at
) VALUES (
    :user_id,
    :points,
    (SELECT available_points FROM user_points WHERE user_id = :user_id),
    :type,
    :source_id,
    :description,
    :expired_at  -- ä¾‹å¦‚ï¼šDATE_ADD(NOW(), INTERVAL 1 YEAR)
);

COMMIT;
```

### 2.3 ä½¿ç”¨ç§¯åˆ†

```sql
BEGIN;

-- 1. æ£€æŸ¥ç§¯åˆ†ä½™é¢
SELECT available_points
FROM user_points
WHERE user_id = :user_id
FOR UPDATE;

IF available_points < :points THEN
    ROLLBACK;
    RAISE ERROR 'ç§¯åˆ†ä¸è¶³';
END IF;

-- 2. æ‰£å‡ç§¯åˆ†
UPDATE user_points
SET
    available_points = available_points - :points,
    used_points = used_points + :points
WHERE user_id = :user_id;

-- 3. è®°å½•æ˜ç»†
INSERT INTO point_logs (
    user_id,
    points,
    balance,
    type,
    source_id,
    description
) VALUES (
    :user_id,
    -:points,
    (SELECT available_points FROM user_points WHERE user_id = :user_id),
    4,  -- å…‘æ¢
    :order_id,
    'ç§¯åˆ†å…‘æ¢'
);

COMMIT;
```

### 2.4 ç§¯åˆ†è¿‡æœŸå¤„ç†

```sql
-- å®šæ—¶ä»»åŠ¡ï¼šå¤„ç†è¿‡æœŸç§¯åˆ†
BEGIN;

-- 1. æŸ¥æ‰¾å³å°†è¿‡æœŸçš„ç§¯åˆ†
SELECT
    user_id,
    SUM(points) AS expired_points
FROM point_logs
WHERE expired_at <= NOW()
AND expired_at IS NOT NULL
AND points > 0  -- åªå¤„ç†å¢åŠ çš„ç§¯åˆ†
GROUP BY user_id;

-- 2. æ‰£å‡è¿‡æœŸç§¯åˆ†
UPDATE user_points up
JOIN (
    SELECT
        user_id,
        SUM(points) AS expired_points
    FROM point_logs
    WHERE expired_at <= NOW()
    AND expired_at IS NOT NULL
    AND points > 0
    GROUP BY user_id
) AS t ON up.user_id = t.user_id
SET up.available_points = up.available_points - t.expired_points;

-- 3. è®°å½•è¿‡æœŸæ˜ç»†
INSERT INTO point_logs (user_id, points, balance, type, description)
SELECT
    user_id,
    -SUM(points),
    (SELECT available_points FROM user_points WHERE user_id = pl.user_id),
    5,  -- è¿‡æœŸ
    'ç§¯åˆ†è¿‡æœŸ'
FROM point_logs pl
WHERE expired_at <= NOW()
AND expired_at IS NOT NULL
AND points > 0
GROUP BY user_id;

-- 4. åˆ é™¤å·²å¤„ç†çš„æ˜ç»†ï¼ˆå¯é€‰ï¼‰
DELETE FROM point_logs
WHERE expired_at <= NOW()
AND expired_at IS NOT NULL
AND points > 0;

COMMIT;
```

---

## ä¸‰ã€ç­¾åˆ°ç³»ç»Ÿ

### 3.1 ç­¾åˆ°è¡¨è®¾è®¡

```sql
CREATE TABLE user_sign_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    sign_date DATE NOT NULL COMMENT 'ç­¾åˆ°æ—¥æœŸ',

    -- å¥–åŠ±
    points INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'è·å¾—ç§¯åˆ†',
    consecutive_days INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'è¿ç»­ç­¾åˆ°å¤©æ•°',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_user_date (user_id, sign_date),
    INDEX idx_sign_date (sign_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·ç­¾åˆ°è®°å½•è¡¨';
```

### 3.2 ç­¾åˆ°åŠŸèƒ½

```sql
BEGIN;

-- 1. æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç­¾åˆ°
SELECT COUNT(*) AS signed
FROM user_sign_logs
WHERE user_id = :user_id
AND sign_date = CURDATE();

IF signed > 0 THEN
    ROLLBACK;
    RAISE ERROR 'ä»Šæ—¥å·²ç­¾åˆ°';
END IF;

-- 2. è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
SELECT IFNULL(consecutive_days, 0) AS last_consecutive_days
FROM user_sign_logs
WHERE user_id = :user_id
AND sign_date = DATE_SUB(CURDATE(), INTERVAL 1 DAY);

-- å¦‚æœæ˜¨å¤©ç­¾åˆ°äº†ï¼Œè¿ç»­å¤©æ•°+1ï¼Œå¦åˆ™ä»1å¼€å§‹
SET @consecutive_days = IF(last_consecutive_days IS NOT NULL, last_consecutive_days + 1, 1);

-- 3. è®¡ç®—å¥–åŠ±ç§¯åˆ†ï¼ˆä¾‹å¦‚ï¼šè¿ç»­ç­¾åˆ°ç¬¬7å¤©å¥–åŠ±10ç§¯åˆ†ï¼‰
SET @points = CASE
    WHEN @consecutive_days >= 7 THEN 10
    WHEN @consecutive_days >= 3 THEN 5
    ELSE 2
END;

-- 4. è®°å½•ç­¾åˆ°
INSERT INTO user_sign_logs (
    user_id,
    sign_date,
    points,
    consecutive_days
) VALUES (
    :user_id,
    CURDATE(),
    @points,
    @consecutive_days
);

-- 5. å¢åŠ ç§¯åˆ†
INSERT INTO user_points (user_id, total_points, available_points)
VALUES (:user_id, @points, @points)
ON DUPLICATE KEY UPDATE
    total_points = total_points + @points,
    available_points = available_points + @points;

INSERT INTO point_logs (
    user_id,
    points,
    balance,
    type,
    description
) VALUES (
    :user_id,
    @points,
    (SELECT available_points FROM user_points WHERE user_id = :user_id),
    1,  -- ç­¾åˆ°
    CONCAT('ç­¾åˆ°å¥–åŠ±ï¼ˆè¿ç»­', @consecutive_days, 'å¤©ï¼‰')
);

COMMIT;
```

### 3.3 ç­¾åˆ°ç»Ÿè®¡

```sql
-- æŸ¥è¯¢ç”¨æˆ·ç­¾åˆ°è®°å½•ï¼ˆæœ€è¿‘30å¤©ï¼‰
SELECT
    sign_date,
    points,
    consecutive_days
FROM user_sign_logs
WHERE user_id = :user_id
AND sign_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
ORDER BY sign_date DESC;

-- æŸ¥è¯¢æœ¬æœˆç­¾åˆ°å¤©æ•°
SELECT COUNT(*) AS sign_days
FROM user_sign_logs
WHERE user_id = :user_id
AND DATE_FORMAT(sign_date, '%Y-%m') = DATE_FORMAT(CURDATE(), '%Y-%m');

-- æŸ¥è¯¢å½“å‰è¿ç»­ç­¾åˆ°å¤©æ•°
SELECT consecutive_days
FROM user_sign_logs
WHERE user_id = :user_id
AND sign_date = CURDATE();
```

---

## å››ã€é‚€è¯·å¥–åŠ±ç³»ç»Ÿ

### 4.1 é‚€è¯·å…³ç³»è¡¨

```sql
CREATE TABLE user_invitations (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    inviter_id BIGINT UNSIGNED NOT NULL COMMENT 'é‚€è¯·äººID',
    invitee_id BIGINT UNSIGNED NOT NULL COMMENT 'è¢«é‚€è¯·äººID',

    -- å¥–åŠ±çŠ¶æ€
    reward_status TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å¥–åŠ±çŠ¶æ€ï¼š0-æœªå‘æ”¾ï¼Œ1-å·²å‘æ”¾',
    reward_points INT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å¥–åŠ±ç§¯åˆ†',
    rewarded_at DATETIME DEFAULT NULL COMMENT 'å¥–åŠ±å‘æ”¾æ—¶é—´',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_inviter_id (inviter_id),
    UNIQUE KEY uniq_invitee_id (invitee_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·é‚€è¯·å…³ç³»è¡¨';

-- é‚€è¯·ç è¡¨
CREATE TABLE invitation_codes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    code VARCHAR(20) NOT NULL COMMENT 'é‚€è¯·ç ',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_code (code),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é‚€è¯·ç è¡¨';
```

### 4.2 ç”Ÿæˆé‚€è¯·ç 

```python
import random
import string

def generate_invitation_code(user_id):
    """ç”Ÿæˆé‚€è¯·ç """
    # æ–¹å¼1ï¼šåŸºäºuser_id
    code = f"{user_id:08d}"  # ä¾‹å¦‚ï¼š00000001

    # æ–¹å¼2ï¼šéšæœºå­—ç¬¦ä¸²
    code = ''.join(random.choices(string.ascii_uppercase + string.digits, k=8))

    # æ’å…¥é‚€è¯·ç 
    sql = """
        INSERT INTO invitation_codes (user_id, code)
        VALUES (%s, %s)
    """
    db.execute(sql, (user_id, code))

    return code
```

### 4.3 æ³¨å†Œæ—¶ç»‘å®šé‚€è¯·å…³ç³»

```sql
-- æ³¨å†Œæ—¶ï¼Œæ ¹æ®é‚€è¯·ç ç»‘å®šé‚€è¯·å…³ç³»
BEGIN;

-- 1. æŸ¥è¯¢é‚€è¯·äºº
SELECT user_id AS inviter_id
FROM invitation_codes
WHERE code = :invitation_code;

IF inviter_id IS NULL THEN
    ROLLBACK;
    RAISE ERROR 'é‚€è¯·ç æ— æ•ˆ';
END IF;

-- 2. æ³¨å†Œç”¨æˆ·
INSERT INTO users (username, email, password)
VALUES (:username, :email, :password);

SET @invitee_id = LAST_INSERT_ID();

-- 3. è®°å½•é‚€è¯·å…³ç³»
INSERT INTO user_invitations (
    inviter_id,
    invitee_id,
    reward_status
) VALUES (
    inviter_id,
    @invitee_id,
    0  -- æœªå‘æ”¾å¥–åŠ±
);

COMMIT;
```

### 4.4 å‘æ”¾é‚€è¯·å¥–åŠ±

```sql
-- è¢«é‚€è¯·äººé¦–æ¬¡æ¶ˆè´¹åï¼Œå‘æ”¾é‚€è¯·å¥–åŠ±
BEGIN;

-- 1. æŸ¥è¯¢é‚€è¯·å…³ç³»
SELECT
    inviter_id,
    invitee_id,
    reward_status
FROM user_invitations
WHERE invitee_id = :invitee_id
AND reward_status = 0  -- æœªå‘æ”¾
FOR UPDATE;

-- 2. å‘æ”¾å¥–åŠ±ç§¯åˆ†ç»™é‚€è¯·äºº
INSERT INTO user_points (user_id, total_points, available_points)
VALUES (inviter_id, 100, 100)  -- é‚€è¯·å¥–åŠ±100ç§¯åˆ†
ON DUPLICATE KEY UPDATE
    total_points = total_points + 100,
    available_points = available_points + 100;

INSERT INTO point_logs (
    user_id,
    points,
    balance,
    type,
    source_id,
    description
) VALUES (
    inviter_id,
    100,
    (SELECT available_points FROM user_points WHERE user_id = inviter_id),
    6,  -- é‚€è¯·å¥–åŠ±
    :invitee_id,
    'é‚€è¯·å¥½å‹å¥–åŠ±'
);

-- 3. æ›´æ–°é‚€è¯·å…³ç³»
UPDATE user_invitations
SET
    reward_status = 1,
    reward_points = 100,
    rewarded_at = NOW()
WHERE invitee_id = :invitee_id;

COMMIT;
```

---

## äº”ã€è¥é”€æ´»åŠ¨ç»Ÿè®¡

### 5.1 ä¼˜æƒ åˆ¸ç»Ÿè®¡

```sql
-- ä¼˜æƒ åˆ¸ä½¿ç”¨ç»Ÿè®¡
SELECT
    c.id,
    c.name,
    c.total_count,
    c.received_count,
    COUNT(CASE WHEN uc.status = 2 THEN 1 END) AS used_count,
    COUNT(CASE WHEN uc.status = 1 THEN 1 END) AS unused_count,
    COUNT(CASE WHEN uc.status = 3 THEN 1 END) AS expired_count,
    ROUND(COUNT(CASE WHEN uc.status = 2 THEN 1 END) * 100.0 / NULLIF(c.received_count, 0), 2) AS usage_rate
FROM coupons c
LEFT JOIN user_coupons uc ON c.id = uc.coupon_id
GROUP BY c.id, c.name, c.total_count, c.received_count;

-- ä¼˜æƒ åˆ¸ä½¿ç”¨æ˜ç»†
SELECT
    o.order_no,
    u.username,
    c.name AS coupon_name,
    uc.used_at,
    o.total_amount / 100 AS order_amount,
    o.discount_amount / 100 AS discount_amount
FROM user_coupons uc
JOIN coupons c ON uc.coupon_id = c.id
JOIN users u ON uc.user_id = u.id
JOIN orders o ON uc.used_order_id = o.id
WHERE uc.status = 2
ORDER BY uc.used_at DESC
LIMIT 100;
```

### 5.2 ç§¯åˆ†ç»Ÿè®¡

```sql
-- ç§¯åˆ†å‘æ”¾å’Œæ¶ˆè€—ç»Ÿè®¡
SELECT
    type,
    CASE type
        WHEN 1 THEN 'ç­¾åˆ°'
        WHEN 2 THEN 'æ¶ˆè´¹'
        WHEN 3 THEN 'é€€æ¬¾'
        WHEN 4 THEN 'å…‘æ¢'
        WHEN 5 THEN 'è¿‡æœŸ'
    END AS type_name,
    COUNT(*) AS count,
    SUM(CASE WHEN points > 0 THEN points ELSE 0 END) AS total_earned,
    SUM(CASE WHEN points < 0 THEN -points ELSE 0 END) AS total_spent
FROM point_logs
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY type
ORDER BY type;

-- ç”¨æˆ·ç§¯åˆ†æ’è¡Œ
SELECT
    u.id,
    u.username,
    up.total_points,
    up.available_points
FROM user_points up
JOIN users u ON up.user_id = u.id
ORDER BY up.total_points DESC
LIMIT 100;
```

### 5.3 é‚€è¯·ç»Ÿè®¡

```sql
-- é‚€è¯·æ’è¡Œ
SELECT
    u.id,
    u.username,
    COUNT(ui.id) AS invitation_count,
    SUM(CASE WHEN ui.reward_status = 1 THEN 1 ELSE 0 END) AS rewarded_count
FROM users u
LEFT JOIN user_invitations ui ON u.id = ui.inviter_id
GROUP BY u.id, u.username
HAVING invitation_count > 0
ORDER BY invitation_count DESC
LIMIT 100;

-- é‚€è¯·è½¬åŒ–ç‡
SELECT
    COUNT(*) AS total_invitations,
    SUM(CASE WHEN reward_status = 1 THEN 1 ELSE 0 END) AS converted_count,
    ROUND(SUM(CASE WHEN reward_status = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*), 2) AS conversion_rate
FROM user_invitations;
```

---

## å…­ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ä¼˜æƒ åˆ¸ç³»ç»Ÿ**ï¼š
   - ä¼˜æƒ åˆ¸å®šä¹‰å’Œå‘æ”¾
   - åº“å­˜æ§åˆ¶
   - ä½¿ç”¨è§„åˆ™éªŒè¯
   - è¿‡æœŸå¤„ç†

2. **ç§¯åˆ†ç³»ç»Ÿ**ï¼š
   - ç§¯åˆ†å¢åŠ /æ‰£å‡
   - ç§¯åˆ†æ˜ç»†è®°å½•
   - ç§¯åˆ†è¿‡æœŸæœºåˆ¶

3. **ç­¾åˆ°ç³»ç»Ÿ**ï¼š
   - è¿ç»­ç­¾åˆ°ç»Ÿè®¡
   - é˜¶æ¢¯å¥–åŠ±
   - ç­¾åˆ°è®°å½•æŸ¥è¯¢

4. **é‚€è¯·ç³»ç»Ÿ**ï¼š
   - é‚€è¯·ç ç”Ÿæˆ
   - é‚€è¯·å…³ç³»ç»‘å®š
   - å¥–åŠ±å‘æ”¾

5. **è¥é”€ç»Ÿè®¡**ï¼š
   - ä¼˜æƒ åˆ¸ä½¿ç”¨åˆ†æ
   - ç§¯åˆ†æµæ°´ç»Ÿè®¡
   - é‚€è¯·æ•ˆæœè¯„ä¼°

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… è®¾è®¡å®Œæ•´çš„ä¼˜æƒ åˆ¸ç³»ç»Ÿ
- âœ… å®ç°ç§¯åˆ†å¢å‡å’Œè¿‡æœŸ
- âœ… å®ç°ç­¾åˆ°å¥–åŠ±æœºåˆ¶
- âœ… å®ç°é‚€è¯·å¥–åŠ±åŠŸèƒ½
- âœ… è¿›è¡Œè¥é”€æ•°æ®åˆ†æ

ä¸‹ä¸€èŠ‚ï¼š[18-æ•°æ®åˆ†ææŸ¥è¯¢](./18-æ•°æ®åˆ†ææŸ¥è¯¢.md)
