# 13-å¸¸è§ä¸šåŠ¡æŸ¥è¯¢æ¨¡å¼

> æŒæ¡å®é™…ä¸šåŠ¡å¼€å‘ä¸­çš„å¸¸ç”¨æŸ¥è¯¢æ¨¡å¼å’Œæœ€ä½³å®è·µ

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- æŒæ¡åˆ†é¡µæŸ¥è¯¢çš„å„ç§æ¨¡å¼
- æŒæ¡æœç´¢æŸ¥è¯¢çš„å®ç°æ–¹å¼
- æŒæ¡ç»Ÿè®¡æŸ¥è¯¢çš„å¸¸ç”¨åœºæ™¯
- æŒæ¡æ’è¡Œæ¦œæŸ¥è¯¢
- æŒæ¡æ—¶é—´åºåˆ—æŸ¥è¯¢
- æŒæ¡æ•°æ®å¯¼å‡ºæŸ¥è¯¢

---

## ä¸€ã€åˆ†é¡µæŸ¥è¯¢æ¨¡ï¿½ï¿½

### 1.1 åŸºç¡€åˆ†é¡µ

```sql
-- æ ‡å‡†åˆ†é¡µæŸ¥è¯¢
SELECT
    id,
    title,
    author_username,
    view_count,
    created_at
FROM articles
WHERE status = 2
AND deleted_at IS NULL
ORDER BY created_at DESC
LIMIT 20 OFFSET 0;

-- åˆ†é¡µå‚æ•°è®¡ç®—
-- page = 1 â†’ OFFSET = 0
-- page = 2 â†’ OFFSET = 20
-- page = n â†’ OFFSET = (n-1) * page_size

-- æ€»æ•°æŸ¥è¯¢
SELECT COUNT(*) AS total
FROM articles
WHERE status = 2
AND deleted_at IS NULL;

-- æ€»é¡µæ•° = CEIL(total / page_size)
```

### 1.2 æ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰

```sql
-- ç¬¬ä¸€é¡µ
SELECT
    id,
    title,
    created_at
FROM articles
WHERE status = 2
AND deleted_at IS NULL
ORDER BY id DESC
LIMIT 20;
-- è¿”å›ï¼šidèŒƒå›´ 10000~9981

-- ç¬¬äºŒé¡µï¼ˆä½¿ç”¨ä¸Šä¸€é¡µçš„æœ€å°idï¼‰
SELECT
    id,
    title,
    created_at
FROM articles
WHERE status = 2
AND deleted_at IS NULL
AND id < 9981  -- ä¸Šä¸€é¡µçš„æœ€å°id
ORDER BY id DESC
LIMIT 20;

-- ä¼˜ç‚¹ï¼š
-- 1. æ€§èƒ½ç¨³å®šï¼ˆä¸å—é¡µæ•°å½±å“ï¼‰
-- 2. é€‚åˆæ— é™æ»šåŠ¨
-- 3. é¿å…æ·±åˆ†é¡µé—®é¢˜

-- ç¼ºç‚¹ï¼š
-- 1. ä¸èƒ½è·³é¡µ
-- 2. åªèƒ½é¡ºåºç¿»é¡µ
```

### 1.3 å¤æ‚æ’åºåˆ†é¡µ

```sql
-- æŒ‰å¤šä¸ªå­—æ®µæ’åºæ—¶çš„æ¸¸æ ‡åˆ†é¡µ
SELECT
    id,
    title,
    view_count,
    created_at
FROM articles
WHERE status = 2
AND deleted_at IS NULL
AND (
    view_count < :last_view_count
    OR (view_count = :last_view_count AND id < :last_id)
)
ORDER BY view_count DESC, id DESC
LIMIT 20;

-- è¯´æ˜ï¼š
-- :last_view_count å’Œ :last_id æ˜¯ä¸Šä¸€é¡µæœ€åä¸€æ¡è®°å½•çš„å€¼
```

---

## äºŒã€æœç´¢æŸ¥è¯¢æ¨¡å¼

### 2.1 å…³é”®è¯æœç´¢

```sql
-- å•å­—æ®µæ¨¡ç³Šæœç´¢
SELECT
    id,
    title,
    content_summary
FROM articles
WHERE title LIKE CONCAT('%', :keyword, '%')
AND status = 2
LIMIT 20;

-- å¤šå­—æ®µæ¨¡ç³Šæœç´¢
SELECT
    id,
    title,
    author_username
FROM articles
WHERE (
    title LIKE CONCAT('%', :keyword, '%')
    OR content LIKE CONCAT('%', :keyword, '%')
    OR author_username LIKE CONCAT('%', :keyword, '%')
)
AND status = 2
LIMIT 20;

-- âš ï¸ æ€§èƒ½é—®é¢˜ï¼šLIKE '%keyword%' æ— æ³•ä½¿ç”¨ç´¢å¼•

-- ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šå‰ç¼€åŒ¹é…ï¼ˆå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼‰
SELECT * FROM products
WHERE name LIKE CONCAT(:keyword, '%')
LIMIT 20;

-- ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šå…¨æ–‡ç´¢å¼•
CREATE FULLTEXT INDEX ft_title_content ON articles(title, content) WITH PARSER ngram;

SELECT * FROM articles
WHERE MATCH(title, content) AGAINST(:keyword IN NATURAL LANGUAGE MODE)
LIMIT 20;
```

### 2.2 é«˜çº§æœç´¢ï¼ˆå¤šæ¡ä»¶ç»„åˆï¼‰

```sql
-- å•†å“æœç´¢ï¼šåˆ†ç±»ã€ä»·æ ¼åŒºé—´ã€å…³é”®è¯ã€æ’åº
SELECT
    id,
    name,
    price_cents / 100 AS price,
    sales_count
FROM products
WHERE status = 1
AND stock > 0
AND deleted_at IS NULL
AND (:category_id IS NULL OR category_id = :category_id)
AND (:min_price IS NULL OR price_cents >= :min_price * 100)
AND (:max_price IS NULL OR price_cents <= :max_price * 100)
AND (:keyword IS NULL OR name LIKE CONCAT('%', :keyword, '%'))
ORDER BY
    CASE :sort_by
        WHEN 'sales' THEN sales_count
        WHEN 'price_asc' THEN -price_cents
        WHEN 'price_desc' THEN price_cents
        ELSE -created_at
    END DESC
LIMIT 20 OFFSET :offset;

-- åº”ç”¨å±‚ä»£ç ï¼ˆPythonç¤ºä¾‹ï¼‰
def search_products(category_id=None, min_price=None, max_price=None,
                    keyword=None, sort_by='sales', page=1, page_size=20):
    params = {
        'category_id': category_id,
        'min_price': min_price,
        'max_price': max_price,
        'keyword': keyword,
        'sort_by': sort_by,
        'offset': (page - 1) * page_size
    }
    return db.query(sql, params)
```

### 2.3 æœç´¢å»ºè®®ï¼ˆè‡ªåŠ¨å®Œæˆï¼‰

```sql
-- æ ¹æ®å‰ç¼€æŸ¥è¯¢å»ºè®®
SELECT DISTINCT name
FROM products
WHERE name LIKE CONCAT(:prefix, '%')
AND status = 1
LIMIT 10;

-- çƒ­é—¨æœç´¢è¯
SELECT
    keyword,
    search_count
FROM search_keywords
ORDER BY search_count DESC
LIMIT 10;

-- ç›¸å…³æœç´¢
SELECT
    related_keyword,
    relevance_score
FROM search_relations
WHERE keyword = :keyword
ORDER BY relevance_score DESC
LIMIT 10;
```

---

## ä¸‰ã€ç»Ÿè®¡æŸ¥è¯¢æ¨¡å¼

### 3.1 æ—¥å¸¸ç»Ÿè®¡

```sql
-- ä»Šæ—¥ç»Ÿè®¡
SELECT
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales,
    AVG(total_amount) / 100 AS avg_order_amount
FROM orders
WHERE DATE(created_at) = CURDATE()
AND status IN (2, 3, 4);

-- æœ¬å‘¨ç»Ÿè®¡
SELECT
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales
FROM orders
WHERE YEARWEEK(created_at) = YEARWEEK(NOW())
AND status IN (2, 3, 4);

-- æœ¬æœˆç»Ÿè®¡
SELECT
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales
FROM orders
WHERE DATE_FORMAT(created_at, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
AND status IN (2, 3, 4);

-- æœ€è¿‘30å¤©ç»Ÿè®¡
SELECT
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales
FROM orders
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
AND status IN (2, 3, 4);
```

### 3.2 æ—¶é—´ç»´åº¦ç»Ÿè®¡

```sql
-- æŒ‰å¤©ç»Ÿè®¡ï¼ˆæœ€è¿‘7å¤©ï¼‰
SELECT
    DATE(created_at) AS date,
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales
FROM orders
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
AND status IN (2, 3, 4)
GROUP BY DATE(created_at)
ORDER BY date;

-- æŒ‰å°æ—¶ç»Ÿè®¡ï¼ˆä»Šå¤©ï¼‰
SELECT
    HOUR(created_at) AS hour,
    COUNT(*) AS order_count
FROM orders
WHERE DATE(created_at) = CURDATE()
GROUP BY HOUR(created_at)
ORDER BY hour;

-- æŒ‰æ˜ŸæœŸå‡ ç»Ÿè®¡
SELECT
    DAYOFWEEK(created_at) AS day_of_week,
    CASE DAYOFWEEK(created_at)
        WHEN 1 THEN 'å‘¨æ—¥'
        WHEN 2 THEN 'å‘¨ä¸€'
        WHEN 3 THEN 'å‘¨äºŒ'
        WHEN 4 THEN 'å‘¨ä¸‰'
        WHEN 5 THEN 'å‘¨å››'
        WHEN 6 THEN 'å‘¨äº”'
        WHEN 7 THEN 'å‘¨å…­'
    END AS day_name,
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales
FROM orders
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
AND status IN (2, 3, 4)
GROUP BY DAYOFWEEK(created_at)
ORDER BY day_of_week;

-- æŒ‰æœˆç»Ÿè®¡ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰
SELECT
    DATE_FORMAT(created_at, '%Y-%m') AS month,
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales
FROM orders
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 12 MONTH)
AND status IN (2, 3, 4)
GROUP BY DATE_FORMAT(created_at, '%Y-%m')
ORDER BY month;
```

### 3.3 åˆ†ç»„ç»Ÿè®¡

```sql
-- æŒ‰åˆ†ç±»ç»Ÿè®¡å•†å“
SELECT
    c.name AS category_name,
    COUNT(p.id) AS product_count,
    SUM(p.stock) AS total_stock,
    AVG(p.price_cents) / 100 AS avg_price,
    MIN(p.price_cents) / 100 AS min_price,
    MAX(p.price_cents) / 100 AS max_price
FROM categories c
LEFT JOIN products p ON c.id = p.category_id
GROUP BY c.id, c.name
ORDER BY product_count DESC;

-- æŒ‰åŸå¸‚ç»Ÿè®¡ç”¨æˆ·
SELECT
    city,
    COUNT(*) AS user_count,
    COUNT(*) * 100.0 / (SELECT COUNT(*) FROM users) AS percentage
FROM users
WHERE deleted_at IS NULL
GROUP BY city
ORDER BY user_count DESC
LIMIT 20;

-- æŒ‰ä»·æ ¼åŒºé—´ç»Ÿè®¡å•†å“
SELECT
    CASE
        WHEN price_cents < 10000 THEN '0-100å…ƒ'
        WHEN price_cents >= 10000 AND price_cents < 50000 THEN '100-500å…ƒ'
        WHEN price_cents >= 50000 AND price_cents < 100000 THEN '500-1000å…ƒ'
        ELSE '1000å…ƒä»¥ä¸Š'
    END AS price_range,
    COUNT(*) AS product_count,
    AVG(price_cents) / 100 AS avg_price
FROM products
GROUP BY price_range
ORDER BY MIN(price_cents);
```

---

## å››ã€æ’è¡Œæ¦œæŸ¥è¯¢

### 4.1 å•†å“é”€é‡æ’è¡Œ

```sql
-- Top 100å•†å“é”€é‡æ’è¡Œ
SELECT
    p.id,
    p.name,
    IFNULL(SUM(oi.quantity), 0) AS total_sales,
    IFNULL(SUM(oi.subtotal), 0) / 100 AS total_revenue
FROM products p
LEFT JOIN order_items oi ON p.id = oi.product_id
WHERE p.deleted_at IS NULL
GROUP BY p.id, p.name
ORDER BY total_sales DESC
LIMIT 100;

-- æŒ‰åˆ†ç±»çš„é”€é‡æ’è¡Œï¼ˆæ¯ä¸ªåˆ†ç±»Top 10ï¼‰
SELECT *
FROM (
    SELECT
        p.category_id,
        p.id,
        p.name,
        IFNULL(SUM(oi.quantity), 0) AS total_sales,
        ROW_NUMBER() OVER (PARTITION BY p.category_id ORDER BY IFNULL(SUM(oi.quantity), 0) DESC) AS rank_in_category
    FROM products p
    LEFT JOIN order_items oi ON p.id = oi.product_id
    GROUP BY p.category_id, p.id, p.name
) AS t
WHERE rank_in_category <= 10
ORDER BY category_id, rank_in_category;
```

### 4.2 ç”¨æˆ·æ¶ˆè´¹æ’è¡Œ

```sql
-- ç”¨æˆ·æ¶ˆè´¹æ’è¡Œ Top 100
SELECT
    u.id,
    u.username,
    COUNT(o.id) AS order_count,
    IFNULL(SUM(o.total_amount), 0) / 100 AS total_spent,
    MAX(o.created_at) AS last_order_at
FROM users u
LEFT JOIN orders o ON u.id = o.user_id AND o.status IN (2, 3, 4)
WHERE u.deleted_at IS NULL
GROUP BY u.id, u.username
HAVING total_spent > 0
ORDER BY total_spent DESC
LIMIT 100;

-- ä½¿ç”¨å†—ä½™å­—æ®µï¼ˆæ›´å¿«ï¼‰
SELECT
    id,
    username,
    total_spent / 100 AS total_spent_yuan,
    order_count,
    last_order_at
FROM users
WHERE deleted_at IS NULL
AND total_spent > 0
ORDER BY total_spent DESC
LIMIT 100;
```

### 4.3 çƒ­é—¨å†…å®¹æ’è¡Œ

```sql
-- çƒ­é—¨æ–‡ç« ï¼ˆç»¼åˆæ’åºï¼‰
SELECT
    id,
    title,
    author_username,
    view_count,
    like_count,
    comment_count,
    (view_count * 0.3 + like_count * 0.5 + comment_count * 0.2) AS hot_score
FROM articles
WHERE status = 2
AND deleted_at IS NULL
ORDER BY hot_score DESC
LIMIT 50;

-- ä½¿ç”¨å†—ä½™å­—æ®µhot_scoreï¼ˆæ›´å¿«ï¼‰
SELECT
    id,
    title,
    author_username,
    view_count,
    like_count,
    comment_count,
    hot_score
FROM articles
WHERE status = 2
AND deleted_at IS NULL
ORDER BY hot_score DESC
LIMIT 50;
```

---

## äº”ã€æ—¶é—´åºåˆ—æŸ¥è¯¢

### 5.1 è¶‹åŠ¿åˆ†æ

```sql
-- è®¢å•é‡è¶‹åŠ¿ï¼ˆæœ€è¿‘30å¤©ï¼‰
SELECT
    DATE(created_at) AS date,
    COUNT(*) AS order_count,
    SUM(total_amount) / 100 AS total_sales,
    AVG(total_amount) / 100 AS avg_order_amount
FROM orders
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
AND status IN (2, 3, 4)
GROUP BY DATE(created_at)
ORDER BY date;

-- æ–°å¢ç”¨æˆ·è¶‹åŠ¿
SELECT
    DATE(created_at) AS date,
    COUNT(*) AS new_users
FROM users
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date;

-- æ´»è·ƒç”¨æˆ·è¶‹åŠ¿ï¼ˆDAUï¼‰
SELECT
    DATE(login_at) AS date,
    COUNT(DISTINCT user_id) AS dau
FROM login_logs
WHERE login_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY DATE(login_at)
ORDER BY date;
```

### 5.2 åŒæ¯”ç¯æ¯”

```sql
-- æœˆåº¦é”€å”®åŒæ¯”ç¯æ¯”
WITH monthly_sales AS (
    SELECT
        DATE_FORMAT(created_at, '%Y-%m') AS month,
        SUM(total_amount) / 100 AS sales
    FROM orders
    WHERE status IN (2, 3, 4)
    GROUP BY DATE_FORMAT(created_at, '%Y-%m')
)
SELECT
    month,
    sales,
    LAG(sales, 1) OVER (ORDER BY month) AS prev_month_sales,
    LAG(sales, 12) OVER (ORDER BY month) AS same_month_last_year,
    ROUND((sales - LAG(sales, 1) OVER (ORDER BY month)) / LAG(sales, 1) OVER (ORDER BY month) * 100, 2) AS mom_growth,
    ROUND((sales - LAG(sales, 12) OVER (ORDER BY month)) / LAG(sales, 12) OVER (ORDER BY month) * 100, 2) AS yoy_growth
FROM monthly_sales
ORDER BY month DESC
LIMIT 12;
```

### 5.3 ç•™å­˜åˆ†æ

```sql
-- ç”¨æˆ·7æ—¥ç•™å­˜ç‡
WITH first_login AS (
    SELECT user_id, MIN(DATE(created_at)) AS first_day
    FROM users
    GROUP BY user_id
),
retention AS (
    SELECT
        fl.first_day,
        COUNT(DISTINCT fl.user_id) AS new_users,
        COUNT(DISTINCT CASE
            WHEN EXISTS (
                SELECT 1 FROM login_logs ll
                WHERE ll.user_id = fl.user_id
                AND DATE(ll.login_at) = DATE_ADD(fl.first_day, INTERVAL 7 DAY)
            ) THEN fl.user_id
        END) AS retained_users
    FROM first_login fl
    GROUP BY fl.first_day
)
SELECT
    first_day,
    new_users,
    retained_users,
    ROUND(retained_users * 100.0 / new_users, 2) AS retention_rate
FROM retention
ORDER BY first_day DESC
LIMIT 30;
```

---

## å…­ã€æ•°æ®å¯¼å‡ºæŸ¥è¯¢

### 6.1 è®¢å•å¯¼å‡º

```sql
-- å¯¼å‡ºè®¢å•æ•°æ®ï¼ˆå¸¦å…³è”ä¿¡æ¯ï¼‰
SELECT
    o.order_no AS 'è®¢å•å·',
    u.username AS 'ç”¨æˆ·å',
    u.email AS 'é‚®ç®±',
    o.total_amount / 100 AS 'è®¢å•é‡‘é¢',
    CASE o.status
        WHEN 1 THEN 'å¾…æ”¯ä»˜'
        WHEN 2 THEN 'å·²æ”¯ä»˜'
        WHEN 3 THEN 'å·²å‘è´§'
        WHEN 4 THEN 'å·²å®Œæˆ'
        WHEN 5 THEN 'å·²å–æ¶ˆ'
    END AS 'è®¢å•çŠ¶æ€',
    DATE_FORMAT(o.created_at, '%Y-%m-%d %H:%i:%s') AS 'ä¸‹å•æ—¶é—´',
    DATE_FORMAT(o.paid_at, '%Y-%m-%d %H:%i:%s') AS 'æ”¯ä»˜æ—¶é—´'
FROM orders o
JOIN users u ON o.user_id = u.id
WHERE o.created_at >= :start_date
AND o.created_at < :end_date
ORDER BY o.created_at DESC;

-- å¯¼å‡ºåˆ°CSVï¼ˆåº”ç”¨å±‚ï¼‰
-- SELECT ... INTO OUTFILE '/tmp/orders.csv'
-- FIELDS TERMINATED BY ',' ENCLOSED BY '"'
-- LINES TERMINATED BY '\n';
```

### 6.2 å•†å“é”€å”®æ˜ç»†å¯¼å‡º

```sql
-- å¯¼å‡ºå•†å“é”€å”®æ˜ç»†
SELECT
    p.id AS 'å•†å“ID',
    p.name AS 'å•†å“åç§°',
    c.name AS 'åˆ†ç±»',
    oi.quantity AS 'é”€å”®æ•°é‡',
    oi.price_cents / 100 AS 'æˆäº¤å•ä»·',
    oi.subtotal / 100 AS 'å°è®¡',
    o.order_no AS 'è®¢å•å·',
    u.username AS 'ä¹°å®¶',
    DATE_FORMAT(o.created_at, '%Y-%m-%d %H:%i:%s') AS 'ä¸‹å•æ—¶é—´'
FROM order_items oi
JOIN orders o ON oi.order_id = o.id
JOIN products p ON oi.product_id = p.id
JOIN categories c ON p.category_id = c.id
JOIN users u ON o.user_id = u.id
WHERE o.created_at >= :start_date
AND o.created_at < :end_date
AND o.status IN (2, 3, 4)
ORDER BY o.created_at DESC;
```

### 6.3 ç”¨æˆ·æ•°æ®å¯¼å‡º

```sql
-- å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆå«ç»Ÿè®¡ï¼‰
SELECT
    u.id AS 'ç”¨æˆ·ID',
    u.username AS 'ç”¨æˆ·å',
    u.email AS 'é‚®ç®±',
    u.phone AS 'æ‰‹æœºå·',
    u.city AS 'åŸå¸‚',
    COUNT(o.id) AS 'è®¢å•æ•°',
    IFNULL(SUM(o.total_amount), 0) / 100 AS 'ç´¯è®¡æ¶ˆè´¹',
    DATE_FORMAT(u.created_at, '%Y-%m-%d %H:%i:%s') AS 'æ³¨å†Œæ—¶é—´',
    DATE_FORMAT(MAX(o.created_at), '%Y-%m-%d %H:%i:%s') AS 'æœ€åä¸‹å•æ—¶é—´'
FROM users u
LEFT JOIN orders o ON u.id = o.user_id AND o.status IN (2, 3, 4)
WHERE u.deleted_at IS NULL
GROUP BY u.id, u.username, u.email, u.phone, u.city, u.created_at
ORDER BY u.created_at DESC;
```

---

## ä¸ƒã€å®æˆ˜ç»¼åˆæ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šç”µå•†è®¢å•åˆ—è¡¨

```sql
-- éœ€æ±‚ï¼š
-- 1. æ”¯æŒå¤šæ¡ä»¶ç­›é€‰ï¼ˆæ—¶é—´èŒƒå›´ã€çŠ¶æ€ã€ç”¨æˆ·ã€è®¢å•å·ï¼‰
-- 2. æ”¯æŒæ’åºï¼ˆæ—¶é—´ã€é‡‘é¢ï¼‰
-- 3. åˆ†é¡µæŸ¥è¯¢
-- 4. æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ã€è®¢å•é‡‘é¢ã€çŠ¶æ€

SELECT
    o.id,
    o.order_no,
    u.username,
    u.email,
    o.total_amount / 100 AS total,
    CASE o.status
        WHEN 1 THEN 'å¾…æ”¯ä»˜'
        WHEN 2 THEN 'å·²æ”¯ä»˜'
        WHEN 3 THEN 'å·²å‘è´§'
        WHEN 4 THEN 'å·²å®Œæˆ'
        WHEN 5 THEN 'å·²å–æ¶ˆ'
    END AS status_text,
    o.created_at,
    o.paid_at
FROM orders o
JOIN users u ON o.user_id = u.id
WHERE 1=1
AND (:start_date IS NULL OR o.created_at >= :start_date)
AND (:end_date IS NULL OR o.created_at < :end_date)
AND (:status IS NULL OR o.status = :status)
AND (:user_id IS NULL OR o.user_id = :user_id)
AND (:order_no IS NULL OR o.order_no LIKE CONCAT('%', :order_no, '%'))
ORDER BY
    CASE :sort_by
        WHEN 'amount_desc' THEN o.total_amount
        WHEN 'amount_asc' THEN -o.total_amount
        ELSE UNIX_TIMESTAMP(o.created_at)
    END DESC
LIMIT :page_size OFFSET :offset;

-- æ€»æ•°æŸ¥è¯¢
SELECT COUNT(*)
FROM orders o
WHERE 1=1
AND (:start_date IS NULL OR o.created_at >= :start_date)
AND (:end_date IS NULL OR o.created_at < :end_date)
AND (:status IS NULL OR o.status = :status)
AND (:user_id IS NULL OR o.user_id = :user_id)
AND (:order_no IS NULL OR o.order_no LIKE CONCAT('%', :order_no, '%'));
```

### æ¡ˆä¾‹2ï¼šç”¨æˆ·è¡Œä¸ºåˆ†æ

```sql
-- éœ€æ±‚ï¼šåˆ†æç”¨æˆ·çš„æµè§ˆã€æ”¶è—ã€è´­ä¹°è¡Œä¸º

WITH user_stats AS (
    SELECT
        u.id,
        u.username,
        u.created_at AS register_at,

        -- æµè§ˆè¡Œä¸º
        (SELECT COUNT(*) FROM browse_logs WHERE user_id = u.id) AS browse_count,
        (SELECT MAX(created_at) FROM browse_logs WHERE user_id = u.id) AS last_browse_at,

        -- æ”¶è—è¡Œä¸º
        (SELECT COUNT(*) FROM favorites WHERE user_id = u.id) AS favorite_count,

        -- è´­ä¹°è¡Œä¸º
        (SELECT COUNT(*) FROM orders WHERE user_id = u.id AND status IN (2,3,4)) AS order_count,
        (SELECT IFNULL(SUM(total_amount), 0) FROM orders WHERE user_id = u.id AND status IN (2,3,4)) AS total_spent,
        (SELECT MAX(created_at) FROM orders WHERE user_id = u.id AND status IN (2,3,4)) AS last_order_at

    FROM users u
    WHERE u.deleted_at IS NULL
)
SELECT
    id,
    username,
    register_at,
    browse_count,
    last_browse_at,
    favorite_count,
    order_count,
    total_spent / 100 AS total_spent_yuan,
    last_order_at,

    -- è½¬åŒ–ç‡
    ROUND(order_count * 100.0 / NULLIF(browse_count, 0), 2) AS conversion_rate,

    -- ç”¨æˆ·åˆ†ç±»
    CASE
        WHEN order_count >= 10 AND total_spent >= 100000 THEN 'é«˜ä»·å€¼ç”¨æˆ·'
        WHEN order_count >= 5 THEN 'æ´»è·ƒç”¨æˆ·'
        WHEN browse_count > 0 THEN 'æ½œåœ¨ç”¨æˆ·'
        ELSE 'æ²‰ç¡ç”¨æˆ·'
    END AS user_type

FROM user_stats
ORDER BY total_spent DESC;
```

---

## å…«ã€æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 8.1 ç´¢å¼•ä¼˜åŒ–

```sql
-- 1. WHEREæ¡ä»¶å­—æ®µåŠ ç´¢å¼•
CREATE INDEX idx_status_created ON orders(status, created_at);

-- 2. ORDER BYå­—æ®µåŠ ç´¢å¼•
CREATE INDEX idx_created ON articles(created_at);

-- 3. JOINå­—æ®µåŠ ç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);

-- 4. è¦†ç›–ç´¢å¼•ï¼ˆåŒ…å«SELECTå­—æ®µï¼‰
CREATE INDEX idx_status_created_id ON orders(status, created_at, id, total_amount);
```

### 8.2 æŸ¥è¯¢ä¼˜åŒ–

```sql
-- 1. é¿å…SELECT *
-- âŒ SELECT * FROM orders
-- âœ… SELECT id, order_no, total_amount FROM orders

-- 2. åˆ†é¡µé™åˆ¶æœ€å¤§é¡µæ•°
-- WHERE page <= 100

-- 3. ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µä»£æ›¿OFFSET
-- WHERE id < :last_id ORDER BY id DESC LIMIT 20

-- 4. ç»Ÿè®¡æŸ¥è¯¢ç»“æœç¼“å­˜
-- å°†COUNT(*)ç»“æœç¼“å­˜åˆ°Redisï¼Œå®šæ—¶æ›´æ–°

-- 5. å†—ä½™ç»Ÿè®¡å­—æ®µ
-- ALTER TABLE articles ADD COLUMN comment_count INT DEFAULT 0

-- 6. é¿å…åœ¨WHEREä¸­ä½¿ç”¨å‡½æ•°
-- âŒ WHERE YEAR(created_at) = 2024
-- âœ… WHERE created_at >= '2024-01-01' AND created_at < '2025-01-01'
```

---

## ä¹ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **åˆ†é¡µæŸ¥è¯¢**ï¼š
   - åŸºç¡€åˆ†é¡µï¼šLIMIT OFFSET
   - æ¸¸æ ‡åˆ†é¡µï¼šWHERE id < last_idï¼ˆæ¨èï¼‰

2. **æœç´¢æŸ¥è¯¢**ï¼š
   - LIKEæ¨¡ç³Šæœç´¢
   - å…¨æ–‡ç´¢å¼•æœç´¢
   - å¤šæ¡ä»¶ç»„åˆæœç´¢

3. **ç»Ÿè®¡æŸ¥è¯¢**ï¼š
   - æ—¶é—´ç»´åº¦ç»Ÿè®¡
   - åˆ†ç»„ç»Ÿè®¡
   - å æ¯”è®¡ç®—

4. **æ’è¡Œæ¦œæŸ¥è¯¢**ï¼š
   - é”€é‡æ’è¡Œ
   - ç”¨æˆ·æ’è¡Œ
   - çƒ­é—¨å†…å®¹æ’è¡Œ

5. **æ—¶é—´åºåˆ—æŸ¥è¯¢**ï¼š
   - è¶‹åŠ¿åˆ†æ
   - åŒæ¯”ç¯æ¯”
   - ç•™å­˜åˆ†æ

6. **æ•°æ®å¯¼å‡º**ï¼š
   - è®¢å•å¯¼å‡º
   - é”€å”®æ˜ç»†å¯¼å‡º
   - ç”¨æˆ·æ•°æ®å¯¼å‡º

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… å®ç°å„ç§åˆ†é¡µæŸ¥è¯¢
- âœ… å®ç°æœç´¢åŠŸèƒ½
- âœ… ç¼–å†™ç»Ÿè®¡æŸ¥è¯¢
- âœ… å®ç°æ’è¡Œæ¦œåŠŸèƒ½
- âœ… åˆ†ææ—¶é—´åºåˆ—æ•°æ®

**ğŸ‰ æ­å–œå®Œæˆç¬¬ä¸‰ç« ï¼**

ä¸‹ä¸€ç« ï¼š[ç¬¬å››ç«  - ä¸šåŠ¡åœºæ™¯å®æˆ˜](./14-ç”¨æˆ·ç³»ç»Ÿè®¾è®¡ä¸å®ç°.md)
