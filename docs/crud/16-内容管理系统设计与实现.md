# 16-内容管理系统设计与实现

> 从零设计并实现一个完整的内容管理系统（文章、评论、点赞、标签）

---

## 📖 本章目标

- 设计文章表结构
- 实现文章发布流程
- 实现评论系统
- 实现点赞/收藏系统
- 实现标签系统
- 实现文章查询和推荐

---

## 一、文章表设计

### 1.1 文章主表

```sql
CREATE TABLE articles (
    -- 主键
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '文章ID',

    -- 标题和内容
    title VARCHAR(200) NOT NULL COMMENT '标题',
    content_summary VARCHAR(500) NOT NULL DEFAULT '' COMMENT '摘要',
    content TEXT NOT NULL COMMENT '正文内容',
    cover_image VARCHAR(255) NOT NULL DEFAULT '' COMMENT '封面图',

    -- 作者信息
    author_id BIGINT UNSIGNED NOT NULL COMMENT '作者ID',
    author_username VARCHAR(50) NOT NULL COMMENT '作者用户名（冗余）',
    author_avatar VARCHAR(255) NOT NULL DEFAULT '' COMMENT '作者头像（冗余）',

    -- 分类
    category_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '分类ID',

    -- 状态
    status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '状态：1-草稿，2-已发布，3-已下线',

    -- 统计字段（冗余）
    view_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '浏览量',
    like_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '点赞数',
    comment_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '评论数',
    favorite_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '收藏数',

    -- 推荐权重
    hot_score DECIMAL(10, 2) NOT NULL DEFAULT 0 COMMENT '热度分数',
    is_recommended TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '是否推荐：0-否，1-是',
    is_top TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '是否置顶：0-否，1-是',

    -- 时间戳
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    published_at DATETIME DEFAULT NULL COMMENT '发布时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '删除时间',

    -- 索引
    INDEX idx_author_id (author_id),
    INDEX idx_category_id (category_id),
    INDEX idx_status_published (status, published_at),
    INDEX idx_hot_score (hot_score),
    INDEX idx_view_count (view_count),
    INDEX idx_created_at (created_at),
    INDEX idx_deleted_at (deleted_at),

    FULLTEXT INDEX ft_title_content (title, content) WITH PARSER ngram
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文章表';
```

### 1.2 文章分类表

```sql
CREATE TABLE categories (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL COMMENT '分类名称',
    slug VARCHAR(50) NOT NULL COMMENT 'URL别名',
    description VARCHAR(255) NOT NULL DEFAULT '' COMMENT '描述',
    parent_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '父分类ID',
    sort_order INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '排序',
    article_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '文章数（冗余）',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_slug (slug),
    INDEX idx_parent_id (parent_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文章分类表';
```

---

## 二、标签系统

### 2.1 标签表设计

```sql
-- 标签表
CREATE TABLE tags (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL COMMENT '标签名称',
    article_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '文章数（冗余）',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='标签表';

-- 文章标签关联表
CREATE TABLE article_tags (
    article_id BIGINT UNSIGNED NOT NULL COMMENT '文章ID',
    tag_id BIGINT UNSIGNED NOT NULL COMMENT '标签ID',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (article_id, tag_id),
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文章标签关联表';
```

### 2.2 标签操作

```sql
-- 添加标签到文章
-- 1. 查找或创建标签
INSERT INTO tags (name) VALUES (:tag_name)
ON DUPLICATE KEY UPDATE name = name;

SET @tag_id = LAST_INSERT_ID();

-- 2. 关联文章和标签
INSERT IGNORE INTO article_tags (article_id, tag_id)
VALUES (:article_id, @tag_id);

-- 3. 更新标签文章数
UPDATE tags
SET article_count = (
    SELECT COUNT(*) FROM article_tags WHERE tag_id = @tag_id
)
WHERE id = @tag_id;

-- 查询文章的所有标签
SELECT
    t.id,
    t.name
FROM tags t
JOIN article_tags at ON t.id = at.tag_id
WHERE at.article_id = :article_id
ORDER BY t.name;

-- 查询标签下的所有文章
SELECT
    a.id,
    a.title,
    a.author_username,
    a.view_count,
    a.published_at
FROM articles a
JOIN article_tags at ON a.id = at.article_id
WHERE at.tag_id = :tag_id
AND a.status = 2
AND a.deleted_at IS NULL
ORDER BY a.published_at DESC
LIMIT 20;
```

---

## 三、评论系统

### 3.1 评论表设计

```sql
CREATE TABLE comments (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    -- 文章信息
    article_id BIGINT UNSIGNED NOT NULL COMMENT '文章ID',

    -- 用户信息
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    username VARCHAR(50) NOT NULL COMMENT '用户名（冗余）',
    user_avatar VARCHAR(255) NOT NULL DEFAULT '' COMMENT '用户头像（冗余）',

    -- 评论内容
    content TEXT NOT NULL COMMENT '评论内容',

    -- 父评论ID（回复功能）
    parent_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '父评论ID',
    root_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '根评论ID',
    reply_to_user_id BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '回复的用户ID',
    reply_to_username VARCHAR(50) NOT NULL DEFAULT '' COMMENT '回复的用户名',

    -- 点赞数
    like_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '点赞数',

    -- 状态
    status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '状态：1-正常，2-已隐藏',

    -- IP地址
    ip VARCHAR(50) NOT NULL DEFAULT '' COMMENT 'IP地址',

    -- 时间戳
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,

    INDEX idx_article_id (article_id),
    INDEX idx_user_id (user_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_root_id (root_id),
    INDEX idx_created_at (created_at),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='评论表';
```

### 3.2 发表评论

```sql
BEGIN;

-- 1. 插入评论
INSERT INTO comments (
    article_id,
    user_id,
    username,
    user_avatar,
    content,
    parent_id,
    root_id,
    reply_to_user_id,
    reply_to_username,
    ip,
    status
)
SELECT
    :article_id,
    :user_id,
    u.username,
    u.avatar,
    :content,
    :parent_id,
    CASE WHEN :parent_id = 0 THEN 0 ELSE :root_id END,
    :reply_to_user_id,
    :reply_to_username,
    :ip,
    1
FROM users u
WHERE u.id = :user_id;

-- 2. 更新文章评论数
UPDATE articles
SET comment_count = comment_count + 1
WHERE id = :article_id;

COMMIT;
```

### 3.3 查询评论列表

```sql
-- 查询文章的一级评论
SELECT
    c.id,
    c.user_id,
    c.username,
    c.user_avatar,
    c.content,
    c.like_count,
    c.created_at,
    (
        SELECT COUNT(*)
        FROM comments
        WHERE root_id = c.id
        AND deleted_at IS NULL
    ) AS reply_count
FROM comments c
WHERE c.article_id = :article_id
AND c.parent_id = 0
AND c.status = 1
AND c.deleted_at IS NULL
ORDER BY c.created_at DESC
LIMIT 20 OFFSET :offset;

-- 查询评论的回复
SELECT
    c.id,
    c.user_id,
    c.username,
    c.user_avatar,
    c.content,
    c.reply_to_user_id,
    c.reply_to_username,
    c.like_count,
    c.created_at
FROM comments c
WHERE c.root_id = :root_id
AND c.parent_id != 0
AND c.status = 1
AND c.deleted_at IS NULL
ORDER BY c.created_at ASC
LIMIT 20;
```

---

## 四、点赞/收藏系统

### 4.1 点赞表设计

```sql
CREATE TABLE article_likes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    article_id BIGINT UNSIGNED NOT NULL,
    user_id BIGINT UNSIGNED NOT NULL,

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_article_user (article_id, user_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文章点赞表';

CREATE TABLE comment_likes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    comment_id BIGINT UNSIGNED NOT NULL,
    user_id BIGINT UNSIGNED NOT NULL,

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_comment_user (comment_id, user_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评论点赞表';
```

### 4.2 点赞/取消点赞

```sql
-- 点赞文章
BEGIN;

-- 1. 插入点赞记录（如果已存在则忽略）
INSERT IGNORE INTO article_likes (article_id, user_id)
VALUES (:article_id, :user_id);

-- 2. 更新文章点赞数
UPDATE articles
SET like_count = like_count + ROW_COUNT()
WHERE id = :article_id;

COMMIT;

-- 取消点赞
BEGIN;

DELETE FROM article_likes
WHERE article_id = :article_id
AND user_id = :user_id;

UPDATE articles
SET like_count = like_count - ROW_COUNT()
WHERE id = :article_id;

COMMIT;

-- 检查是否已点赞
SELECT COUNT(*) AS is_liked
FROM article_likes
WHERE article_id = :article_id
AND user_id = :user_id;
```

### 4.3 收藏表设计

```sql
CREATE TABLE favorites (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    article_id BIGINT UNSIGNED NOT NULL,

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE KEY uniq_user_article (user_id, article_id),
    INDEX idx_article_id (article_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';

-- 收藏文章
BEGIN;

INSERT IGNORE INTO favorites (user_id, article_id)
VALUES (:user_id, :article_id);

UPDATE articles
SET favorite_count = favorite_count + ROW_COUNT()
WHERE id = :article_id;

COMMIT;

-- 取消收藏
BEGIN;

DELETE FROM favorites
WHERE user_id = :user_id
AND article_id = :article_id;

UPDATE articles
SET favorite_count = favorite_count - ROW_COUNT()
WHERE id = :article_id;

COMMIT;

-- 查询用户的收藏列表
SELECT
    a.id,
    a.title,
    a.content_summary,
    a.cover_image,
    a.author_username,
    a.view_count,
    a.like_count,
    f.created_at AS favorited_at
FROM favorites f
JOIN articles a ON f.article_id = a.id
WHERE f.user_id = :user_id
AND a.deleted_at IS NULL
ORDER BY f.created_at DESC
LIMIT 20 OFFSET :offset;
```

---

## 五、文章发布流程

### 5.1 创建草稿

```sql
INSERT INTO articles (
    title,
    content_summary,
    content,
    cover_image,
    author_id,
    author_username,
    author_avatar,
    category_id,
    status
)
SELECT
    :title,
    :content_summary,
    :content,
    :cover_image,
    :author_id,
    u.username,
    u.avatar,
    :category_id,
    1  -- 草稿
FROM users u
WHERE u.id = :author_id;
```

### 5.2 发布文章

```sql
BEGIN;

-- 1. 更新文章状态
UPDATE articles
SET
    status = 2,  -- 已发布
    published_at = NOW()
WHERE id = :article_id
AND author_id = :author_id
AND status = 1;  -- 只能从草稿发布

-- 2. 更新分类文章数
UPDATE categories
SET article_count = article_count + 1
WHERE id = (
    SELECT category_id FROM articles WHERE id = :article_id
);

-- 3. 更新标签文章数
UPDATE tags t
JOIN article_tags at ON t.id = at.tag_id
SET t.article_count = t.article_count + 1
WHERE at.article_id = :article_id;

COMMIT;
```

### 5.3 更新文章

```sql
UPDATE articles
SET
    title = :title,
    content_summary = :content_summary,
    content = :content,
    cover_image = :cover_image,
    category_id = :category_id
WHERE id = :article_id
AND author_id = :author_id;

-- 更新标签
-- 1. 删除原有标签
DELETE FROM article_tags WHERE article_id = :article_id;

-- 2. 添加新标签
INSERT INTO article_tags (article_id, tag_id)
VALUES
(:article_id, :tag_id_1),
(:article_id, :tag_id_2);
```

---

## 六、文章查询

### 6.1 文章列表（首页）

```sql
SELECT
    a.id,
    a.title,
    a.content_summary,
    a.cover_image,
    a.author_username,
    a.author_avatar,
    a.view_count,
    a.like_count,
    a.comment_count,
    a.published_at,
    GROUP_CONCAT(t.name ORDER BY t.name SEPARATOR ', ') AS tags
FROM articles a
LEFT JOIN article_tags at ON a.id = at.article_id
LEFT JOIN tags t ON at.tag_id = t.id
WHERE a.status = 2
AND a.deleted_at IS NULL
GROUP BY a.id
ORDER BY a.is_top DESC, a.published_at DESC
LIMIT 20 OFFSET :offset;
```

### 6.2 文章详情

```sql
-- 1. 查询文章详情
SELECT
    a.id,
    a.title,
    a.content,
    a.cover_image,
    a.author_id,
    a.author_username,
    a.author_avatar,
    a.category_id,
    c.name AS category_name,
    a.view_count,
    a.like_count,
    a.comment_count,
    a.favorite_count,
    a.published_at
FROM articles a
LEFT JOIN categories c ON a.category_id = c.id
WHERE a.id = :article_id
AND a.status = 2
AND a.deleted_at IS NULL;

-- 2. 更新浏览量
UPDATE articles
SET view_count = view_count + 1
WHERE id = :article_id;

-- 3. 查询标签
SELECT
    t.id,
    t.name
FROM tags t
JOIN article_tags at ON t.id = at.tag_id
WHERE at.article_id = :article_id;

-- 4. 检查当前用户是否点赞/收藏
SELECT
    EXISTS(SELECT 1 FROM article_likes WHERE article_id = :article_id AND user_id = :user_id) AS is_liked,
    EXISTS(SELECT 1 FROM favorites WHERE article_id = :article_id AND user_id = :user_id) AS is_favorited;
```

### 6.3 按分类查询

```sql
SELECT
    a.id,
    a.title,
    a.content_summary,
    a.author_username,
    a.view_count,
    a.published_at
FROM articles a
WHERE a.category_id = :category_id
AND a.status = 2
AND a.deleted_at IS NULL
ORDER BY a.published_at DESC
LIMIT 20 OFFSET :offset;
```

### 6.4 搜索文章

```sql
-- 使用全文索引搜索
SELECT
    a.id,
    a.title,
    a.content_summary,
    a.author_username,
    a.view_count,
    a.published_at,
    MATCH(a.title, a.content) AGAINST(:keyword) AS relevance
FROM articles a
WHERE MATCH(a.title, a.content) AGAINST(:keyword IN NATURAL LANGUAGE MODE)
AND a.status = 2
AND a.deleted_at IS NULL
ORDER BY relevance DESC, a.published_at DESC
LIMIT 20;
```

---

## 七、推荐系统

### 7.1 热度分数计算

```sql
-- 计算热度分数（定时任务，每小时执行）
UPDATE articles
SET hot_score = (
    view_count * 0.3 +
    like_count * 0.5 +
    comment_count * 0.2
) * (1 - DATEDIFF(NOW(), published_at) / 365)
WHERE status = 2
AND deleted_at IS NULL
AND published_at >= DATE_SUB(NOW(), INTERVAL 30 DAY);

-- 查询热门文章
SELECT
    id,
    title,
    content_summary,
    author_username,
    view_count,
    like_count,
    hot_score
FROM articles
WHERE status = 2
AND deleted_at IS NULL
ORDER BY hot_score DESC
LIMIT 20;
```

### 7.2 相关文章推荐

```sql
-- 基于标签的相关文章
SELECT
    a.id,
    a.title,
    a.content_summary,
    a.author_username,
    COUNT(DISTINCT at2.tag_id) AS common_tags
FROM articles a
JOIN article_tags at1 ON a.id = at1.article_id
JOIN article_tags at2 ON at1.tag_id = at2.tag_id
WHERE at2.article_id = :current_article_id
AND a.id != :current_article_id
AND a.status = 2
AND a.deleted_at IS NULL
GROUP BY a.id
ORDER BY common_tags DESC, a.hot_score DESC
LIMIT 10;
```

---

## 八、统计分析

### 8.1 文章统计

```sql
-- 总体统计
SELECT
    COUNT(*) AS total_articles,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS draft_count,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS published_count,
    SUM(view_count) AS total_views,
    SUM(like_count) AS total_likes,
    SUM(comment_count) AS total_comments
FROM articles
WHERE deleted_at IS NULL;

-- 最近30天发文趋势
SELECT
    DATE(published_at) AS date,
    COUNT(*) AS article_count
FROM articles
WHERE status = 2
AND published_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY DATE(published_at)
ORDER BY date;

-- 分类文章分布
SELECT
    c.name AS category_name,
    COUNT(a.id) AS article_count,
    SUM(a.view_count) AS total_views
FROM categories c
LEFT JOIN articles a ON c.id = a.category_id AND a.status = 2
GROUP BY c.id, c.name
ORDER BY article_count DESC;
```

---

## 九、本章总结

### 核心要点

1. **表设计**：
   - articles：文章主表
   - comments：评论表
   - article_likes：点赞表
   - favorites：收藏表
   - tags + article_tags：标签系统

2. **文章发布**：
   - 草稿 → 发布流程
   - 标签关联
   - 统计字段维护

3. **评论系统**：
   - 一级评论
   - 二级回复
   - 点赞功能

4. **点赞/收藏**：
   - 冗余计数字段
   - 事务保证一致性

5. **推荐系统**：
   - 热度分数
   - 相关文章推荐

### 下一步

完成本章学习后，你应该能够：
- ✅ 设计完整的内容管理系统
- ✅ 实现文章发布流程
- ✅ 实现评论系统
- ✅ 实现点赞/收藏功能
- ✅ 实现推荐算法

下一节：[17-营销系统设计与实现](./17-营销系统设计与实现.md)
