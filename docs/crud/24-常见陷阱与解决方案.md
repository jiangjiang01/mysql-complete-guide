# 24-å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ

> è¯†åˆ«å¹¶é¿å…MySQLå¼€å‘ä¸­çš„å¸¸è§é™·é˜±

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- è¯†åˆ«NULLå€¼ç›¸å…³é™·é˜±
- é¿å…ç±»å‹è½¬æ¢é—®é¢˜
- è§£å†³å­—ç¬¦ç¼–ç é—®é¢˜
- å¤„ç†äº‹åŠ¡å’Œé”é—®é¢˜
- é˜²æ­¢æ•°æ®ä¸¢å¤±
- é¿å…å¸¸è§æŸ¥è¯¢é”™è¯¯

---

## ä¸€ã€NULLå€¼é™·é˜±

### 1.1 NULLä¸æ¯”è¾ƒè¿ç®—

```sql
-- âŒ é™·é˜±ï¼šNULLä¸ä»»ä½•å€¼æ¯”è¾ƒéƒ½æ˜¯NULLï¼ˆä¸æ˜¯FALSEï¼‰
SELECT * FROM users WHERE age = NULL;     -- è¿”å›ç©ºï¼ˆé”™è¯¯ï¼‰
SELECT * FROM users WHERE age != NULL;    -- è¿”å›ç©ºï¼ˆé”™è¯¯ï¼‰
SELECT * FROM users WHERE age > NULL;     -- è¿”å›ç©ºï¼ˆé”™è¯¯ï¼‰

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨IS NULL / IS NOT NULL
SELECT * FROM users WHERE age IS NULL;
SELECT * FROM users WHERE age IS NOT NULL;

-- ç¤ºä¾‹ï¼š
CREATE TABLE test (id INT, value INT);
INSERT INTO test VALUES (1, 10), (2, NULL), (3, 30);

-- âŒ é”™è¯¯æŸ¥è¯¢
SELECT * FROM test WHERE value = NULL;     -- è¿”å›0è¡Œ
SELECT * FROM test WHERE value != NULL;    -- è¿”å›0è¡Œ

-- âœ… æ­£ç¡®æŸ¥è¯¢
SELECT * FROM test WHERE value IS NULL;    -- è¿”å›1è¡Œï¼ˆid=2ï¼‰
SELECT * FROM test WHERE value IS NOT NULL; -- è¿”å›2è¡Œï¼ˆid=1,3ï¼‰
```

### 1.2 NULLä¸èšåˆå‡½æ•°

```sql
-- âŒ é™·é˜±ï¼šCOUNT(*)ä¸COUNT(å­—æ®µ)çš„åŒºåˆ«
CREATE TABLE test (id INT, value INT);
INSERT INTO test VALUES (1, 10), (2, NULL), (3, 30);

SELECT COUNT(*) FROM test;        -- 3ï¼ˆåŒ…å«NULLï¼‰
SELECT COUNT(value) FROM test;    -- 2ï¼ˆä¸åŒ…å«NULLï¼‰

-- âŒ é™·é˜±ï¼šSUMã€AVGå¿½ç•¥NULL
SELECT SUM(value) FROM test;       -- 40ï¼ˆ10+30ï¼Œå¿½ç•¥NULLï¼‰
SELECT AVG(value) FROM test;       -- 20ï¼ˆ40/2ï¼Œä¸æ˜¯40/3ï¼‰

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨IFNULL/COALESCEå¤„ç†NULL
SELECT SUM(IFNULL(value, 0)) FROM test;  -- 40
SELECT AVG(IFNULL(value, 0)) FROM test;  -- 13.33ï¼ˆ40/3ï¼‰
```

### 1.3 NULLä¸IN/NOT IN

```sql
-- âŒ é™·é˜±ï¼šNOT INé‡åˆ°NULLä¼šè¿”å›ç©ºç»“æœ
CREATE TABLE users (id INT);
INSERT INTO users VALUES (1), (2), (3);

CREATE TABLE orders (user_id INT);
INSERT INTO orders VALUES (1), (NULL);

-- æŸ¥è¯¢æ²¡æœ‰è®¢å•çš„ç”¨æˆ·
SELECT * FROM users
WHERE id NOT IN (SELECT user_id FROM orders);
-- è¿”å›0è¡Œï¼ï¼ˆå› ä¸ºåŒ…å«NULLï¼‰

-- åŸç†ï¼š
-- id NOT IN (1, NULL)
-- ç­‰ä»·äºï¼šid != 1 AND id != NULL
-- ç­‰ä»·äºï¼šid != 1 AND NULL
-- ç»“æœï¼šNULLï¼ˆä¸æ˜¯TRUEï¼‰

-- âœ… è§£å†³æ–¹æ¡ˆ1ï¼šè¿‡æ»¤NULL
SELECT * FROM users
WHERE id NOT IN (
    SELECT user_id FROM orders WHERE user_id IS NOT NULL
);

-- âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨NOT EXISTS
SELECT * FROM users u
WHERE NOT EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);

-- âœ… è§£å†³æ–¹æ¡ˆ3ï¼šä½¿ç”¨LEFT JOIN
SELECT u.*
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE o.user_id IS NULL;
```

### 1.4 NULLä¸å”¯ä¸€ç´¢å¼•

```sql
-- âŒ é™·é˜±ï¼šå”¯ä¸€ç´¢å¼•å…è®¸å¤šä¸ªNULLå€¼

CREATE TABLE users (
    id INT PRIMARY KEY,
    email VARCHAR(100),
    UNIQUE KEY uniq_email (email)
);

INSERT INTO users VALUES (1, 'user1@example.com');
INSERT INTO users VALUES (2, NULL);  -- æˆåŠŸ
INSERT INTO users VALUES (3, NULL);  -- æˆåŠŸï¼ˆå…è®¸å¤šä¸ªNULLï¼‰

-- é—®é¢˜ï¼šå¦‚æœemailå¯ä»¥ä¸ºç©ºï¼Œä½†å¸Œæœ›éç©ºæ—¶å”¯ä¸€

-- âœ… è§£å†³æ–¹æ¡ˆ1ï¼šä½¿ç”¨é»˜è®¤å€¼ä»£æ›¿NULL
ALTER TABLE users MODIFY email VARCHAR(100) NOT NULL DEFAULT '';
CREATE UNIQUE INDEX uniq_email ON users(email);

INSERT INTO users VALUES (2, '');  -- æˆåŠŸ
INSERT INTO users VALUES (3, '');  -- å¤±è´¥ï¼ˆå”¯ä¸€çº¦æŸï¼‰

-- âœ… è§£å†³æ–¹æ¡ˆ2ï¼šå…è®¸NULLï¼Œä½†æ·»åŠ æ£€æŸ¥
-- MySQL 5.7ä¸æ”¯æŒå‡½æ•°ç´¢å¼•ï¼ŒMySQL 8.0+å¯ä»¥ï¼š
-- CREATE UNIQUE INDEX uniq_email ON users((IFNULL(email, '')));

-- âœ… è§£å†³æ–¹æ¡ˆ3ï¼šåº”ç”¨å±‚æ£€æŸ¥
-- æ’å…¥å‰æ£€æŸ¥emailæ˜¯å¦å·²å­˜åœ¨
```

---

## äºŒã€ç±»å‹è½¬æ¢é™·é˜±

### 2.1 éšå¼ç±»å‹è½¬æ¢

```sql
-- âŒ é™·é˜±ï¼šå­—ç¬¦ä¸²ä¸æ•°å­—æ¯”è¾ƒå¯¼è‡´ç´¢å¼•å¤±æ•ˆ

CREATE TABLE users (
    id INT PRIMARY KEY,
    phone VARCHAR(20),
    INDEX idx_phone (phone)
);

-- âŒ phoneæ˜¯VARCHARï¼Œä½†ç”¨æ•°å­—æŸ¥è¯¢
EXPLAIN SELECT * FROM users WHERE phone = 13800138000;
-- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼Œç´¢å¼•å¤±æ•ˆï¼‰

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨å­—ç¬¦ä¸²
EXPLAIN SELECT * FROM users WHERE phone = '13800138000';
-- type: refï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰

-- âŒ é™·é˜±ï¼šæ•°å­—ä¸å­—ç¬¦ä¸²æ¯”è¾ƒ
CREATE TABLE orders (id INT PRIMARY KEY);

-- âŒ
SELECT * FROM orders WHERE id = '1';  -- å¯ä»¥å·¥ä½œï¼Œä½†ä¸æ¨è

-- âœ… æ­£ç¡®
SELECT * FROM orders WHERE id = 1;
```

### 2.2 å­—ç¬¦ä¸²ä¸æ•°å­—çš„æ¯”è¾ƒè§„åˆ™

```sql
-- MySQLå­—ç¬¦ä¸²ä¸æ•°å­—æ¯”è¾ƒï¼šå°†å­—ç¬¦ä¸²è½¬ä¸ºæ•°å­—

SELECT '10' = 10;          -- 1ï¼ˆTRUEï¼‰
SELECT '10abc' = 10;       -- 1ï¼ˆTRUEï¼Œ'10abc'è½¬ä¸º10ï¼‰
SELECT 'abc' = 0;          -- 1ï¼ˆTRUEï¼Œ'abc'è½¬ä¸º0ï¼‰
SELECT '0' = 'abc';        -- 0ï¼ˆFALSEï¼Œå­—ç¬¦ä¸²æ¯”è¾ƒï¼‰

-- âŒ é™·é˜±ç¤ºä¾‹
CREATE TABLE products (
    id INT PRIMARY KEY,
    code VARCHAR(20)
);

INSERT INTO products VALUES (1, '100'), (2, '200abc'), (3, 'abc');

-- æŸ¥è¯¢code=100çš„å•†å“
SELECT * FROM products WHERE code = 100;
-- è¿”å›2è¡Œï¼š(1, '100') å’Œ (2, '200abc')
-- '200abc'è¢«è½¬ä¸º200ï¼Œç„¶åæ¯”è¾ƒ200 = 100ï¼ˆFALSEï¼‰
-- å®é™…ä¸Šï¼š'200abc'è½¬ä¸º200ï¼Œä¸ç­‰äº100
-- é”™è¯¯ï¼šå®é™…è¿”å› (1, '100')

-- âœ… æ­£ç¡®
SELECT * FROM products WHERE code = '100';
```

### 2.3 æ—¥æœŸç±»å‹è½¬æ¢

```sql
-- âŒ é™·é˜±ï¼šæ—¥æœŸå­—ç¬¦ä¸²æ ¼å¼é”™è¯¯

-- âŒ é”™è¯¯æ ¼å¼
INSERT INTO orders (created_at) VALUES ('2024/01/15 10:30:00');  -- å¯èƒ½å¤±è´¥
INSERT INTO orders (created_at) VALUES ('15-01-2024');            -- å¯èƒ½å¤±è´¥

-- âœ… æ­£ç¡®æ ¼å¼
INSERT INTO orders (created_at) VALUES ('2024-01-15 10:30:00');
INSERT INTO orders (created_at) VALUES ('2024-01-15');

-- âŒ é™·é˜±ï¼šæ—¶åŒºé—®é¢˜
SHOW VARIABLES LIKE 'time_zone';  -- æŸ¥çœ‹æ—¶åŒº
-- +---------------+--------+
-- | Variable_name | Value  |
-- +---------------+--------+
-- | time_zone     | SYSTEM |
-- +---------------+--------+

-- æ’å…¥æ—¶é—´æˆ³
INSERT INTO orders (created_at) VALUES (NOW());
-- å¦‚æœç³»ç»Ÿæ—¶åŒºä¸åº”ç”¨æ—¶åŒºä¸ä¸€è‡´ï¼Œå¯èƒ½å¯¼è‡´æ—¶é—´é”™è¯¯

-- âœ… è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€ä½¿ç”¨UTCæ—¶åŒº
SET time_zone = '+00:00';
```

---

## ä¸‰ã€å­—ç¬¦ç¼–ç é™·é˜±

### 3.1 å­—ç¬¦é›†ä¸ä¸€è‡´

```sql
-- âŒ é™·é˜±ï¼šè¡¨å­—ç¬¦é›†ä¸è¿æ¥å­—ç¬¦é›†ä¸ä¸€è‡´

-- è¡¨ä½¿ç”¨utf8mb4
CREATE TABLE users (
    id INT PRIMARY KEY,
    username VARCHAR(50)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- è¿æ¥ä½¿ç”¨latin1
-- SET NAMES latin1;

-- æ’å…¥ä¸­æ–‡
INSERT INTO users (id, username) VALUES (1, 'å¼ ä¸‰');
-- å¯èƒ½äº§ç”Ÿä¹±ç 

-- âœ… è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€å­—ç¬¦é›†
-- 1. å»ºè¡¨æ—¶æŒ‡å®šutf8mb4
CREATE TABLE users (...) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. è¿æ¥æ—¶æŒ‡å®šutf8mb4
-- Python
import pymysql
conn = pymysql.connect(
    host='localhost',
    user='root',
    password='password',
    database='test',
    charset='utf8mb4'  -- æŒ‡å®šå­—ç¬¦é›†
)

-- 3. æŸ¥çœ‹å­—ç¬¦é›†
SHOW VARIABLES LIKE 'character%';
```

### 3.2 utf8 vs utf8mb4

```sql
-- âŒ é™·é˜±ï¼šutf8ä¸æ”¯æŒemoji

-- è¡¨ä½¿ç”¨utf8
CREATE TABLE posts (
    id INT PRIMARY KEY,
    content TEXT
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- æ’å…¥emoji
INSERT INTO posts (id, content) VALUES (1, 'ä»Šå¤©å¤©æ°”ä¸é”™ğŸ˜Š');
-- é”™è¯¯ï¼šIncorrect string value: '\xF0\x9F\x98\x8A'

-- âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨utf8mb4
CREATE TABLE posts (
    id INT PRIMARY KEY,
    content TEXT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

INSERT INTO posts (id, content) VALUES (1, 'ä»Šå¤©å¤©æ°”ä¸é”™ğŸ˜Š');  -- æˆåŠŸ

-- ä¿®æ”¹å·²æœ‰è¡¨
ALTER TABLE posts CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 3.3 æ’åºè§„åˆ™é™·é˜±

```sql
-- âŒ é™·é˜±ï¼šä¸åŒæ’åºè§„åˆ™çš„æ¯”è¾ƒ

-- utf8mb4_general_ciï¼šä¸åŒºåˆ†å¤§å°å†™
-- utf8mb4_binï¼šåŒºåˆ†å¤§å°å†™

CREATE TABLE test1 (
    name VARCHAR(50)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

INSERT INTO test1 VALUES ('ABC'), ('abc'), ('Abc');

SELECT * FROM test1 WHERE name = 'abc';
-- è¿”å›3è¡Œï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰

SELECT * FROM test1 WHERE name = 'abc' COLLATE utf8mb4_bin;
-- è¿”å›1è¡Œï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰

-- âœ… å»ºè®®ï¼š
-- 1. ä¸€èˆ¬æƒ…å†µä½¿ç”¨utf8mb4_unicode_ciï¼ˆæ ‡å‡†æ’åºï¼‰
-- 2. éœ€è¦åŒºåˆ†å¤§å°å†™æ—¶ä½¿ç”¨utf8mb4_bin
-- 3. åŒä¸€æ•°æ®åº“ä½¿ç”¨ç»Ÿä¸€æ’åºè§„åˆ™
```

---

## å››ã€äº‹åŠ¡å’Œé”é™·é˜±

### 4.1 è‡ªåŠ¨æäº¤é™·é˜±

```sql
-- âŒ é™·é˜±ï¼šå¿˜è®°å…³é—­è‡ªåŠ¨æäº¤

-- autocommité»˜è®¤ä¸º1ï¼ˆå¼€å¯ï¼‰
SHOW VARIABLES LIKE 'autocommit';

-- ä»¥ä¸ºæ˜¯äº‹åŠ¡ï¼Œå®é™…æ¯æ¡SQLéƒ½è‡ªåŠ¨æäº¤
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;  -- è‡ªåŠ¨æäº¤
UPDATE accounts SET balance = balance + 100 WHERE id = 2;  -- è‡ªåŠ¨æäº¤
COMMIT;  -- æ— æ•ˆ

-- å¦‚æœç¬¬2æ¡SQLå¤±è´¥ï¼Œç¬¬1æ¡å·²ç»æäº¤ï¼Œæ•°æ®ä¸ä¸€è‡´ï¼

-- âœ… è§£å†³æ–¹æ¡ˆ1ï¼šæ˜¾å¼å¼€å¯äº‹åŠ¡
START TRANSACTION;  -- æˆ– BEGIN
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;  -- æˆ– ROLLBACK

-- âœ… è§£å†³æ–¹æ¡ˆ2ï¼šå…³é—­è‡ªåŠ¨æäº¤ï¼ˆæ•´ä¸ªä¼šè¯ï¼‰
SET autocommit = 0;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
COMMIT;
```

### 4.2 æ­»é”é™·é˜±

```sql
-- âŒ é™·é˜±ï¼šä¸åŒé¡ºåºåŠ é”å¯¼è‡´æ­»é”

-- äº‹åŠ¡1ï¼š
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;  -- é”ä½id=1
-- ... ä¸šåŠ¡é€»è¾‘ ...
UPDATE accounts SET balance = balance + 100 WHERE id = 2;  -- ç­‰å¾…id=2çš„é”
COMMIT;

-- äº‹åŠ¡2ï¼ˆåŒæ—¶æ‰§è¡Œï¼‰ï¼š
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 2;  -- é”ä½id=2
-- ... ä¸šåŠ¡é€»è¾‘ ...
UPDATE accounts SET balance = balance + 100 WHERE id = 1;  -- ç­‰å¾…id=1çš„é”ï¼ˆæ­»é”ï¼ï¼‰
COMMIT;

-- âœ… è§£å†³æ–¹æ¡ˆï¼šç»Ÿä¸€åŠ é”é¡ºåº
-- äº‹åŠ¡1å’Œäº‹åŠ¡2éƒ½æŒ‰idé¡ºåºåŠ é”
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;  -- å…ˆé”id=1
UPDATE accounts SET balance = balance + 100 WHERE id = 2;  -- å†é”id=2
COMMIT;

-- æŸ¥çœ‹æ­»é”æ—¥å¿—
SHOW ENGINE INNODB STATUS;
-- æŸ¥çœ‹LATEST DETECTED DEADLOCKéƒ¨åˆ†
```

### 4.3 é•¿äº‹åŠ¡é™·é˜±

```sql
-- âŒ é™·é˜±ï¼šäº‹åŠ¡æ—¶é—´è¿‡é•¿

BEGIN;

-- 1. æŸ¥è¯¢æ•°æ®
SELECT * FROM users WHERE id = 1 FOR UPDATE;

-- 2. å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆè€—æ—¶ï¼‰
-- ... è°ƒç”¨å¤–éƒ¨API ...
-- ... å¤æ‚è®¡ç®— ...
-- ... ç­‰å¾…ç”¨æˆ·è¾“å…¥ ...

-- 3. æ›´æ–°æ•°æ®
UPDATE users SET balance = balance - 100 WHERE id = 1;

COMMIT;

-- é—®é¢˜ï¼š
-- 1. é”æ—¶é—´è¿‡é•¿ï¼Œé˜»å¡å…¶ä»–äº‹åŠ¡
-- 2. å ç”¨è¿æ¥èµ„æº
-- 3. å¯èƒ½å¯¼è‡´æ­»é”

-- âœ… è§£å†³æ–¹æ¡ˆï¼šç¼©çŸ­äº‹åŠ¡æ—¶é—´
-- 1. å…ˆå®Œæˆä¸šåŠ¡é€»è¾‘
-- ... å¤æ‚è®¡ç®— ...
-- ... è°ƒç”¨å¤–éƒ¨API ...

-- 2. å¼€å¯äº‹åŠ¡ï¼Œå¿«é€Ÿå®Œæˆæ•°æ®åº“æ“ä½œ
BEGIN;
SELECT * FROM users WHERE id = 1 FOR UPDATE;
UPDATE users SET balance = balance - 100 WHERE id = 1;
COMMIT;

-- æ—¶é—´ä»å‡ ç§’ç¼©çŸ­åˆ°å‡ æ¯«ç§’
```

### 4.4 å¹»è¯»é™·é˜±

```sql
-- âŒ é™·é˜±ï¼šREPEATABLE READéš”ç¦»çº§åˆ«ä¸‹çš„å¹»è¯»

-- äº‹åŠ¡1ï¼š
BEGIN;
SELECT * FROM users WHERE age > 18;  -- è¿”å›10è¡Œ

-- äº‹åŠ¡2ï¼ˆåŒæ—¶æ‰§è¡Œï¼‰ï¼š
BEGIN;
INSERT INTO users (name, age) VALUES ('zhangsan', 20);
COMMIT;

-- äº‹åŠ¡1ç»§ç»­ï¼š
SELECT * FROM users WHERE age > 18;  -- è¿˜æ˜¯è¿”å›10è¡Œï¼ˆå¯é‡å¤è¯»ï¼‰
UPDATE users SET status = 1 WHERE age > 18;  -- æ›´æ–°äº†11è¡Œï¼ˆå¹»è¯»ï¼ï¼‰
SELECT * FROM users WHERE age > 18;  -- è¿”å›11è¡Œ

-- âœ… è§£å†³æ–¹æ¡ˆ1ï¼šä½¿ç”¨SERIALIZABLEéš”ç¦»çº§åˆ«
SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;
BEGIN;
SELECT * FROM users WHERE age > 18;  -- é”ä½èŒƒå›´
-- äº‹åŠ¡2çš„INSERTä¼šè¢«é˜»å¡
COMMIT;

-- âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨FOR UPDATEåŠ é”
BEGIN;
SELECT * FROM users WHERE age > 18 FOR UPDATE;  -- èŒƒå›´é”
-- äº‹åŠ¡2çš„INSERTä¼šè¢«é˜»å¡
COMMIT;
```

---

## äº”ã€æ•°æ®ä¸¢å¤±é™·é˜±

### 5.1 TRUNCATEæ— æ³•å›æ»š

```sql
-- âŒ é™·é˜±ï¼šTRUNCATEæ— æ³•å›æ»š

BEGIN;
TRUNCATE TABLE users;  -- æ¸…ç©ºè¡¨
-- å‘ç°æ“ä½œé”™è¯¯ï¼Œæƒ³å›æ»š
ROLLBACK;  -- æ— æ•ˆï¼æ•°æ®å·²ä¸¢å¤±

-- TRUNCATE vs DELETEï¼š
-- TRUNCATEï¼šDDLè¯­å¥ï¼Œä¸è®°å½•æ—¥å¿—ï¼Œæ— æ³•å›æ»šï¼Œå¿«
-- DELETEï¼šDMLè¯­å¥ï¼Œè®°å½•æ—¥å¿—ï¼Œå¯ä»¥å›æ»šï¼Œæ…¢

-- âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨DELETEä»£æ›¿TRUNCATE
BEGIN;
DELETE FROM users;  -- å¯ä»¥å›æ»š
ROLLBACK;  -- æœ‰æ•ˆ
```

### 5.2 UPDATEä¸åŠ WHERE

```sql
-- âŒ é™·é˜±ï¼šå¿˜è®°WHEREæ¡ä»¶

-- æœ¬æ„ï¼šæ›´æ–°id=1çš„ç”¨æˆ·
UPDATE users SET status = 0;  -- å¿˜è®°WHEREï¼Œæ›´æ–°äº†æ‰€æœ‰ç”¨æˆ·ï¼

-- âœ… è§£å†³æ–¹æ¡ˆ1ï¼šå…ˆSELECTç¡®è®¤
SELECT * FROM users WHERE id = 1;  -- ç¡®è®¤è¦æ›´æ–°çš„æ•°æ®
UPDATE users SET status = 0 WHERE id = 1;

-- âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨äº‹åŠ¡ä¿æŠ¤
BEGIN;
UPDATE users SET status = 0 WHERE id = 1;
SELECT * FROM users WHERE id = 1;  -- æ£€æŸ¥ç»“æœ
-- å¦‚æœä¸å¯¹ï¼ŒROLLBACKï¼›å¦‚æœæ­£ç¡®ï¼ŒCOMMIT

-- âœ… è§£å†³æ–¹æ¡ˆ3ï¼šå¼€å¯å®‰å…¨æ¨¡å¼
SET sql_safe_updates = 1;
-- å¼€å¯åï¼ŒUPDATE/DELETEå¿…é¡»æœ‰WHEREä¸”WHEREåŒ…å«ä¸»é”®æˆ–ç´¢å¼•åˆ—
```

### 5.3 è¯¯åˆ æ•°æ®æ¢å¤

```sql
-- âŒ é™·é˜±ï¼šDELETEåæ‰å‘ç°åˆ é”™äº†

-- âœ… è§£å†³æ–¹æ¡ˆ1ï¼šè½¯åˆ é™¤ï¼ˆæ¨èï¼‰
ALTER TABLE users ADD COLUMN deleted_at DATETIME DEFAULT NULL;

-- "åˆ é™¤"æ•°æ®
UPDATE users SET deleted_at = NOW() WHERE id = 1;

-- æŸ¥è¯¢æ—¶è¿‡æ»¤
SELECT * FROM users WHERE deleted_at IS NULL;

-- æ¢å¤æ•°æ®
UPDATE users SET deleted_at = NULL WHERE id = 1;

-- âœ… è§£å†³æ–¹æ¡ˆ2ï¼šbinlogæ¢å¤
-- 1. æŸ¥çœ‹binlog
SHOW BINARY LOGS;

-- 2. å¯¼å‡ºbinlog
mysqlbinlog --start-datetime='2024-01-15 10:00:00' \
            --stop-datetime='2024-01-15 10:30:00' \
            mysql-bin.000001 > restore.sql

-- 3. ç¼–è¾‘restore.sqlï¼Œæ‰¾åˆ°è¯¯åˆ çš„SQLï¼Œæ”¹ä¸ºINSERT

-- 4. æ‰§è¡Œæ¢å¤
mysql -uroot -p < restore.sql

-- âœ… è§£å†³æ–¹æ¡ˆ3ï¼šä»å¤‡ä»½æ¢å¤
-- 1. æ‰¾åˆ°æœ€è¿‘çš„å¤‡ä»½
-- 2. æ¢å¤å¤‡ä»½åˆ°ä¸´æ—¶åº“
-- 3. ä»ä¸´æ—¶åº“å¯¼å‡ºéœ€è¦çš„æ•°æ®
-- 4. å¯¼å…¥åˆ°ç”Ÿäº§åº“
```

---

## å…­ã€æŸ¥è¯¢é™·é˜±

### 6.1 LIMITåç§»é‡é™·é˜±

```sql
-- âŒ é™·é˜±ï¼šLIMITæ·±åˆ†é¡µæ€§èƒ½å·®

-- ç¬¬1é¡µï¼šå¿«
SELECT * FROM users ORDER BY id LIMIT 0, 20;
-- æ‰«æ20è¡Œ

-- ç¬¬100é¡µï¼šæ…¢
SELECT * FROM users ORDER BY id LIMIT 2000, 20;
-- æ‰«æ2020è¡Œï¼Œè¿”å›20è¡Œ

-- ç¬¬10000é¡µï¼šææ…¢
SELECT * FROM users ORDER BY id LIMIT 200000, 20;
-- æ‰«æ200020è¡Œï¼Œè¿”å›20è¡Œ

-- âœ… è§£å†³æ–¹æ¡ˆï¼šå»¶è¿Ÿå…³è”æˆ–æ¸¸æ ‡åˆ†é¡µï¼ˆè§19ç« ï¼‰
```

### 6.2 GROUP BYé™·é˜±

```sql
-- âŒ é™·é˜±ï¼šGROUP BYè¯­ä¹‰ä¸æ˜ç¡®

-- MySQL 5.7é»˜è®¤ï¼šONLY_FULL_GROUP_BYæ¨¡å¼
-- è¦æ±‚ï¼šSELECTçš„éèšåˆåˆ—å¿…é¡»åœ¨GROUP BYä¸­

-- âŒ é”™è¯¯
SELECT user_id, username, COUNT(*) AS order_count
FROM orders
GROUP BY user_id;
-- é”™è¯¯ï¼šExpression #2 of SELECT list is not in GROUP BY clause

-- âœ… æ­£ç¡®æ–¹æ¡ˆ1ï¼šæ·»åŠ åˆ°GROUP BY
SELECT user_id, username, COUNT(*) AS order_count
FROM orders
GROUP BY user_id, username;

-- âœ… æ­£ç¡®æ–¹æ¡ˆ2ï¼šä½¿ç”¨èšåˆå‡½æ•°
SELECT user_id, MAX(username) AS username, COUNT(*) AS order_count
FROM orders
GROUP BY user_id;

-- âœ… æ­£ç¡®æ–¹æ¡ˆ3ï¼šä½¿ç”¨ANY_VALUEï¼ˆMySQL 5.7+ï¼‰
SELECT user_id, ANY_VALUE(username) AS username, COUNT(*) AS order_count
FROM orders
GROUP BY user_id;
```

### 6.3 JOINç±»å‹æ··æ·†

```sql
-- âŒ é™·é˜±ï¼šLEFT JOINä½¿ç”¨ä¸å½“

-- æœŸæœ›ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·åŠå…¶è®¢å•æ•°
SELECT u.id, u.username, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id;

-- é—®é¢˜ï¼šå¦‚æœWHEREæ¡ä»¶å†™åœ¨ONä¹‹å¤–
SELECT u.id, u.username, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
WHERE o.status = 2  -- âŒ é”™è¯¯ï¼šå˜æˆäº†INNER JOIN
GROUP BY u.id;

-- âœ… æ­£ç¡®ï¼šWHEREæ¡ä»¶å†™åœ¨ONä¸­
SELECT u.id, u.username, COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id AND o.status = 2
GROUP BY u.id;

-- æˆ–ä½¿ç”¨å­æŸ¥è¯¢
SELECT u.id, u.username, IFNULL(t.order_count, 0) AS order_count
FROM users u
LEFT JOIN (
    SELECT user_id, COUNT(*) AS order_count
    FROM orders
    WHERE status = 2
    GROUP BY user_id
) t ON u.id = t.user_id;
```

---

## ä¸ƒã€æ€§èƒ½é™·é˜±

### 7.1 ORå¯¼è‡´ç´¢å¼•å¤±æ•ˆ

```sql
-- âŒ é™·é˜±ï¼šORæ¡ä»¶å¯èƒ½å¯¼è‡´ç´¢å¼•å¤±æ•ˆ

CREATE TABLE users (
    id INT PRIMARY KEY,
    username VARCHAR(50),
    email VARCHAR(100),
    INDEX idx_username (username),
    INDEX idx_email (email)
);

-- âŒ ORå¯èƒ½ä¸ä½¿ç”¨ç´¢å¼•
EXPLAIN SELECT * FROM users
WHERE username = 'zhangsan' OR email = 'zhangsan@example.com';
-- type: ALL æˆ– index_merge

-- âœ… è§£å†³æ–¹æ¡ˆï¼šæ”¹å†™ä¸ºUNION
EXPLAIN
SELECT * FROM users WHERE username = 'zhangsan'
UNION
SELECT * FROM users WHERE email = 'zhangsan@example.com';
-- ä¸¤ä¸ªæŸ¥è¯¢éƒ½ä½¿ç”¨ç´¢å¼•
```

### 7.2 éšå¼ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ

```sql
-- âŒ é™·é˜±ï¼šå­—æ®µç±»å‹ä¸æŸ¥è¯¢å€¼ç±»å‹ä¸ä¸€è‡´

CREATE TABLE users (
    id INT PRIMARY KEY,
    phone VARCHAR(20),
    INDEX idx_phone (phone)
);

-- âŒ phoneæ˜¯VARCHARï¼ŒæŸ¥è¯¢ç”¨INT
EXPLAIN SELECT * FROM users WHERE phone = 13800138000;
-- type: ALLï¼ˆç´¢å¼•å¤±æ•ˆï¼‰

-- âœ… ä½¿ç”¨å­—ç¬¦ä¸²
EXPLAIN SELECT * FROM users WHERE phone = '13800138000';
-- type: refï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
```

### 7.3 å‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆ

```sql
-- âŒ é™·é˜±ï¼šåœ¨WHEREä¸­å¯¹ç´¢å¼•åˆ—ä½¿ç”¨å‡½æ•°

CREATE INDEX idx_created_at ON orders(created_at);

-- âŒ ä½¿ç”¨å‡½æ•°ï¼Œç´¢å¼•å¤±æ•ˆ
EXPLAIN SELECT * FROM orders WHERE YEAR(created_at) = 2024;
-- type: ALL

-- âœ… æ”¹å†™ä¸ºèŒƒå›´æŸ¥è¯¢
EXPLAIN SELECT * FROM orders
WHERE created_at >= '2024-01-01' AND created_at < '2025-01-01';
-- type: rangeï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
```

---

## å…«ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **NULLå€¼é™·é˜±**ï¼š
   - ä½¿ç”¨IS NULL/IS NOT NULL
   - æ³¨æ„NOT INä¸NULL
   - æ³¨æ„å”¯ä¸€ç´¢å¼•ä¸NULL

2. **ç±»å‹è½¬æ¢é™·é˜±**ï¼š
   - é¿å…éšå¼ç±»å‹è½¬æ¢
   - æ³¨æ„å­—ç¬¦ä¸²ä¸æ•°å­—æ¯”è¾ƒ
   - ç»Ÿä¸€æ—¥æœŸæ ¼å¼

3. **å­—ç¬¦ç¼–ç é™·é˜±**ï¼š
   - ä½¿ç”¨utf8mb4
   - ç»Ÿä¸€å­—ç¬¦é›†å’Œæ’åºè§„åˆ™
   - æ³¨æ„emojiæ”¯æŒ

4. **äº‹åŠ¡å’Œé”é™·é˜±**ï¼š
   - å…³é—­è‡ªåŠ¨æäº¤
   - ç»Ÿä¸€åŠ é”é¡ºåº
   - ç¼©çŸ­äº‹åŠ¡æ—¶é—´

5. **æ•°æ®ä¸¢å¤±é™·é˜±**ï¼š
   - ä½¿ç”¨è½¯åˆ é™¤
   - ä½¿ç”¨äº‹åŠ¡ä¿æŠ¤
   - å®šæœŸå¤‡ä»½

6. **æŸ¥è¯¢é™·é˜±**ï¼š
   - æ·±åˆ†é¡µä¼˜åŒ–
   - GROUP BYè§„èŒƒ
   - LEFT JOINä½¿ç”¨

7. **æ€§èƒ½é™·é˜±**ï¼š
   - ORæ”¹å†™ä¸ºUNION
   - é¿å…éšå¼ç±»å‹è½¬æ¢
   - é¿å…å‡½æ•°æ“ä½œç´¢å¼•åˆ—

### é¿å…é™·é˜±çš„å»ºè®®

1. âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
2. âœ… å¼€å¯sql_safe_updates
3. âœ… ä½¿ç”¨äº‹åŠ¡ä¿æŠ¤
4. âœ… ä½¿ç”¨EXPLAINåˆ†æ
5. âœ… å®šæœŸå¤‡ä»½æ•°æ®
6. âœ… ä»£ç å®¡æŸ¥
7. âœ… æµ‹è¯•ç¯å¢ƒéªŒè¯

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… è¯†åˆ«å¸¸è§é™·é˜±
- âœ… é¿å…æ•°æ®ä¸¢å¤±
- âœ… è§£å†³æ€§èƒ½é—®é¢˜
- âœ… å¤„ç†äº‹åŠ¡å’Œé”
- âœ… ç¼–å†™å®‰å…¨çš„SQL

ä¸‹ä¸€èŠ‚ï¼š[25-æ•°æ®åº“è®¾è®¡è¯„å®¡æ¸…å•](./25-æ•°æ®åº“è®¾è®¡è¯„å®¡æ¸…å•.md)
