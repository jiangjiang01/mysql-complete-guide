# 21-å†™å…¥ä¼˜åŒ–å®æˆ˜

> æŒæ¡INSERTã€UPDATEã€DELETEä¼˜åŒ–æŠ€å·§ï¼Œæå‡å†™å…¥æ€§èƒ½

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- ä¼˜åŒ–INSERTæ€§èƒ½
- ä¼˜åŒ–UPDATEæ€§èƒ½
- ä¼˜åŒ–DELETEæ€§èƒ½
- ä¼˜åŒ–æ‰¹é‡æ“ä½œ
- ä¼˜åŒ–äº‹åŠ¡å¤„ç†
- å‡å°‘é”å†²çª
- ä¼˜åŒ–å¤§æ•°æ®å¯¼å…¥

---

## ä¸€ã€INSERTä¼˜åŒ–

### 1.1 æ‰¹é‡INSERT

```sql
-- âŒ æ…¢ï¼šé€æ¡INSERT
INSERT INTO users (username, email) VALUES ('user1', 'user1@example.com');
INSERT INTO users (username, email) VALUES ('user2', 'user2@example.com');
INSERT INTO users (username, email) VALUES ('user3', 'user3@example.com');
-- é—®é¢˜ï¼š
-- 1. æ¯æ¡SQLéƒ½æ˜¯ä¸€æ¬¡ç½‘ç»œå¾€è¿”
-- 2. æ¯æ¡SQLéƒ½æ˜¯ä¸€æ¬¡äº‹åŠ¡æäº¤
-- 3. æ¯æ¬¡éƒ½è¦è§£æSQL

-- âœ… å¿«ï¼šæ‰¹é‡INSERTï¼ˆæ¨èï¼‰
INSERT INTO users (username, email) VALUES
('user1', 'user1@example.com'),
('user2', 'user2@example.com'),
('user3', 'user3@example.com');
-- æ€§èƒ½æå‡ï¼š10-100å€

-- æ³¨æ„äº‹é¡¹ï¼š
-- 1. å•æ¬¡INSERTä¸è¦è¶…è¿‡1000-5000è¡Œ
-- 2. max_allowed_packeté™åˆ¶ï¼šé»˜è®¤4MB
SHOW VARIABLES LIKE 'max_allowed_packet';
SET GLOBAL max_allowed_packet = 16777216;  -- 16MB

-- 3. åˆ†æ‰¹æ’å…¥ï¼ˆæ¯æ‰¹1000è¡Œï¼‰
INSERT INTO users (username, email) VALUES
('user1', 'user1@example.com'),
...  -- å…±1000è¡Œ
('user1000', 'user1000@example.com');

INSERT INTO users (username, email) VALUES
('user1001', 'user1001@example.com'),
...  -- åˆ1000è¡Œ
('user2000', 'user2000@example.com');
```

### 1.2 ç¦ç”¨è‡ªåŠ¨æäº¤

```sql
-- âŒ è‡ªåŠ¨æäº¤ï¼šæ¯æ¡INSERTéƒ½æ˜¯ä¸€æ¬¡æäº¤
-- autocommit = 1ï¼ˆé»˜è®¤ï¼‰
INSERT INTO users (username) VALUES ('user1');  -- è‡ªåŠ¨æäº¤
INSERT INTO users (username) VALUES ('user2');  -- è‡ªåŠ¨æäº¤

-- âœ… æ‰‹åŠ¨äº‹åŠ¡ï¼šæ‰¹é‡æäº¤
SET autocommit = 0;

INSERT INTO users (username) VALUES ('user1');
INSERT INTO users (username) VALUES ('user2');
INSERT INTO users (username) VALUES ('user3');
-- ... æ’å…¥1000è¡Œ

COMMIT;  -- ä¸€æ¬¡æäº¤

SET autocommit = 1;  -- æ¢å¤è‡ªåŠ¨æäº¤

-- æ€§èƒ½æå‡ï¼š10å€ä»¥ä¸Š
```

### 1.3 å»¶è¿Ÿç´¢å¼•æ›´æ–°

```sql
-- æ‰¹é‡æ’å…¥æ—¶ï¼Œå¯ä»¥å…ˆåˆ é™¤ç´¢å¼•ï¼Œæ’å…¥å®Œæˆåå†åˆ›å»º

-- 1. åˆ é™¤ç´¢å¼•ï¼ˆä¿ç•™ä¸»é”®ï¼‰
ALTER TABLE users DROP INDEX idx_username;
ALTER TABLE users DROP INDEX idx_email;

-- 2. æ‰¹é‡æ’å…¥
INSERT INTO users (username, email) VALUES
('user1', 'user1@example.com'),
('user2', 'user2@example.com'),
...
('user100000', 'user100000@example.com');

-- 3. é‡å»ºç´¢å¼•
ALTER TABLE users ADD INDEX idx_username (username);
ALTER TABLE users ADD INDEX idx_email (email);

-- æ³¨æ„ï¼š
-- 1. ä»…é€‚ç”¨äºå¤§æ‰¹é‡æ’å…¥ï¼ˆ10ä¸‡+ï¼‰
-- 2. æ’å…¥æœŸé—´æ— æ³•ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢
-- 3. é‡å»ºç´¢å¼•éœ€è¦æ—¶é—´
```

### 1.4 INSERTä¼˜åŒ–æŠ€å·§

```sql
-- âœ… æŠ€å·§1ï¼šä½¿ç”¨INSERT IGNOREé¿å…é‡å¤é”®é”™è¯¯
INSERT IGNORE INTO users (username, email) VALUES
('user1', 'user1@example.com'),
('user1', 'user1@example.com');  -- é‡å¤ï¼Œè‡ªåŠ¨è·³è¿‡
-- ä¸ä¼šæŠ¥é”™ï¼Œåªæ’å…¥1æ¡

-- âœ… æŠ€å·§2ï¼šä½¿ç”¨REPLACEï¼ˆå…ˆåˆ é™¤åæ’å…¥ï¼‰
REPLACE INTO users (id, username, email) VALUES
(1, 'user1', 'user1@example.com');
-- å¦‚æœid=1å­˜åœ¨ï¼Œå…ˆåˆ é™¤å†æ’å…¥

-- âœ… æŠ€å·§3ï¼šä½¿ç”¨ON DUPLICATE KEY UPDATE
INSERT INTO users (username, email) VALUES
('user1', 'user1@example.com')
ON DUPLICATE KEY UPDATE
    email = VALUES(email),
    updated_at = NOW();
-- å¦‚æœusernameå·²å­˜åœ¨ï¼Œæ›´æ–°email

-- âœ… æŠ€å·§4ï¼šé¢„å…ˆæ’åºï¼ˆInnoDBï¼‰
-- InnoDBæŒ‰ä¸»é”®é¡ºåºå­˜å‚¨ï¼Œæ’å…¥æœ‰åºæ•°æ®æ›´å¿«
INSERT INTO users (id, username) VALUES
(1, 'user1'),
(2, 'user2'),
(3, 'user3')
ORDER BY id;  -- æŒ‰ä¸»é”®æ’åº

-- âœ… æŠ€å·§5ï¼šç¦ç”¨å”¯ä¸€æ£€æŸ¥ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SET unique_checks = 0;
-- æ‰¹é‡æ’å…¥
INSERT INTO users ...;
SET unique_checks = 1;

-- âœ… æŠ€å·§6ï¼šç¦ç”¨å¤–é”®æ£€æŸ¥ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
SET foreign_key_checks = 0;
-- æ‰¹é‡æ’å…¥
INSERT INTO orders ...;
SET foreign_key_checks = 1;
```

---

## äºŒã€UPDATEä¼˜åŒ–

### 2.1 é¿å…å…¨è¡¨UPDATE

```sql
-- âŒ å±é™©ï¼šå…¨è¡¨UPDATE
UPDATE users SET status = 1;
-- é”ä½æ•´ä¸ªè¡¨ï¼Œæ€§èƒ½æå·®

-- âœ… ä¼˜åŒ–ï¼šå¸¦WHEREæ¡ä»¶
UPDATE users SET status = 1
WHERE id IN (1, 2, 3);

-- âœ… æ›´ä¼˜ï¼šåˆ†æ‰¹UPDATE
UPDATE users SET status = 1
WHERE id BETWEEN 1 AND 1000;

UPDATE users SET status = 1
WHERE id BETWEEN 1001 AND 2000;
```

### 2.2 æ‰¹é‡UPDATE

```sql
-- âŒ æ…¢ï¼šé€æ¡UPDATE
UPDATE users SET status = 1 WHERE id = 1;
UPDATE users SET status = 1 WHERE id = 2;
UPDATE users SET status = 1 WHERE id = 3;

-- âœ… å¿«ï¼šæ‰¹é‡UPDATEï¼ˆç›¸åŒå€¼ï¼‰
UPDATE users SET status = 1
WHERE id IN (1, 2, 3);

-- âœ… æ‰¹é‡UPDATEï¼ˆä¸åŒå€¼ï¼‰
UPDATE users
SET status = CASE id
    WHEN 1 THEN 1
    WHEN 2 THEN 2
    WHEN 3 THEN 1
END,
email = CASE id
    WHEN 1 THEN 'user1@example.com'
    WHEN 2 THEN 'user2@example.com'
    WHEN 3 THEN 'user3@example.com'
END
WHERE id IN (1, 2, 3);

-- æ€§èƒ½æå‡ï¼š10å€ä»¥ä¸Š
```

### 2.3 å‡å°‘UPDATEèŒƒå›´

```sql
-- âŒ é—®é¢˜ï¼šUPDATEä¸å¿…è¦çš„è¡Œ
UPDATE users
SET status = 1, updated_at = NOW()
WHERE id IN (1, 2, 3);
-- å³ä½¿statuså·²ç»æ˜¯1ï¼Œä¹Ÿä¼šUPDATE

-- âœ… ä¼˜åŒ–ï¼šåªUPDATEéœ€è¦ä¿®æ”¹çš„è¡Œ
UPDATE users
SET status = 1, updated_at = NOW()
WHERE id IN (1, 2, 3)
AND status != 1;  -- å¢åŠ æ¡ä»¶
-- å‡å°‘ä¸å¿…è¦çš„å†™å…¥

-- æŸ¥çœ‹å½±å“è¡Œæ•°
SELECT ROW_COUNT();  -- è¿”å›å®é™…UPDATEçš„è¡Œæ•°
```

### 2.4 é¿å…UPDATEç´¢å¼•åˆ—

```sql
-- âŒ æ…¢ï¼šé¢‘ç¹UPDATEç´¢å¼•åˆ—
UPDATE users SET username = 'new_username' WHERE id = 1;
-- éœ€è¦æ›´æ–°ç´¢å¼•ï¼Œæ…¢

-- âœ… å¿«ï¼šUPDATEéç´¢å¼•åˆ—
UPDATE users SET nickname = 'new_nickname' WHERE id = 1;
-- ä¸éœ€è¦æ›´æ–°ç´¢å¼•ï¼Œå¿«

-- å¦‚æœå¿…é¡»UPDATEç´¢å¼•åˆ—ï¼š
-- 1. è€ƒè™‘æ˜¯å¦çœŸçš„éœ€è¦ç´¢å¼•
-- 2. è€ƒè™‘åˆ†æ‰¹UPDATE
-- 3. ä½å³°æœŸæ‰§è¡Œ
```

### 2.5 å¤§æ‰¹é‡UPDATEä¼˜åŒ–

```sql
-- âŒ é—®é¢˜ï¼šå¤§æ‰¹é‡UPDATEé”è¡¨æ—¶é—´é•¿
UPDATE users SET status = 1
WHERE created_at < '2023-01-01';
-- å¯èƒ½é”ä½å‡ åä¸‡è¡Œ

-- âœ… ä¼˜åŒ–ï¼šåˆ†æ‰¹UPDATE
-- æ–¹æ¡ˆ1ï¼šæŒ‰ä¸»é”®åˆ†æ‰¹
UPDATE users SET status = 1
WHERE id BETWEEN 1 AND 10000
AND created_at < '2023-01-01';

UPDATE users SET status = 1
WHERE id BETWEEN 10001 AND 20000
AND created_at < '2023-01-01';

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨LIMITåˆ†æ‰¹
UPDATE users SET status = 1
WHERE created_at < '2023-01-01'
LIMIT 1000;
-- é‡å¤æ‰§è¡Œç›´åˆ°ROW_COUNT()è¿”å›0

-- Pythonç¤ºä¾‹ï¼š
while True:
    affected = db.execute("""
        UPDATE users SET status = 1
        WHERE created_at < '2023-01-01'
        LIMIT 1000
    """)
    if affected == 0:
        break
    time.sleep(0.1)  # é¿å…é”å†²çª
```

---

## ä¸‰ã€DELETEä¼˜åŒ–

### 3.1 é¿å…å…¨è¡¨DELETE

```sql
-- âŒ å±é™©ï¼šå…¨è¡¨DELETE
DELETE FROM users;
-- ææ…¢ï¼Œé”è¡¨ï¼Œè®°å½•æ—¥å¿—

-- âœ… å¦‚æœè¦æ¸…ç©ºè¡¨ï¼šä½¿ç”¨TRUNCATE
TRUNCATE TABLE users;
-- å¿«é€Ÿï¼Œä¸è®°å½•æ—¥å¿—ï¼ˆæ— æ³•å›æ»šï¼‰

-- å¯¹æ¯”ï¼š
-- DELETEï¼šé€è¡Œåˆ é™¤ï¼Œè®°å½•æ—¥å¿—ï¼Œå¯å›æ»šï¼Œè§¦å‘å™¨ç”Ÿæ•ˆ
-- TRUNCATEï¼šé‡å»ºè¡¨ï¼Œä¸è®°å½•æ—¥å¿—ï¼Œä¸å¯å›æ»šï¼Œè§¦å‘å™¨ä¸ç”Ÿæ•ˆ
```

### 3.2 åˆ†æ‰¹DELETE

```sql
-- âŒ é—®é¢˜ï¼šå¤§æ‰¹é‡DELETE
DELETE FROM users
WHERE created_at < '2023-01-01';
-- å¯èƒ½åˆ é™¤å‡ åä¸‡è¡Œï¼Œé”è¡¨æ—¶é—´é•¿

-- âœ… ä¼˜åŒ–ï¼šåˆ†æ‰¹DELETE
DELETE FROM users
WHERE created_at < '2023-01-01'
LIMIT 1000;
-- é‡å¤æ‰§è¡Œ

-- Pythonç¤ºä¾‹ï¼š
while True:
    affected = db.execute("""
        DELETE FROM users
        WHERE created_at < '2023-01-01'
        LIMIT 1000
    """)
    db.commit()
    if affected == 0:
        break
    time.sleep(0.1)  -- é¿å…é”å†²çª
```

### 3.3 ä½¿ç”¨è½¯åˆ é™¤

```sql
-- âœ… æ¨èï¼šä½¿ç”¨è½¯åˆ é™¤
UPDATE users
SET deleted_at = NOW()
WHERE id = 1;

-- æŸ¥è¯¢æ—¶è¿‡æ»¤è½¯åˆ é™¤æ•°æ®
SELECT * FROM users
WHERE deleted_at IS NULL;

-- å®šæœŸæ¸…ç†è½¯åˆ é™¤æ•°æ®ï¼ˆä½å³°æœŸï¼‰
DELETE FROM users
WHERE deleted_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
LIMIT 1000;
```

### 3.4 DELETEä¼˜åŒ–æŠ€å·§

```sql
-- âœ… æŠ€å·§1ï¼šåˆ é™¤å‰æ£€æŸ¥
SELECT COUNT(*) FROM users WHERE id IN (1, 2, 3);
-- ç¡®è®¤è¦åˆ é™¤çš„æ•°æ®é‡

-- âœ… æŠ€å·§2ï¼šä½¿ç”¨äº‹åŠ¡ä¿æŠ¤
BEGIN;
DELETE FROM users WHERE id IN (1, 2, 3);
-- æ£€æŸ¥ç»“æœ
SELECT ROW_COUNT();
-- å¦‚æœä¸å¯¹ï¼Œå¯ä»¥å›æ»š
ROLLBACK;  -- æˆ– COMMIT

-- âœ… æŠ€å·§3ï¼šå…ˆæŸ¥è¯¢å†åˆ é™¤
-- å…ˆæŸ¥è¯¢è¦åˆ é™¤çš„æ•°æ®
SELECT * FROM users WHERE created_at < '2023-01-01' LIMIT 10;
-- ç¡®è®¤æ— è¯¯åå†åˆ é™¤
DELETE FROM users WHERE id IN (1, 2, 3, ...);

-- âœ… æŠ€å·§4ï¼šé¿å…DELETEè§¦å‘å™¨
-- å¦‚æœè¡¨æœ‰DELETEè§¦å‘å™¨ï¼Œè€ƒè™‘ï¼š
-- 1. ä¸´æ—¶ç¦ç”¨è§¦å‘å™¨ï¼ˆå¦‚æœå¯ä»¥ï¼‰
-- 2. ä½¿ç”¨TRUNCATEï¼ˆä¸è§¦å‘è§¦å‘å™¨ï¼‰
-- 3. ä½å³°æœŸæ‰§è¡Œ
```

---

## å››ã€äº‹åŠ¡ä¼˜åŒ–

### 4.1 å‡å°äº‹åŠ¡ç²’åº¦

```sql
-- âŒ é—®é¢˜ï¼šäº‹åŠ¡å¤ªå¤§
BEGIN;

-- æ’å…¥10ä¸‡æ¡æ•°æ®
INSERT INTO users (username) VALUES ('user1');
INSERT INTO users (username) VALUES ('user2');
...
INSERT INTO users (username) VALUES ('user100000');

COMMIT;
-- é—®é¢˜ï¼š
-- 1. é”æ—¶é—´å¤ªé•¿
-- 2. å ç”¨å¤§é‡undo log
-- 3. å›æ»šé£é™©å¤§

-- âœ… ä¼˜åŒ–ï¼šåˆ†æ‰¹äº‹åŠ¡
-- æ¯1000æ¡ä¸€ä¸ªäº‹åŠ¡
BEGIN;
INSERT INTO users (username) VALUES ('user1'), ... ('user1000');
COMMIT;

BEGIN;
INSERT INTO users (username) VALUES ('user1001'), ... ('user2000');
COMMIT;
```

### 4.2 é¿å…é•¿äº‹åŠ¡

```sql
-- âŒ é—®é¢˜ï¼šé•¿äº‹åŠ¡
BEGIN;

-- 1. æŸ¥è¯¢æ•°æ®
SELECT * FROM users WHERE id = 1 FOR UPDATE;

-- 2. ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆè€—æ—¶ï¼‰
-- ... å¤æ‚è®¡ç®— ...
-- ... è°ƒç”¨å¤–éƒ¨API ...
-- ... ç­‰å¾…ç”¨æˆ·è¾“å…¥ ...

-- 3. æ›´æ–°æ•°æ®
UPDATE users SET balance = balance - 100 WHERE id = 1;

COMMIT;

-- é—®é¢˜ï¼š
-- 1. é”æ—¶é—´å¤ªé•¿
-- 2. é˜»å¡å…¶ä»–äº‹åŠ¡
-- 3. å¯èƒ½å¯¼è‡´æ­»é”

-- âœ… ä¼˜åŒ–ï¼šç¼©çŸ­äº‹åŠ¡æ—¶é—´
-- 1. å…ˆå®Œæˆä¸šåŠ¡é€»è¾‘
-- ... å¤æ‚è®¡ç®— ...
-- ... è°ƒç”¨å¤–éƒ¨API ...

-- 2. å¼€å¯äº‹åŠ¡ï¼Œå¿«é€Ÿå®Œæˆæ•°æ®åº“æ“ä½œ
BEGIN;
SELECT * FROM users WHERE id = 1 FOR UPDATE;
UPDATE users SET balance = balance - 100 WHERE id = 1;
COMMIT;
```

### 4.3 äº‹åŠ¡éš”ç¦»çº§åˆ«

```sql
-- æŸ¥çœ‹éš”ç¦»çº§åˆ«
SHOW VARIABLES LIKE 'transaction_isolation';
-- é»˜è®¤ï¼šREPEATABLE-READ

-- éš”ç¦»çº§åˆ«å¯¹æ¯”ï¼š
-- READ-UNCOMMITTEDï¼šæœ€ä½ï¼Œå¯èƒ½è„è¯»
-- READ-COMMITTEDï¼šé¿å…è„è¯»ï¼Œå¯èƒ½ä¸å¯é‡å¤è¯»
-- REPEATABLE-READï¼šé¿å…ä¸å¯é‡å¤è¯»ï¼ˆé»˜è®¤ï¼‰
-- SERIALIZABLEï¼šæœ€é«˜ï¼Œå®Œå…¨ä¸²è¡ŒåŒ–

-- âœ… æ ¹æ®åœºæ™¯é€‰æ‹©éš”ç¦»çº§åˆ«
-- åœºæ™¯1ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜ï¼Œè¿½æ±‚æ€§èƒ½
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
SELECT * FROM users WHERE id = 1;  -- ä¸åŠ é”
-- ...
COMMIT;

-- åœºæ™¯2ï¼šéœ€è¦ä¸¥æ ¼ä¸€è‡´æ€§
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;
BEGIN;
SELECT * FROM users WHERE id = 1 FOR UPDATE;  -- åŠ é”
-- ...
COMMIT;
```

---

## äº”ã€é”ä¼˜åŒ–

### 5.1 å‡å°‘é”å†²çª

```sql
-- âŒ é—®é¢˜ï¼šé”å†²çª
-- äº‹åŠ¡1ï¼š
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;  -- é”ä½id=1
-- ... é•¿æ—¶é—´å¤„ç† ...
COMMIT;

-- äº‹åŠ¡2ï¼š
BEGIN;
UPDATE users SET balance = balance + 100 WHERE id = 1;  -- ç­‰å¾…é”
COMMIT;

-- âœ… ä¼˜åŒ–1ï¼šç¼©çŸ­æŒé”æ—¶é—´
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;
COMMIT;  -- ç«‹å³æäº¤

-- âœ… ä¼˜åŒ–2ï¼šé¿å…é”ç­‰å¾…
-- ä½¿ç”¨SELECT ... FOR UPDATE NOWAITï¼ˆMySQL 8.0.1+ï¼‰
BEGIN;
SELECT * FROM users WHERE id = 1 FOR UPDATE NOWAIT;
-- å¦‚æœé”è¢«å ç”¨ï¼Œç«‹å³è¿”å›é”™è¯¯ï¼Œä¸ç­‰å¾…
COMMIT;

-- æˆ–ä½¿ç”¨SELECT ... FOR UPDATE SKIP LOCKEDï¼ˆMySQL 8.0.1+ï¼‰
SELECT * FROM users WHERE status = 1 FOR UPDATE SKIP LOCKED LIMIT 10;
-- è·³è¿‡å·²é”å®šçš„è¡Œ
```

### 5.2 é¿å…æ­»é”

```sql
-- âŒ æ­»é”ç¤ºä¾‹ï¼š
-- äº‹åŠ¡1ï¼š
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;  -- é”ä½id=1
UPDATE users SET balance = balance + 100 WHERE id = 2;  -- ç­‰å¾…id=2
COMMIT;

-- äº‹åŠ¡2ï¼š
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 2;  -- é”ä½id=2
UPDATE users SET balance = balance + 100 WHERE id = 1;  -- ç­‰å¾…id=1ï¼Œæ­»é”ï¼
COMMIT;

-- âœ… é¿å…æ­»é”ï¼šç»Ÿä¸€åŠ é”é¡ºåº
-- äº‹åŠ¡1å’Œäº‹åŠ¡2éƒ½æŒ‰idé¡ºåºåŠ é”
BEGIN;
UPDATE users SET balance = balance - 100 WHERE id = 1;  -- å…ˆé”id=1
UPDATE users SET balance = balance + 100 WHERE id = 2;  -- å†é”id=2
COMMIT;

-- âœ… æŸ¥çœ‹æ­»é”æ—¥å¿—
SHOW ENGINE INNODB STATUS;
-- æŸ¥çœ‹LATEST DETECTED DEADLOCKéƒ¨åˆ†

-- âœ… è®¾ç½®æ­»é”è¶…æ—¶
SHOW VARIABLES LIKE 'innodb_lock_wait_timeout';
SET SESSION innodb_lock_wait_timeout = 5;  -- 5ç§’è¶…æ—¶
```

### 5.3 è¡Œé” vs è¡¨é”

```sql
-- InnoDBé»˜è®¤ä½¿ç”¨è¡Œé”

-- âœ… è¡Œé”ï¼šé”å®šç‰¹å®šè¡Œ
UPDATE users SET status = 1 WHERE id = 1;
-- åªé”id=1è¿™ä¸€è¡Œ

-- âŒ è¡¨é”ï¼šé”å®šæ•´ä¸ªè¡¨ï¼ˆå°½é‡é¿å…ï¼‰
LOCK TABLES users WRITE;
UPDATE users SET status = 1 WHERE id = 1;
UNLOCK TABLES;

-- âš ï¸ æ³¨æ„ï¼šWHEREæ¡ä»¶æ²¡æœ‰ç´¢å¼•æ—¶ï¼Œè¡Œé”å‡çº§ä¸ºè¡¨é”
-- usernameæ²¡æœ‰ç´¢å¼•
UPDATE users SET status = 1 WHERE username = 'zhangsan';
-- é”ä½æ•´ä¸ªè¡¨ï¼

-- âœ… ä¼˜åŒ–ï¼šä¸ºWHEREå­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_username ON users(username);
UPDATE users SET status = 1 WHERE username = 'zhangsan';
-- åªé”åŒ¹é…çš„è¡Œ
```

---

## å…­ã€å¤§æ•°æ®å¯¼å…¥ä¼˜åŒ–

### 6.1 LOAD DATA INFILE

```sql
-- âœ… æœ€å¿«ï¼šä½¿ç”¨LOAD DATA INFILE
-- 1. å‡†å¤‡CSVæ–‡ä»¶
-- users.csv:
-- id,username,email
-- 1,user1,user1@example.com
-- 2,user2,user2@example.com

-- 2. å¯¼å…¥æ•°æ®
LOAD DATA INFILE '/path/to/users.csv'
INTO TABLE users
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS  -- è·³è¿‡è¡¨å¤´
(id, username, email);

-- æ€§èƒ½ï¼šæ¯”INSERTå¿«10-100å€

-- æ³¨æ„äº‹é¡¹ï¼š
-- 1. éœ€è¦FILEæƒé™
-- 2. secure_file_privé™åˆ¶
SHOW VARIABLES LIKE 'secure_file_priv';
-- åªèƒ½ä»è¯¥ç›®å½•åŠ è½½æ–‡ä»¶

-- 3. ç¦ç”¨ç´¢å¼•æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
ALTER TABLE users DISABLE KEYS;
LOAD DATA INFILE ...;
ALTER TABLE users ENABLE KEYS;
```

### 6.2 å¯¼å…¥ä¼˜åŒ–å‚æ•°

```sql
-- ä¼˜åŒ–å‚æ•°è®¾ç½®ï¼ˆä¸´æ—¶ï¼‰
SET autocommit = 0;  -- ç¦ç”¨è‡ªåŠ¨æäº¤
SET unique_checks = 0;  -- ç¦ç”¨å”¯ä¸€æ£€æŸ¥
SET foreign_key_checks = 0;  -- ç¦ç”¨å¤–é”®æ£€æŸ¥

-- å¯¼å…¥æ•°æ®
INSERT INTO users ...;

-- æ¢å¤å‚æ•°
SET autocommit = 1;
SET unique_checks = 1;
SET foreign_key_checks = 1;

-- innodb_buffer_pool_sizeï¼ˆæ°¸ä¹…é…ç½®ï¼‰
-- my.cnf:
-- [mysqld]
-- innodb_buffer_pool_size = 4G  -- è®¾ç½®ä¸ºç‰©ç†å†…å­˜çš„50-80%
```

### 6.3 å¤§è¡¨æ•°æ®è¿ç§»

```sql
-- åœºæ™¯ï¼šå°†old_usersè¡¨æ•°æ®è¿ç§»åˆ°new_users

-- âŒ æ…¢ï¼šç›´æ¥INSERT SELECT
INSERT INTO new_users SELECT * FROM old_users;
-- å¤§è¡¨å¯èƒ½å¯¼è‡´é”è¶…æ—¶

-- âœ… ä¼˜åŒ–ï¼šåˆ†æ‰¹è¿ç§»
-- æ–¹æ¡ˆ1ï¼šæŒ‰ä¸»é”®åˆ†æ‰¹
INSERT INTO new_users
SELECT * FROM old_users
WHERE id BETWEEN 1 AND 10000;

INSERT INTO new_users
SELECT * FROM old_users
WHERE id BETWEEN 10001 AND 20000;

-- æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ¸¸æ ‡
SET @last_id = 0;

-- é‡å¤æ‰§è¡Œï¼š
INSERT INTO new_users
SELECT * FROM old_users
WHERE id > @last_id
ORDER BY id
LIMIT 10000;

SELECT @last_id := MAX(id) FROM new_users;
-- ç›´åˆ°æ²¡æœ‰æ–°æ•°æ®

-- æ–¹æ¡ˆ3ï¼špt-online-schema-changeå·¥å…·
pt-online-schema-change \
  --alter "ENGINE=InnoDB" \
  --execute \
  D=your_database,t=old_users
```

---

## ä¸ƒã€å†™å…¥ä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šæ—¥å¿—è¡¨æ‰¹é‡æ’å…¥ä¼˜åŒ–

```sql
-- åœºæ™¯ï¼šæ¯ç§’æ’å…¥1000æ¡æ—¥å¿—

-- âŒ åŸå§‹æ–¹æ¡ˆï¼šé€æ¡INSERT
for log in logs:
    db.execute("INSERT INTO logs (user_id, action, ip) VALUES (%s, %s, %s)",
               (log['user_id'], log['action'], log['ip']))
-- æ€§èƒ½ï¼š1000 QPS

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šæ‰¹é‡INSERT
logs_batch = []
for log in logs:
    logs_batch.append((log['user_id'], log['action'], log['ip']))

    if len(logs_batch) >= 1000:
        db.executemany(
            "INSERT INTO logs (user_id, action, ip) VALUES (%s, %s, %s)",
            logs_batch
        )
        logs_batch = []
-- æ€§èƒ½ï¼š10000+ QPSï¼ˆæå‡10å€ï¼‰

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šå¼‚æ­¥å†™å…¥
-- 1. æ—¥å¿—å…ˆå†™å…¥é˜Ÿåˆ—ï¼ˆRedis/Kafkaï¼‰
-- 2. åå°ä»»åŠ¡æ‰¹é‡æ¶ˆè´¹
import queue

log_queue = queue.Queue()

# ç”Ÿäº§è€…ï¼š
log_queue.put(log)

# æ¶ˆè´¹è€…ï¼ˆåå°çº¿ç¨‹ï¼‰ï¼š
while True:
    logs_batch = []
    for _ in range(1000):
        try:
            log = log_queue.get(timeout=1)
            logs_batch.append(log)
        except queue.Empty:
            break

    if logs_batch:
        db.executemany("INSERT INTO logs ...", logs_batch)
        db.commit()
```

### æ¡ˆä¾‹2ï¼šç”¨æˆ·ç§¯åˆ†æ›´æ–°ä¼˜åŒ–

```sql
-- åœºæ™¯ï¼šé«˜å¹¶å‘æ›´æ–°ç”¨æˆ·ç§¯åˆ†

-- âŒ åŸå§‹æ–¹æ¡ˆï¼šç›´æ¥UPDATE
UPDATE user_points
SET points = points + 10
WHERE user_id = :user_id;
-- é—®é¢˜ï¼šé«˜å¹¶å‘ä¸‹é”å†²çªä¸¥é‡

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šå…ˆæ’å…¥æ˜ç»†ï¼Œåå¼‚æ­¥æ±‡æ€»
-- 1. å®æ—¶æ’å…¥ç§¯åˆ†æ˜ç»†ï¼ˆæ— é”ï¼‰
INSERT INTO point_logs (user_id, points, created_at)
VALUES (:user_id, 10, NOW());

-- 2. åå°ä»»åŠ¡å®šæœŸæ±‡æ€»ï¼ˆæ¯åˆ†é’Ÿï¼‰
INSERT INTO user_points (user_id, points)
SELECT user_id, SUM(points)
FROM point_logs
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 MINUTE)
AND processed = 0
GROUP BY user_id
ON DUPLICATE KEY UPDATE points = points + VALUES(points);

-- 3. æ ‡è®°å·²å¤„ç†
UPDATE point_logs
SET processed = 1
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 1 MINUTE)
AND processed = 0;

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šä½¿ç”¨Redisç¼“å­˜
-- 1. ç§¯åˆ†å˜åŠ¨å…ˆå†™å…¥Redis
HINCRBY user:points:{user_id} points 10

-- 2. å®šæœŸåŒæ­¥åˆ°MySQL
points = redis.hgetall("user:points:{user_id}")
UPDATE user_points
SET points = :points
WHERE user_id = :user_id;
```

### æ¡ˆä¾‹3ï¼šè®¢å•çŠ¶æ€æ‰¹é‡æ›´æ–°ä¼˜åŒ–

```sql
-- åœºæ™¯ï¼šæ¯å¤©å‡Œæ™¨æ›´æ–°è¶…æ—¶è®¢å•çŠ¶æ€

-- âŒ åŸå§‹æ–¹æ¡ˆï¼šä¸€æ¬¡UPDATEå…¨éƒ¨
UPDATE orders
SET status = 5, cancelled_at = NOW()
WHERE status = 1
AND created_at < DATE_SUB(NOW(), INTERVAL 30 MINUTE);
-- é—®é¢˜ï¼šå¯èƒ½é”ä½å‡ åä¸‡è¡Œ

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šåˆ†æ‰¹UPDATE + é™æµ
-- Pythonè„šæœ¬ï¼š
def cancel_timeout_orders():
    while True:
        affected = db.execute("""
            UPDATE orders
            SET status = 5, cancelled_at = NOW()
            WHERE status = 1
            AND created_at < DATE_SUB(NOW(), INTERVAL 30 MINUTE)
            LIMIT 1000
        """)
        db.commit()

        if affected == 0:
            break

        print(f"Cancelled {affected} orders")
        time.sleep(0.5)  # é™æµï¼Œé¿å…å½±å“çº¿ä¸Šä¸šåŠ¡

# å®šæ—¶ä»»åŠ¡ï¼šæ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
schedule.every(1).minutes.do(cancel_timeout_orders)
```

---

## å…«ã€å†™å…¥ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### 8.1 INSERTæ£€æŸ¥

```sql
-- âœ… æ˜¯å¦ä½¿ç”¨æ‰¹é‡INSERTï¼Ÿ
-- âœ… æ˜¯å¦ç¦ç”¨äº†è‡ªåŠ¨æäº¤ï¼Ÿ
-- âœ… å•æ¬¡INSERTè¡Œæ•°æ˜¯å¦åˆç†ï¼ˆ1000-5000ï¼‰ï¼Ÿ
-- âœ… æ˜¯å¦è€ƒè™‘ä½¿ç”¨LOAD DATA INFILEï¼Ÿ
-- âœ… å¤§æ‰¹é‡æ’å…¥æ˜¯å¦ç¦ç”¨äº†ç´¢å¼•æ£€æŸ¥ï¼Ÿ
-- âœ… æ˜¯å¦å¤„ç†äº†é‡å¤é”®é”™è¯¯ï¼ˆINSERT IGNORE / ON DUPLICATE KEY UPDATEï¼‰ï¼Ÿ
```

### 8.2 UPDATEæ£€æŸ¥

```sql
-- âœ… æ˜¯å¦é¿å…äº†å…¨è¡¨UPDATEï¼Ÿ
-- âœ… æ˜¯å¦ä½¿ç”¨æ‰¹é‡UPDATEï¼Ÿ
-- âœ… WHEREæ¡ä»¶æ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
-- âœ… æ˜¯å¦åªUPDATEå˜åŒ–çš„è¡Œï¼Ÿ
-- âœ… å¤§æ‰¹é‡UPDATEæ˜¯å¦åˆ†æ‰¹æ‰§è¡Œï¼Ÿ
-- âœ… æ˜¯å¦é¿å…é¢‘ç¹UPDATEç´¢å¼•åˆ—ï¼Ÿ
```

### 8.3 DELETEæ£€æŸ¥

```sql
-- âœ… æ˜¯å¦ä½¿ç”¨è½¯åˆ é™¤ï¼Ÿ
-- âœ… æ˜¯å¦é¿å…äº†å…¨è¡¨DELETEï¼Ÿ
-- âœ… å¤§æ‰¹é‡DELETEæ˜¯å¦åˆ†æ‰¹æ‰§è¡Œï¼Ÿ
-- âœ… WHEREæ¡ä»¶æ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
-- âœ… æ˜¯å¦åœ¨ä½å³°æœŸæ‰§è¡Œï¼Ÿ
```

### 8.4 äº‹åŠ¡æ£€æŸ¥

```sql
-- âœ… äº‹åŠ¡ç²’åº¦æ˜¯å¦åˆç†ï¼Ÿ
-- âœ… æ˜¯å¦é¿å…äº†é•¿äº‹åŠ¡ï¼Ÿ
-- âœ… æ˜¯å¦é€‰æ‹©äº†åˆé€‚çš„éš”ç¦»çº§åˆ«ï¼Ÿ
-- âœ… æ˜¯å¦ç¼©çŸ­äº†æŒé”æ—¶é—´ï¼Ÿ
-- âœ… æ˜¯å¦é¿å…äº†æ­»é”ï¼Ÿ
```

---

## ä¹ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **INSERTä¼˜åŒ–**ï¼š
   - æ‰¹é‡INSERTï¼ˆ1000-5000è¡Œï¼‰
   - ç¦ç”¨è‡ªåŠ¨æäº¤
   - LOAD DATA INFILE
   - å»¶è¿Ÿç´¢å¼•æ›´æ–°

2. **UPDATEä¼˜åŒ–**ï¼š
   - é¿å…å…¨è¡¨UPDATE
   - æ‰¹é‡UPDATE
   - å‡å°‘UPDATEèŒƒå›´
   - åˆ†æ‰¹UPDATE

3. **DELETEä¼˜åŒ–**ï¼š
   - ä½¿ç”¨è½¯åˆ é™¤
   - åˆ†æ‰¹DELETE
   - TRUNCATE vs DELETE

4. **äº‹åŠ¡ä¼˜åŒ–**ï¼š
   - å‡å°äº‹åŠ¡ç²’åº¦
   - é¿å…é•¿äº‹åŠ¡
   - åˆé€‚çš„éš”ç¦»çº§åˆ«

5. **é”ä¼˜åŒ–**ï¼š
   - å‡å°‘é”å†²çª
   - é¿å…æ­»é”
   - è¡Œé” vs è¡¨é”

6. **å¤§æ•°æ®å¯¼å…¥**ï¼š
   - LOAD DATA INFILE
   - åˆ†æ‰¹å¯¼å…¥
   - ä¼˜åŒ–å‚æ•°è®¾ç½®

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… ä¼˜åŒ–INSERTã€UPDATEã€DELETEæ€§èƒ½
- âœ… è¿›è¡Œæ‰¹é‡æ“ä½œä¼˜åŒ–
- âœ… ä¼˜åŒ–äº‹åŠ¡å¤„ç†
- âœ… å‡å°‘é”å†²çª
- âœ… ä¼˜åŒ–å¤§æ•°æ®å¯¼å…¥

ä¸‹ä¸€èŠ‚ï¼š[22-ç¼“å­˜ä¸æ¶æ„ä¼˜åŒ–](./22-ç¼“å­˜ä¸æ¶æ„ä¼˜åŒ–.md)
