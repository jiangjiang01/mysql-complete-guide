# 14-用户系统设计与实现

> 从零设计并实现一个完整的用户系统

---

## 📖 本章目标

- 设计用户表结构
- 实现用户注册功能
- 实现用户登录/登出
- 实现用户信息管理
- 实现密码管理
- 实现用户状态管理

---

## 一、用户表设计

### 1.1 核心用户表

```sql
CREATE TABLE users (
    -- 主键
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID',

    -- 登录凭证
    username VARCHAR(50) NOT NULL COMMENT '用户名',
    email VARCHAR(100) NOT NULL COMMENT '邮箱',
    phone VARCHAR(20) NOT NULL DEFAULT '' COMMENT '手机号',
    password VARCHAR(255) NOT NULL COMMENT '密码（加密）',

    -- 基本信息
    nickname VARCHAR(50) NOT NULL DEFAULT '' COMMENT '昵称',
    avatar VARCHAR(255) NOT NULL DEFAULT '' COMMENT '头像URL',
    gender TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '性别：0-未知，1-男，2-女',
    birthday DATE DEFAULT NULL COMMENT '生日',

    -- 状态字段
    status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '状态：1-正常，2-禁用',
    email_verified TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '邮箱是否验证：0-否，1-是',
    phone_verified TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '手机号是否验证：0-否，1-是',

    -- 统计字段
    login_count INT UNSIGNED NOT NULL DEFAULT 0 COMMENT '登录次数',
    last_login_at DATETIME DEFAULT NULL COMMENT '最后登录时间',
    last_login_ip VARCHAR(50) NOT NULL DEFAULT '' COMMENT '最后登录IP',

    -- 时间戳
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME DEFAULT NULL COMMENT '删除时间',

    -- 索引
    UNIQUE KEY uniq_username (username),
    UNIQUE KEY uniq_email (email),
    INDEX idx_phone (phone),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB AUTO_INCREMENT=10000 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';
```

### 1.2 用户扩展信息表

```sql
CREATE TABLE user_profiles (
    -- 主键
    user_id BIGINT UNSIGNED PRIMARY KEY COMMENT '用户ID',

    -- 扩展信息
    real_name VARCHAR(50) NOT NULL DEFAULT '' COMMENT '真实姓名',
    id_card VARCHAR(20) NOT NULL DEFAULT '' COMMENT '身份证号',

    -- 地址信息
    province VARCHAR(50) NOT NULL DEFAULT '' COMMENT '省',
    city VARCHAR(50) NOT NULL DEFAULT '' COMMENT '市',
    district VARCHAR(50) NOT NULL DEFAULT '' COMMENT '区',
    address VARCHAR(255) NOT NULL DEFAULT '' COMMENT '详细地址',

    -- 个人简介
    bio TEXT COMMENT '个人简介',

    -- 其他信息
    education VARCHAR(50) NOT NULL DEFAULT '' COMMENT '学历',
    occupation VARCHAR(100) NOT NULL DEFAULT '' COMMENT '职业',

    -- 时间戳
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 外键
    CONSTRAINT fk_user_profiles_user_id FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户扩展信息表';
```

### 1.3 用户地址表

```sql
CREATE TABLE user_addresses (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL COMMENT '用户ID',

    -- 收货人信息
    consignee VARCHAR(50) NOT NULL COMMENT '收货人',
    phone VARCHAR(20) NOT NULL COMMENT '手机号',

    -- 地址信息
    province VARCHAR(50) NOT NULL COMMENT '省',
    city VARCHAR(50) NOT NULL COMMENT '市',
    district VARCHAR(50) NOT NULL COMMENT '区',
    address VARCHAR(255) NOT NULL COMMENT '详细地址',
    zip_code VARCHAR(10) NOT NULL DEFAULT '' COMMENT '邮编',

    -- 是否默认
    is_default TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '是否默认地址：0-否，1-是',

    -- 时间戳
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,

    INDEX idx_user_id (user_id),
    INDEX idx_is_default (is_default),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户地址表';
```

---

## 二、用户注册

### 2.1 注册流程

```sql
-- 1. 检查用户名是否存在
SELECT COUNT(*) AS count
FROM users
WHERE username = :username
AND deleted_at IS NULL;
-- 如果count > 0，提示用户名已存在

-- 2. 检查邮箱是否存在
SELECT COUNT(*) AS count
FROM users
WHERE email = :email
AND deleted_at IS NULL;
-- 如果count > 0，提示邮箱已被注册

-- 3. 插入用户
INSERT INTO users (
    username,
    email,
    password,
    nickname,
    status
) VALUES (
    :username,
    :email,
    :password_hash,  -- 应用层使用bcrypt等算法加密
    :nickname,
    1  -- 正常状态
);

-- 4. 获取新用户ID
SELECT LAST_INSERT_ID() AS user_id;

-- 5. 创建用户扩展信息（可选）
INSERT INTO user_profiles (user_id)
VALUES (:user_id);
```

### 2.2 完整注册示例（Python）

```python
import bcrypt
import re

def register_user(username, email, password, nickname):
    # 1. 参数验证
    if not username or len(username) < 3 or len(username) > 50:
        raise ValueError("用户名长度必须在3-50个字符之间")

    if not re.match(r'^[a-zA-Z0-9_]+$', username):
        raise ValueError("用户名只能包含字母、数字和下划线")

    if not email or not re.match(r'^[\w\.-]+@[\w\.-]+\.\w+$', email):
        raise ValueError("邮箱格式不正确")

    if not password or len(password) < 6:
        raise ValueError("密码长度不能少于6个字符")

    # 2. 检查用户名是否存在
    sql = """
        SELECT COUNT(*) AS count
        FROM users
        WHERE username = %s AND deleted_at IS NULL
    """
    result = db.query_one(sql, (username,))
    if result['count'] > 0:
        raise ValueError("用户名已存在")

    # 3. 检查邮箱是否存在
    sql = """
        SELECT COUNT(*) AS count
        FROM users
        WHERE email = %s AND deleted_at IS NULL
    """
    result = db.query_one(sql, (email,))
    if result['count'] > 0:
        raise ValueError("邮箱已被注册")

    # 4. 密码加密
    password_hash = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())

    # 5. 插入用户
    sql = """
        INSERT INTO users (username, email, password, nickname, status)
        VALUES (%s, %s, %s, %s, 1)
    """
    db.execute(sql, (username, email, password_hash, nickname or username))

    # 6. 获取用户ID
    user_id = db.last_insert_id()

    # 7. 创建扩展信息
    sql = """
        INSERT INTO user_profiles (user_id) VALUES (%s)
    """
    db.execute(sql, (user_id,))

    return user_id
```

---

## 三、用户登录

### 3.1 用户名/邮箱登录

```sql
-- 根据用户名或邮箱查询用户
SELECT
    id,
    username,
    email,
    password,
    status,
    email_verified
FROM users
WHERE (username = :login OR email = :login)
AND deleted_at IS NULL;

-- 应用层验证密码后，更新登录信息
UPDATE users
SET
    login_count = login_count + 1,
    last_login_at = NOW(),
    last_login_ip = :ip
WHERE id = :user_id;
```

### 3.2 完整登录示例（Python）

```python
import bcrypt

def login_user(login, password, ip):
    # 1. 查询用户
    sql = """
        SELECT
            id,
            username,
            email,
            password,
            status,
            email_verified
        FROM users
        WHERE (username = %s OR email = %s)
        AND deleted_at IS NULL
    """
    user = db.query_one(sql, (login, login))

    if not user:
        raise ValueError("用户不存在")

    # 2. 检查用户状态
    if user['status'] != 1:
        raise ValueError("账号已被禁用")

    # 3. 验证密码
    if not bcrypt.checkpw(password.encode('utf-8'), user['password'].encode('utf-8')):
        raise ValueError("密码错误")

    # 4. 更新登录信息
    sql = """
        UPDATE users
        SET
            login_count = login_count + 1,
            last_login_at = NOW(),
            last_login_ip = %s
        WHERE id = %s
    """
    db.execute(sql, (ip, user['id']))

    # 5. 生成Token（JWT）
    token = generate_jwt_token({
        'user_id': user['id'],
        'username': user['username'],
        'email': user['email']
    })

    return {
        'user_id': user['id'],
        'username': user['username'],
        'email': user['email'],
        'token': token
    }
```

### 3.3 手机号验证码登录

```sql
-- 验证码表
CREATE TABLE sms_codes (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    phone VARCHAR(20) NOT NULL COMMENT '手机号',
    code VARCHAR(10) NOT NULL COMMENT '验证码',
    used TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '是否已使用：0-否，1-是',
    expired_at DATETIME NOT NULL COMMENT '过期时间',
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_phone_code (phone, code),
    INDEX idx_expired_at (expired_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='短信验证码表';

-- 发送验证码
INSERT INTO sms_codes (phone, code, expired_at)
VALUES (
    :phone,
    :code,  -- 6位随机数字
    DATE_ADD(NOW(), INTERVAL 5 MINUTE)  -- 5分钟过期
);

-- 验证码登录
-- 1. 验证验证码
SELECT id
FROM sms_codes
WHERE phone = :phone
AND code = :code
AND used = 0
AND expired_at > NOW()
ORDER BY created_at DESC
LIMIT 1;

-- 2. 标记验证码已使用
UPDATE sms_codes
SET used = 1
WHERE id = :code_id;

-- 3. 查询或创建用户
SELECT id FROM users WHERE phone = :phone AND deleted_at IS NULL;

-- 如果不存在，创建用户
INSERT INTO users (phone, username, nickname, status)
VALUES (
    :phone,
    CONCAT('user_', :phone),  -- 自动生成用户名
    CONCAT('用户', SUBSTR(:phone, -4)),  -- 自动生成昵称
    1
);
```

---

## 四、用户信息管理

### 4.1 查询用户信息

```sql
-- 查询基本信息
SELECT
    id,
    username,
    email,
    phone,
    nickname,
    avatar,
    gender,
    birthday,
    status,
    email_verified,
    phone_verified,
    created_at
FROM users
WHERE id = :user_id
AND deleted_at IS NULL;

-- 查询完整信息（含扩展信息）
SELECT
    u.id,
    u.username,
    u.email,
    u.phone,
    u.nickname,
    u.avatar,
    u.gender,
    u.birthday,
    u.status,
    u.created_at,

    p.real_name,
    p.province,
    p.city,
    p.district,
    p.address,
    p.bio,
    p.education,
    p.occupation
FROM users u
LEFT JOIN user_profiles p ON u.id = p.user_id
WHERE u.id = :user_id
AND u.deleted_at IS NULL;
```

### 4.2 更新用户信息

```sql
-- 更新基本信息
UPDATE users
SET
    nickname = :nickname,
    avatar = :avatar,
    gender = :gender,
    birthday = :birthday
WHERE id = :user_id
AND deleted_at IS NULL;

-- 更新扩展信息
UPDATE user_profiles
SET
    province = :province,
    city = :city,
    district = :district,
    address = :address,
    bio = :bio
WHERE user_id = :user_id;

-- 如果扩展信息不存在，先插入
INSERT INTO user_profiles (user_id, province, city, district, address, bio)
VALUES (:user_id, :province, :city, :district, :address, :bio)
ON DUPLICATE KEY UPDATE
    province = VALUES(province),
    city = VALUES(city),
    district = VALUES(district),
    address = VALUES(address),
    bio = VALUES(bio);
```

---

## 五、密码管理

### 5.1 修改密码

```sql
-- 1. 验证旧密码（应用层）
SELECT password
FROM users
WHERE id = :user_id
AND deleted_at IS NULL;

-- 2. 更新密码
UPDATE users
SET password = :new_password_hash
WHERE id = :user_id
AND deleted_at IS NULL;
```

### 5.2 忘记密码（邮箱重置）

```sql
-- 密码重置token表
CREATE TABLE password_reset_tokens (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    token VARCHAR(100) NOT NULL,
    used TINYINT UNSIGNED NOT NULL DEFAULT 0,
    expired_at DATETIME NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_token (token),
    INDEX idx_user_id (user_id),
    INDEX idx_expired_at (expired_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='密码重置token表';

-- 1. 生成重置token
INSERT INTO password_reset_tokens (user_id, token, expired_at)
VALUES (
    :user_id,
    :token,  -- 随机生成的token
    DATE_ADD(NOW(), INTERVAL 1 HOUR)  -- 1小时过期
);

-- 2. 发送重置链接到邮箱
-- https://example.com/reset-password?token=xxx

-- 3. 验证token
SELECT user_id
FROM password_reset_tokens
WHERE token = :token
AND used = 0
AND expired_at > NOW()
LIMIT 1;

-- 4. 重置密码
UPDATE users
SET password = :new_password_hash
WHERE id = :user_id;

-- 5. 标记token已使用
UPDATE password_reset_tokens
SET used = 1
WHERE token = :token;
```

---

## 六、用户状态管理

### 6.1 禁用/启用用户

```sql
-- 禁用用户
UPDATE users
SET status = 2
WHERE id = :user_id;

-- 启用用户
UPDATE users
SET status = 1
WHERE id = :user_id;

-- 批量禁用
UPDATE users
SET status = 2
WHERE id IN (:user_ids);
```

### 6.2 删除用户（软删除）

```sql
-- 软删除用户
UPDATE users
SET
    deleted_at = NOW(),
    -- 修改唯一字段，避免冲突
    username = CONCAT(username, '_deleted_', UNIX_TIMESTAMP(NOW())),
    email = CONCAT(email, '_deleted_', UNIX_TIMESTAMP(NOW()))
WHERE id = :user_id;

-- 物理删除（慎用）
DELETE FROM users WHERE id = :user_id;
```

---

## 七、用户地址管理

### 7.1 添加地址

```sql
-- 1. 如果设置为默认地址，先取消其他默认地址
UPDATE user_addresses
SET is_default = 0
WHERE user_id = :user_id
AND is_default = 1;

-- 2. 添加地址
INSERT INTO user_addresses (
    user_id,
    consignee,
    phone,
    province,
    city,
    district,
    address,
    is_default
) VALUES (
    :user_id,
    :consignee,
    :phone,
    :province,
    :city,
    :district,
    :address,
    :is_default
);
```

### 7.2 查询用户地址

```sql
-- 查询所有地址
SELECT
    id,
    consignee,
    phone,
    province,
    city,
    district,
    address,
    zip_code,
    is_default,
    created_at
FROM user_addresses
WHERE user_id = :user_id
AND deleted_at IS NULL
ORDER BY is_default DESC, created_at DESC;

-- 查询默认地址
SELECT *
FROM user_addresses
WHERE user_id = :user_id
AND is_default = 1
AND deleted_at IS NULL
LIMIT 1;
```

### 7.3 修改/删除地址

```sql
-- 修改地址
UPDATE user_addresses
SET
    consignee = :consignee,
    phone = :phone,
    province = :province,
    city = :city,
    district = :district,
    address = :address
WHERE id = :address_id
AND user_id = :user_id;

-- 设置为默认地址
-- 1. 取消其他默认地址
UPDATE user_addresses
SET is_default = 0
WHERE user_id = :user_id
AND is_default = 1;

-- 2. 设置当前地址为默认
UPDATE user_addresses
SET is_default = 1
WHERE id = :address_id
AND user_id = :user_id;

-- 删除地址（软删除）
UPDATE user_addresses
SET deleted_at = NOW()
WHERE id = :address_id
AND user_id = :user_id;
```

---

## 八、用户查询统计

### 8.1 用户列表查询

```sql
-- 用户列表（支持搜索、筛选、分页）
SELECT
    id,
    username,
    email,
    phone,
    nickname,
    avatar,
    status,
    login_count,
    last_login_at,
    created_at
FROM users
WHERE deleted_at IS NULL
AND (:keyword IS NULL OR (
    username LIKE CONCAT('%', :keyword, '%')
    OR email LIKE CONCAT('%', :keyword, '%')
    OR phone LIKE CONCAT('%', :keyword, '%')
))
AND (:status IS NULL OR status = :status)
ORDER BY created_at DESC
LIMIT :page_size OFFSET :offset;

-- 总数
SELECT COUNT(*)
FROM users
WHERE deleted_at IS NULL
AND (:keyword IS NULL OR (
    username LIKE CONCAT('%', :keyword, '%')
    OR email LIKE CONCAT('%', :keyword, '%')
    OR phone LIKE CONCAT('%', :keyword, '%')
))
AND (:status IS NULL OR status = :status);
```

### 8.2 用户统计

```sql
-- 用户总数统计
SELECT
    COUNT(*) AS total_users,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS active_users,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS disabled_users,
    SUM(CASE WHEN email_verified = 1 THEN 1 ELSE 0 END) AS email_verified_users,
    SUM(CASE WHEN phone_verified = 1 THEN 1 ELSE 0 END) AS phone_verified_users
FROM users
WHERE deleted_at IS NULL;

-- 新增用户统计（最近30天）
SELECT
    DATE(created_at) AS date,
    COUNT(*) AS new_users
FROM users
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
GROUP BY DATE(created_at)
ORDER BY date;

-- 活跃用户统计（最近登录）
SELECT
    CASE
        WHEN last_login_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN '近7天'
        WHEN last_login_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) THEN '近30天'
        WHEN last_login_at >= DATE_SUB(NOW(), INTERVAL 90 DAY) THEN '近90天'
        ELSE '90天以上'
    END AS activity_level,
    COUNT(*) AS user_count
FROM users
WHERE deleted_at IS NULL
GROUP BY activity_level;
```

---

## 九、安全建议

### 9.1 密码安全

```python
# 1. 使用bcrypt等强加密算法
import bcrypt

# 加密密码
password_hash = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())

# 验证密码
bcrypt.checkpw(password.encode('utf-8'), password_hash)

# 2. 密码复杂度要求
# - 最少8个字符
# - 包含大小写字母、数字、特殊字符

# 3. 密码重试次数限制
# - 5次错误后锁定账号15分钟
```

### 9.2 SQL注入防护

```python
# ✅ 使用参数化查询
sql = "SELECT * FROM users WHERE username = %s"
db.query(sql, (username,))

# ❌ 不要拼接SQL
sql = f"SELECT * FROM users WHERE username = '{username}'"  # 危险！
```

### 9.3 其他安全建议

1. **邮箱/手机号验证**：注册后发送验证邮件/短信
2. **登录日志**：记录所有登录行为（IP、时间、设备）
3. **异地登录提醒**：IP地址变化时发送提醒
4. **Token过期**：JWT设置合理的过期时间
5. **HTTPS**：所有接口使用HTTPS传输

---

## 十、本章总结

### 核心要点

1. **表设计**：
   - users：核心用户表
   - user_profiles：扩展信息表
   - user_addresses：地址表

2. **用户注册**：
   - 参数验证
   - 唯一性检查
   - 密码加密

3. **用户登录**：
   - 密码登录
   - 验证码登录
   - 登录信息更新

4. **用户管理**：
   - 信息查询
   - 信息更新
   - 密码管理

5. **安全措施**：
   - 密码加密
   - SQL注入防护
   - 验证码机制

### 下一步

完成本章学习后，你应该能够：
- ✅ 设计完整的用户表结构
- ✅ 实现用户注册登录功能
- ✅ 实现用户信息管理
- ✅ 实现用户地址管理
- ✅ 确保用户系统安全

下一节：[15-订单系统设计与实现](./15-订单系统设计与实现.md)
