# 20-æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜

> æŒæ¡æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§ï¼Œæå‡SQLæ‰§è¡Œæ•ˆç‡

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- è¯†åˆ«å’Œåˆ†ææ…¢æŸ¥è¯¢
- æŒæ¡æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§
- ä¼˜åŒ–COUNTæŸ¥è¯¢
- ä¼˜åŒ–JOINæŸ¥è¯¢
- ä¼˜åŒ–å­æŸ¥è¯¢
- ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢
- é¿å…ä¸´æ—¶è¡¨å’Œæ–‡ä»¶æ’åº

---

## ä¸€ã€æ…¢æŸ¥è¯¢è¯†åˆ«

### 1.1 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—é…ç½®
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long_query_time';

-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼‰
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;  -- è¶…è¿‡2ç§’çš„æŸ¥è¯¢è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—

-- æ°¸ä¹…ç”Ÿæ•ˆï¼šåœ¨my.cnfä¸­é…ç½®
-- [mysqld]
-- slow_query_log = ON
-- slow_query_log_file = /var/log/mysql/slow.log
-- long_query_time = 2
-- log_queries_not_using_indexes = ON  -- è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
```

### 1.2 åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—

```bash
# ä½¿ç”¨mysqldumpslowåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
mysqldumpslow -s t -t 10 /var/log/mysql/slow.log
# -s t: æŒ‰æŸ¥è¯¢æ—¶é—´æ’åº
# -t 10: æ˜¾ç¤ºå‰10æ¡

# å¸¸ç”¨é€‰é¡¹
mysqldumpslow -s c -t 10 slow.log  # æŒ‰æŸ¥è¯¢æ¬¡æ•°æ’åº
mysqldumpslow -s l -t 10 slow.log  # æŒ‰é”å®šæ—¶é—´æ’åº
mysqldumpslow -s r -t 10 slow.log  # æŒ‰è¿”å›è®°å½•æ•°æ’åº
mysqldumpslow -s at -t 10 slow.log # æŒ‰å¹³å‡æŸ¥è¯¢æ—¶é—´æ’åº
```

### 1.3 ä½¿ç”¨Performance Schema

```sql
-- æŸ¥çœ‹æœ€è€—æ—¶çš„SQLï¼ˆMySQL 8.0+ï¼‰
SELECT
    DIGEST_TEXT AS query,
    COUNT_STAR AS exec_count,
    AVG_TIMER_WAIT / 1000000000000 AS avg_time_sec,
    SUM_TIMER_WAIT / 1000000000000 AS total_time_sec,
    SUM_ROWS_EXAMINED AS total_rows_examined,
    SUM_ROWS_SENT AS total_rows_sent
FROM performance_schema.events_statements_summary_by_digest
ORDER BY SUM_TIMER_WAIT DESC
LIMIT 10;

-- æŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ…¢æŸ¥è¯¢
SELECT
    id,
    user,
    host,
    db,
    command,
    time,
    state,
    info
FROM information_schema.PROCESSLIST
WHERE command != 'Sleep'
AND time > 5
ORDER BY time DESC;

-- æ€æ­»æ…¢æŸ¥è¯¢
KILL <id>;
```

---

## äºŒã€COUNTä¼˜åŒ–

### 2.1 COUNT(*)æ€§èƒ½å¯¹æ¯”

```sql
-- æ€§èƒ½å¯¹æ¯”ï¼ˆä»å¿«åˆ°æ…¢ï¼‰
-- COUNT(*) â‰ˆ COUNT(1) > COUNT(ä¸»é”®) > COUNT(å­—æ®µ)

-- âŒ æ…¢ï¼šCOUNT(å­—æ®µ) - éœ€è¦åˆ¤æ–­NULL
SELECT COUNT(email) FROM users;

-- âœ… å¿«ï¼šCOUNT(*) - InnoDBä¼˜åŒ–è¿‡ï¼Œä¸éœ€è¦å–å€¼
SELECT COUNT(*) FROM users;

-- COUNT(*)ä¼˜åŒ–ï¼šè¦†ç›–ç´¢å¼•
-- å¦‚æœæœ‰äºŒçº§ç´¢å¼•ï¼Œä¼šä½¿ç”¨æ›´å°çš„ç´¢å¼•æ ‘
EXPLAIN SELECT COUNT(*) FROM users;
-- Extra: Using indexï¼ˆä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼‰
```

### 2.2 å¤§è¡¨COUNTä¼˜åŒ–

```sql
-- âŒ é—®é¢˜ï¼šå¤§è¡¨COUNT(*)å¾ˆæ…¢
SELECT COUNT(*) FROM orders;
-- æ‰«æå¤§é‡æ•°æ®

-- âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨è¿‘ä¼¼å€¼
EXPLAIN SELECT table_rows
FROM information_schema.TABLES
WHERE table_schema = 'your_database'
AND table_name = 'orders';
-- æ³¨æ„ï¼šè¿™ä¸ªå€¼æ˜¯ä¼°ç®—å€¼ï¼Œå¯èƒ½ä¸å‡†ç¡®

-- âœ… æ–¹æ¡ˆ2ï¼šç»´æŠ¤è®¡æ•°è¡¨
CREATE TABLE table_count (
    table_name VARCHAR(50) PRIMARY KEY,
    count BIGINT UNSIGNED NOT NULL DEFAULT 0,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- æ’å…¥æ—¶å¢åŠ è®¡æ•°
BEGIN;
INSERT INTO orders (...) VALUES (...);
INSERT INTO table_count (table_name, count) VALUES ('orders', 1)
ON DUPLICATE KEY UPDATE count = count + 1;
COMMIT;

-- åˆ é™¤æ—¶å‡å°‘è®¡æ•°
BEGIN;
DELETE FROM orders WHERE id = :id;
UPDATE table_count SET count = count - 1 WHERE table_name = 'orders';
COMMIT;

-- æŸ¥è¯¢è®¡æ•°
SELECT count FROM table_count WHERE table_name = 'orders';

-- âœ… æ–¹æ¡ˆ3ï¼šåˆ†æ®µCOUNT
SELECT
    SUM(cnt) AS total
FROM (
    SELECT COUNT(*) AS cnt FROM orders WHERE id BETWEEN 1 AND 1000000
    UNION ALL
    SELECT COUNT(*) AS cnt FROM orders WHERE id BETWEEN 1000001 AND 2000000
    UNION ALL
    SELECT COUNT(*) AS cnt FROM orders WHERE id BETWEEN 2000001 AND 3000000
) AS t;
```

### 2.3 æ¡ä»¶COUNTä¼˜åŒ–

```sql
-- âŒ æ…¢ï¼šå¤šæ¬¡COUNT
SELECT COUNT(*) FROM orders WHERE status = 1;
SELECT COUNT(*) FROM orders WHERE status = 2;
SELECT COUNT(*) FROM orders WHERE status = 3;

-- âœ… å¿«ï¼šä¸€æ¬¡æŸ¥è¯¢
SELECT
    COUNT(*) AS total,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS pending,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS paid,
    SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS shipped
FROM orders;

-- æˆ–ä½¿ç”¨COUNT(IF(...))
SELECT
    COUNT(*) AS total,
    COUNT(IF(status = 1, 1, NULL)) AS pending,
    COUNT(IF(status = 2, 1, NULL)) AS paid,
    COUNT(IF(status = 3, 1, NULL)) AS shipped
FROM orders;
```

---

## ä¸‰ã€JOINä¼˜åŒ–

### 3.1 JOINåŸç†

```sql
-- JOINç®—æ³•ï¼š
-- 1. Nested Loop Joinï¼ˆåµŒå¥—å¾ªç¯ï¼‰ï¼šé€‚åˆå°è¡¨
-- 2. Block Nested Loop Joinï¼ˆå—åµŒå¥—å¾ªç¯ï¼‰ï¼šå¤§è¡¨æ— ç´¢å¼•
-- 3. Index Nested Loop Joinï¼ˆç´¢å¼•åµŒå¥—å¾ªç¯ï¼‰ï¼šå¤§è¡¨æœ‰ç´¢å¼•

-- âŒ é—®é¢˜ï¼šæ²¡æœ‰ç´¢å¼•çš„JOIN
EXPLAIN SELECT *
FROM orders o
JOIN users u ON o.user_id = u.id
WHERE o.status = 2;
-- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰
-- Extra: Using join bufferï¼ˆä½¿ç”¨è¿æ¥ç¼“å†²åŒºï¼‰

-- âœ… ä¼˜åŒ–ï¼šæ·»åŠ ç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);
EXPLAIN SELECT *
FROM orders o
JOIN users u ON o.user_id = u.id
WHERE o.status = 2;
-- type: refï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
```

### 3.2 å°è¡¨é©±åŠ¨å¤§è¡¨

```sql
-- åŸåˆ™ï¼šå°è¡¨é©±åŠ¨å¤§è¡¨ï¼ˆå°è¡¨åœ¨å‰ï¼Œå¤§è¡¨åœ¨åï¼‰

-- âŒ é”™è¯¯ï¼šå¤§è¡¨é©±åŠ¨å°è¡¨
EXPLAIN SELECT *
FROM orders o  -- 100ä¸‡è¡Œ
JOIN users u ON o.user_id = u.id  -- 1ä¸‡è¡Œ
WHERE u.status = 1;  -- 1000è¡Œ
-- æ‰«æï¼š100ä¸‡ Ã— 1000 = 10äº¿æ¬¡

-- âœ… æ­£ç¡®ï¼šå°è¡¨é©±åŠ¨å¤§è¡¨
EXPLAIN SELECT *
FROM users u  -- 1000è¡Œ
JOIN orders o ON u.id = o.user_id  -- 100ä¸‡è¡Œ
WHERE u.status = 1;
-- æ‰«æï¼š1000 Ã— log(100ä¸‡) â‰ˆ 2ä¸‡æ¬¡

-- ä½¿ç”¨STRAIGHT_JOINå¼ºåˆ¶JOINé¡ºåº
SELECT *
FROM users u
STRAIGHT_JOIN orders o ON u.id = o.user_id
WHERE u.status = 1;
```

### 3.3 JOINå­—æ®µä¼˜åŒ–

```sql
-- âŒ é—®é¢˜ï¼šJOINå­—æ®µç±»å‹ä¸ä¸€è‡´
-- users.id: BIGINT
-- orders.user_id: VARCHAR
SELECT *
FROM orders o
JOIN users u ON o.user_id = u.id;
-- ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ

-- âœ… ä¼˜åŒ–ï¼šç¡®ä¿å­—æ®µç±»å‹ã€å­—ç¬¦é›†ã€æ’åºè§„åˆ™ä¸€è‡´
ALTER TABLE orders MODIFY user_id BIGINT UNSIGNED NOT NULL;

-- âŒ é—®é¢˜ï¼šJOINå­—æ®µæœ‰å‡½æ•°
SELECT *
FROM orders o
JOIN users u ON DATE(o.created_at) = DATE(u.created_at);
-- ç´¢å¼•å¤±æ•ˆ

-- âœ… ä¼˜åŒ–ï¼šå»æ‰å‡½æ•°
SELECT *
FROM orders o
JOIN users u ON o.created_at >= DATE(u.created_at)
    AND o.created_at < DATE_ADD(DATE(u.created_at), INTERVAL 1 DAY);
```

### 3.4 å¤šè¡¨JOINä¼˜åŒ–

```sql
-- âŒ é—®é¢˜ï¼šJOINè¿‡å¤šè¡¨
SELECT *
FROM t1
JOIN t2 ON t1.id = t2.t1_id
JOIN t3 ON t2.id = t3.t2_id
JOIN t4 ON t3.id = t4.t3_id
JOIN t5 ON t4.id = t5.t4_id;
-- æ€§èƒ½å·®ï¼Œéš¾ä»¥ä¼˜åŒ–

-- âœ… ä¼˜åŒ–ï¼šå‡å°‘JOINè¡¨æ•°é‡
-- æ–¹æ¡ˆ1ï¼šé€‚å½“å†—ä½™å­—æ®µ
-- æ–¹æ¡ˆ2ï¼šåˆ†æ­¥æŸ¥è¯¢
-- æ–¹æ¡ˆ3ï¼šä½¿ç”¨ç¼“å­˜

-- ç¤ºä¾‹ï¼šåˆ†æ­¥æŸ¥è¯¢
-- ç¬¬1æ­¥ï¼šæŸ¥è¯¢è®¢å•
SELECT * FROM orders WHERE user_id = :user_id;

-- ç¬¬2æ­¥ï¼šæŸ¥è¯¢è®¢å•æ˜ç»†ï¼ˆåº”ç”¨å±‚å…³è”ï¼‰
SELECT * FROM order_items WHERE order_id IN (:order_ids);

-- ç¬¬3æ­¥ï¼šæŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆåº”ç”¨å±‚å…³è”ï¼‰
SELECT * FROM products WHERE id IN (:product_ids);
```

---

## å››ã€å­æŸ¥è¯¢ä¼˜åŒ–

### 4.1 INå­æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ æ…¢ï¼šINå­æŸ¥è¯¢
EXPLAIN SELECT *
FROM users
WHERE id IN (
    SELECT user_id FROM orders WHERE status = 2
);
-- å¯èƒ½è½¬æ¢ä¸ºEXISTSï¼Œæ€§èƒ½å·®

-- âœ… å¿«ï¼šæ”¹å†™ä¸ºJOIN
EXPLAIN SELECT DISTINCT u.*
FROM users u
JOIN orders o ON u.id = o.user_id
WHERE o.status = 2;
-- ä½¿ç”¨ç´¢å¼•ï¼Œæ€§èƒ½å¥½

-- æˆ–ä½¿ç”¨EXISTS
EXPLAIN SELECT *
FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o
    WHERE o.user_id = u.id
    AND o.status = 2
);
```

### 4.2 NOT INå­æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ éå¸¸æ…¢ï¼šNOT INå­æŸ¥è¯¢
EXPLAIN SELECT *
FROM users
WHERE id NOT IN (
    SELECT user_id FROM orders WHERE status = 2
);
-- æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œå…¨è¡¨æ‰«æ

-- âœ… å¿«ï¼šæ”¹å†™ä¸ºLEFT JOIN
EXPLAIN SELECT u.*
FROM users u
LEFT JOIN orders o ON u.id = o.user_id AND o.status = 2
WHERE o.id IS NULL;
-- ä½¿ç”¨ç´¢å¼•

-- æˆ–ä½¿ç”¨NOT EXISTS
EXPLAIN SELECT *
FROM users u
WHERE NOT EXISTS (
    SELECT 1 FROM orders o
    WHERE o.user_id = u.id
    AND o.status = 2
);
```

### 4.3 å…³è”å­æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ æ…¢ï¼šå…³è”å­æŸ¥è¯¢ï¼ˆæ¯è¡Œéƒ½æ‰§è¡Œä¸€æ¬¡å­æŸ¥è¯¢ï¼‰
EXPLAIN SELECT
    u.id,
    u.username,
    (SELECT COUNT(*) FROM orders WHERE user_id = u.id) AS order_count
FROM users u;
-- æ‰§è¡ŒN+1æ¬¡æŸ¥è¯¢

-- âœ… å¿«ï¼šæ”¹å†™ä¸ºLEFT JOIN
EXPLAIN SELECT
    u.id,
    u.username,
    COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id;
-- æ‰§è¡Œ1æ¬¡æŸ¥è¯¢
```

---

## äº”ã€åˆ†é¡µä¼˜åŒ–

### 5.1 æ·±åˆ†é¡µé—®é¢˜

```sql
-- âŒ é—®é¢˜ï¼šæ·±åˆ†é¡µå¾ˆæ…¢
EXPLAIN SELECT *
FROM orders
ORDER BY created_at DESC
LIMIT 1000000, 20;
-- éœ€è¦æ‰«æ1000020è¡Œï¼Œåªè¿”å›20è¡Œ

-- rows: 1000020
-- è€—æ—¶éšOFFSETå¢å¤§è€Œå¢åŠ 
```

### 5.2 å»¶è¿Ÿå…³è”ä¼˜åŒ–

```sql
-- âœ… ä¼˜åŒ–ï¼šå»¶è¿Ÿå…³è”ï¼ˆå…ˆæŸ¥IDï¼Œå†JOINï¼‰
EXPLAIN SELECT o.*
FROM orders o
JOIN (
    SELECT id
    FROM orders
    ORDER BY created_at DESC
    LIMIT 1000000, 20
) AS t ON o.id = t.id;

-- è§£é‡Šï¼š
-- 1. å­æŸ¥è¯¢åªæŸ¥IDï¼ˆè¦†ç›–ç´¢å¼•ï¼‰ï¼Œå¿«
-- 2. å¤–å±‚æŸ¥è¯¢åªæŸ¥20è¡Œï¼Œå¿«

-- è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šä½¿ç”¨è¦†ç›–ç´¢å¼•
CREATE INDEX idx_created_id ON orders(created_at, id);

EXPLAIN SELECT o.*
FROM orders o
JOIN (
    SELECT id
    FROM orders
    ORDER BY created_at DESC
    LIMIT 1000000, 20
) AS t ON o.id = t.id;
-- Extra: Using indexï¼ˆå­æŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼‰
```

### 5.3 æ¸¸æ ‡åˆ†é¡µ

```sql
-- âœ… æœ€ä¼˜ï¼šæ¸¸æ ‡åˆ†é¡µï¼ˆè®°å½•ä¸Šæ¬¡ä½ç½®ï¼‰

-- ç¬¬1é¡µ
SELECT *
FROM orders
WHERE id > 0
ORDER BY id
LIMIT 20;
-- è¿”å›æœ€åä¸€æ¡çš„id: 20

-- ç¬¬2é¡µ
SELECT *
FROM orders
WHERE id > 20
ORDER BY id
LIMIT 20;
-- è¿”å›æœ€åä¸€æ¡çš„id: 40

-- ç¬¬3é¡µ
SELECT *
FROM orders
WHERE id > 40
ORDER BY id
LIMIT 20;

-- ä¼˜ç‚¹ï¼šæ€§èƒ½ç¨³å®šï¼Œä¸å—æ·±åº¦å½±å“
-- ç¼ºç‚¹ï¼šæ— æ³•è·³é¡µï¼Œåªèƒ½ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ
```

### 5.4 åˆ†é¡µæ•°æ®é¢„åŠ è½½

```sql
-- âœ… ä¼˜åŒ–ï¼šå°†åˆ†é¡µæ•°æ®é¢„åŠ è½½åˆ°ç¼“å­˜

-- ç¬¬1æ­¥ï¼šåå°ä»»åŠ¡é¢„åŠ è½½çƒ­é—¨æ•°æ®
SELECT id, order_no, user_id, total_amount, status, created_at
FROM orders
WHERE status = 2
ORDER BY created_at DESC
LIMIT 10000;
-- ç¼“å­˜åˆ°Redisï¼Œkey: orders:list:0-10000

-- ç¬¬2æ­¥ï¼šåº”ç”¨å±‚ä»ç¼“å­˜è¯»å–
-- ä»Redisè¯»å– orders:list:1000-1020ï¼ˆ20æ¡ï¼‰

-- ç¬¬3æ­¥ï¼šå®šæœŸæ›´æ–°ç¼“å­˜ï¼ˆæ¯åˆ†é’Ÿæˆ–å®æ—¶ï¼‰
```

---

## å…­ã€ä¸´æ—¶è¡¨å’Œæ–‡ä»¶æ’åºä¼˜åŒ–

### 6.1 é¿å…ä¸´æ—¶è¡¨

```sql
-- âŒ äº§ç”Ÿä¸´æ—¶è¡¨ï¼šGROUP BYå­—æ®µæ²¡æœ‰ç´¢å¼•
EXPLAIN SELECT username, COUNT(*)
FROM users
GROUP BY username;
-- Extra: Using temporaryï¼ˆä½¿ç”¨ä¸´æ—¶è¡¨ï¼‰

-- âœ… ä¼˜åŒ–ï¼šä¸ºGROUP BYå­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_username ON users(username);
EXPLAIN SELECT username, COUNT(*)
FROM users
GROUP BY username;
-- Extra: Using indexï¼ˆä½¿ç”¨ç´¢å¼•ï¼Œæ— ä¸´æ—¶è¡¨ï¼‰

-- âŒ äº§ç”Ÿä¸´æ—¶è¡¨ï¼šDISTINCTå­—æ®µæ²¡æœ‰ç´¢å¼•
EXPLAIN SELECT DISTINCT username FROM users;
-- Extra: Using temporary

-- âœ… ä¼˜åŒ–ï¼šåˆ›å»ºç´¢å¼•
CREATE INDEX idx_username ON users(username);
EXPLAIN SELECT DISTINCT username FROM users;
-- Extra: Using index
```

### 6.2 é¿å…æ–‡ä»¶æ’åº

```sql
-- âŒ æ–‡ä»¶æ’åºï¼šORDER BYå­—æ®µæ²¡æœ‰ç´¢å¼•
EXPLAIN SELECT * FROM users ORDER BY created_at DESC;
-- Extra: Using filesortï¼ˆæ–‡ä»¶æ’åºï¼Œæ…¢ï¼‰

-- âœ… ä¼˜åŒ–ï¼šä¸ºORDER BYå­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_created_at ON users(created_at);
EXPLAIN SELECT * FROM users ORDER BY created_at DESC;
-- Extra: æ— filesortï¼ˆä½¿ç”¨ç´¢å¼•æ’åºï¼‰

-- âŒ æ–‡ä»¶æ’åºï¼šORDER BYå¤šä¸ªå­—æ®µï¼Œé¡ºåºä¸ç´¢å¼•ä¸ä¸€è‡´
CREATE INDEX idx_status_created ON users(status, created_at);
EXPLAIN SELECT * FROM users
ORDER BY created_at, status;  -- é¡ºåºä¸ç´¢å¼•ä¸åŒ
-- Extra: Using filesort

-- âœ… ä¼˜åŒ–ï¼šORDER BYé¡ºåºä¸ç´¢å¼•ä¸€è‡´
EXPLAIN SELECT * FROM users
ORDER BY status, created_at;
-- ä½¿ç”¨ç´¢å¼•æ’åº
```

### 6.3 ä¼˜åŒ–æ’åºå­—æ®µæ•°é‡

```sql
-- âŒ é—®é¢˜ï¼šæ’åºå­—æ®µè¿‡å¤š
SELECT * FROM orders
ORDER BY status, created_at, user_id, total_amount;

-- âœ… ä¼˜åŒ–ï¼šåªæŒ‰å¿…è¦å­—æ®µæ’åº
SELECT * FROM orders
ORDER BY status, created_at;

-- å¦‚æœç¡®å®éœ€è¦å¤šå­—æ®µæ’åºï¼Œè€ƒè™‘ï¼š
-- 1. åˆ›å»ºè”åˆç´¢å¼•
-- 2. å¢å¤§sort_buffer_size
SHOW VARIABLES LIKE 'sort_buffer_size';
SET SESSION sort_buffer_size = 2097152;  -- 2MB
```

---

## ä¸ƒã€å…¶ä»–æŸ¥è¯¢ä¼˜åŒ–

### 7.1 é¿å…SELECT *

```sql
-- âŒ é—®é¢˜ï¼šSELECT * è¿”å›æ‰€æœ‰å­—æ®µ
SELECT * FROM users WHERE id = 1;
-- é—®é¢˜ï¼š
-- 1. è¿”å›ä¸éœ€è¦çš„å­—æ®µï¼Œæµªè´¹ç½‘ç»œå¸¦å®½
-- 2. æ— æ³•ä½¿ç”¨è¦†ç›–ç´¢å¼•
-- 3. å¢åŠ å†…å­˜æ¶ˆè€—

-- âœ… ä¼˜åŒ–ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
SELECT id, username, email FROM users WHERE id = 1;

-- å¥½å¤„ï¼š
-- 1. å‡å°‘æ•°æ®ä¼ è¾“
-- 2. å¯èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•
-- 3. å‡å°‘å†…å­˜æ¶ˆè€—
```

### 7.2 ä¼˜åŒ–ORæŸ¥è¯¢

```sql
-- âŒ é—®é¢˜ï¼šORå¯¼è‡´ç´¢å¼•å¤±æ•ˆ
EXPLAIN SELECT * FROM users
WHERE username = 'zhangsan' OR email = 'zhangsan@example.com';
-- type: ALL æˆ– index_merge

-- âœ… ä¼˜åŒ–1ï¼šæ”¹å†™ä¸ºUNION
EXPLAIN
SELECT * FROM users WHERE username = 'zhangsan'
UNION
SELECT * FROM users WHERE email = 'zhangsan@example.com';
-- ä¸¤ä¸ªæŸ¥è¯¢éƒ½ä½¿ç”¨ç´¢å¼•

-- âœ… ä¼˜åŒ–2ï¼šå¦‚æœORçš„æ¡ä»¶åœ¨åŒä¸€åˆ—ï¼Œä½¿ç”¨IN
EXPLAIN SELECT * FROM users WHERE status IN (1, 2, 3);
-- type: rangeï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
```

### 7.3 é¿å…éšå¼è½¬æ¢

```sql
-- âŒ é—®é¢˜ï¼šå­—ç¬¦ä¸²å­—æ®µä¸æ•°å­—æ¯”è¾ƒ
-- phone: VARCHAR
EXPLAIN SELECT * FROM users WHERE phone = 13800138000;
-- type: ALLï¼ˆç´¢å¼•å¤±æ•ˆï¼‰

-- âœ… ä¼˜åŒ–ï¼šä½¿ç”¨å­—ç¬¦ä¸²
EXPLAIN SELECT * FROM users WHERE phone = '13800138000';
-- type: refï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰

-- âŒ é—®é¢˜ï¼šæ•°å­—å­—æ®µä¸å­—ç¬¦ä¸²æ¯”è¾ƒ
-- id: BIGINT
EXPLAIN SELECT * FROM users WHERE id = '1';
-- å¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œä½†ä¸æ¨è

-- âœ… ä¼˜åŒ–ï¼šç±»å‹åŒ¹é…
EXPLAIN SELECT * FROM users WHERE id = 1;
```

### 7.4 æ‰¹é‡æ“ä½œä¼˜åŒ–

```sql
-- âŒ æ…¢ï¼šé€æ¡INSERT
INSERT INTO users (username) VALUES ('user1');
INSERT INTO users (username) VALUES ('user2');
INSERT INTO users (username) VALUES ('user3');
-- å¤šæ¬¡ç½‘ç»œå¾€è¿”

-- âœ… å¿«ï¼šæ‰¹é‡INSERT
INSERT INTO users (username) VALUES
('user1'),
('user2'),
('user3');
-- ä¸€æ¬¡ç½‘ç»œå¾€è¿”

-- âŒ æ…¢ï¼šé€æ¡UPDATE
UPDATE users SET status = 1 WHERE id = 1;
UPDATE users SET status = 1 WHERE id = 2;
UPDATE users SET status = 1 WHERE id = 3;

-- âœ… å¿«ï¼šæ‰¹é‡UPDATE
UPDATE users SET status = 1 WHERE id IN (1, 2, 3);

-- âœ… æ›´å¿«ï¼šä½¿ç”¨CASE WHENæ‰¹é‡æ›´æ–°ä¸åŒå€¼
UPDATE users
SET status = CASE
    WHEN id = 1 THEN 1
    WHEN id = 2 THEN 2
    WHEN id = 3 THEN 1
END
WHERE id IN (1, 2, 3);
```

---

## å…«ã€æŸ¥è¯¢ä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šç”¨æˆ·è®¢å•åˆ—è¡¨ä¼˜åŒ–

```sql
-- âŒ åŸå§‹æŸ¥è¯¢ï¼ˆæ…¢ï¼‰
SELECT
    o.*,
    u.username,
    u.email,
    COUNT(oi.id) AS item_count
FROM orders o
LEFT JOIN users u ON o.user_id = u.id
LEFT JOIN order_items oi ON o.id = oi.order_id
WHERE o.user_id = :user_id
GROUP BY o.id
ORDER BY o.created_at DESC
LIMIT 20;

-- é—®é¢˜ï¼š
-- 1. SELECT * è¿”å›ä¸éœ€è¦çš„å­—æ®µ
-- 2. LEFT JOIN userså†—ä½™ï¼ˆordersè¡¨å·²æœ‰usernameï¼‰
-- 3. GROUP BYäº§ç”Ÿä¸´æ—¶è¡¨

-- âœ… ä¼˜åŒ–å
-- 1. åˆ©ç”¨å†—ä½™å­—æ®µ
SELECT
    o.id,
    o.order_no,
    o.username,  -- å†—ä½™å­—æ®µ
    o.total_amount,
    o.status,
    o.created_at,
    (SELECT COUNT(*) FROM order_items WHERE order_id = o.id) AS item_count
FROM orders o
WHERE o.user_id = :user_id
ORDER BY o.created_at DESC
LIMIT 20;

-- 2. ç¡®ä¿ç´¢å¼•
CREATE INDEX idx_user_created ON orders(user_id, created_at);

-- æ€§èƒ½æå‡ï¼š10å€ä»¥ä¸Š
```

### æ¡ˆä¾‹2ï¼šå•†å“é”€é‡æ’è¡Œä¼˜åŒ–

```sql
-- âŒ åŸå§‹æŸ¥è¯¢ï¼ˆæ…¢ï¼‰
SELECT
    p.id,
    p.name,
    SUM(oi.quantity) AS total_sales
FROM products p
LEFT JOIN order_items oi ON p.id = oi.product_id
LEFT JOIN orders o ON oi.order_id = o.id
WHERE o.status IN (2, 3, 4)
AND o.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
GROUP BY p.id
ORDER BY total_sales DESC
LIMIT 100;

-- é—®é¢˜ï¼š
-- 1. å¤§é‡æ•°æ®JOINå’ŒGROUP BY
-- 2. å®æ—¶è®¡ç®—ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½å¾ˆæ…¢

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šå†—ä½™ç»Ÿè®¡å­—æ®µ
ALTER TABLE products ADD COLUMN sales_30d INT UNSIGNED NOT NULL DEFAULT 0;

-- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å°æ—¶æ‰§è¡Œï¼‰ï¼šæ›´æ–°é”€é‡
UPDATE products p
SET p.sales_30d = (
    SELECT IFNULL(SUM(oi.quantity), 0)
    FROM order_items oi
    JOIN orders o ON oi.order_id = o.id
    WHERE oi.product_id = p.id
    AND o.status IN (2, 3, 4)
    AND o.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
);

-- æŸ¥è¯¢
SELECT id, name, sales_30d
FROM products
ORDER BY sales_30d DESC
LIMIT 100;
-- æ€§èƒ½æå‡ï¼š100å€ä»¥ä¸Š

-- âœ… ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šç»Ÿè®¡è¡¨
CREATE TABLE product_sales_stats (
    product_id BIGINT UNSIGNED PRIMARY KEY,
    sales_30d INT UNSIGNED NOT NULL DEFAULT 0,
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- å®æ—¶æ›´æ–°ç»Ÿè®¡ï¼ˆè®¢å•å®Œæˆæ—¶ï¼‰
INSERT INTO product_sales_stats (product_id, sales_30d)
VALUES (:product_id, :quantity)
ON DUPLICATE KEY UPDATE sales_30d = sales_30d + :quantity;
```

### æ¡ˆä¾‹3ï¼šå¤æ‚æ¡ä»¶ç­›é€‰ä¼˜åŒ–

```sql
-- âŒ åŸå§‹æŸ¥è¯¢ï¼ˆæ…¢ï¼‰
SELECT *
FROM orders o
WHERE (o.status = 1 OR o.status = 2)
AND (o.total_amount >= 10000 OR o.user_id IN (SELECT id FROM vip_users))
AND DATE(o.created_at) = '2024-01-15'
ORDER BY o.created_at DESC
LIMIT 20;

-- é—®é¢˜ï¼š
-- 1. ORæ¡ä»¶å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
-- 2. INå­æŸ¥è¯¢æ€§èƒ½å·®
-- 3. DATEå‡½æ•°å¯¼è‡´ç´¢å¼•å¤±æ•ˆ

-- âœ… ä¼˜åŒ–å
-- 1. æ‹†åˆ†ORæ¡ä»¶
SELECT * FROM (
    SELECT * FROM orders
    WHERE status IN (1, 2)
    AND total_amount >= 10000
    AND created_at >= '2024-01-15 00:00:00'
    AND created_at < '2024-01-16 00:00:00'

    UNION ALL

    SELECT o.*
    FROM orders o
    JOIN vip_users v ON o.user_id = v.id
    WHERE o.status IN (1, 2)
    AND o.created_at >= '2024-01-15 00:00:00'
    AND o.created_at < '2024-01-16 00:00:00'
) AS t
ORDER BY created_at DESC
LIMIT 20;

-- 2. æ·»åŠ ç´¢å¼•
CREATE INDEX idx_status_amount_created ON orders(status, total_amount, created_at);
CREATE INDEX idx_status_user_created ON orders(status, user_id, created_at);
```

---

## ä¹ã€æŸ¥è¯¢ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### 9.1 ç´¢å¼•æ£€æŸ¥

```sql
-- âœ… WHEREæ¡ä»¶å­—æ®µæ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
-- âœ… ORDER BYå­—æ®µæ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
-- âœ… GROUP BYå­—æ®µæ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
-- âœ… JOINå…³è”å­—æ®µæ˜¯å¦æœ‰ç´¢å¼•ï¼Ÿ
-- âœ… æ˜¯å¦ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•ï¼Ÿ
-- âœ… æ˜¯å¦éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ï¼Ÿ

-- æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦ä½¿ç”¨ç´¢å¼•
EXPLAIN SELECT ...;
-- æŸ¥çœ‹typeã€possible_keysã€keyã€Extraå­—æ®µ
```

### 9.2 æŸ¥è¯¢æ£€æŸ¥

```sql
-- âœ… æ˜¯å¦é¿å…äº†SELECT *ï¼Ÿ
-- âœ… æ˜¯å¦é¿å…äº†å‡½æ•°æ“ä½œç´¢å¼•åˆ—ï¼Ÿ
-- âœ… æ˜¯å¦é¿å…äº†éšå¼ç±»å‹è½¬æ¢ï¼Ÿ
-- âœ… æ˜¯å¦é¿å…äº†å‰å¯¼æ¨¡ç³ŠæŸ¥è¯¢ï¼ˆLIKE '%xxx'ï¼‰ï¼Ÿ
-- âœ… æ˜¯å¦ä¼˜åŒ–äº†ORæ¡ä»¶ï¼Ÿ
-- âœ… æ˜¯å¦ä¼˜åŒ–äº†INå­æŸ¥è¯¢ï¼Ÿ
-- âœ… æ˜¯å¦é¿å…äº†NOT INï¼Ÿ
-- âœ… æ˜¯å¦ä¼˜åŒ–äº†åˆ†é¡µæŸ¥è¯¢ï¼Ÿ
-- âœ… æ˜¯å¦å‡å°‘äº†JOINè¡¨çš„æ•°é‡ï¼Ÿ
-- âœ… æ˜¯å¦è®©å°è¡¨é©±åŠ¨å¤§è¡¨ï¼Ÿ
```

### 9.3 æ€§èƒ½æ£€æŸ¥

```sql
-- âœ… æŸ¥è¯¢æ˜¯å¦äº§ç”Ÿä¸´æ—¶è¡¨ï¼Ÿï¼ˆExtra: Using temporaryï¼‰
-- âœ… æŸ¥è¯¢æ˜¯å¦äº§ç”Ÿæ–‡ä»¶æ’åºï¼Ÿï¼ˆExtra: Using filesortï¼‰
-- âœ… æŸ¥è¯¢æ‰«æçš„è¡Œæ•°æ˜¯å¦åˆç†ï¼Ÿï¼ˆrowså­—æ®µï¼‰
-- âœ… æŸ¥è¯¢è¿”å›çš„è¡Œæ•°æ˜¯å¦åˆç†ï¼Ÿ
-- âœ… æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼Ÿ
-- âœ… æ˜¯å¦å¯ä»¥å¼‚æ­¥åŒ–ï¼Ÿ
```

---

## åã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æ…¢æŸ¥è¯¢è¯†åˆ«**ï¼š
   - å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
   - ä½¿ç”¨mysqldumpslowåˆ†æ
   - Performance Schemaç›‘æ§

2. **COUNTä¼˜åŒ–**ï¼š
   - ä½¿ç”¨COUNT(*)
   - ç»´æŠ¤è®¡æ•°è¡¨
   - åˆ†æ®µCOUNT

3. **JOINä¼˜åŒ–**ï¼š
   - å°è¡¨é©±åŠ¨å¤§è¡¨
   - ç¡®ä¿JOINå­—æ®µæœ‰ç´¢å¼•
   - å‡å°‘JOINè¡¨æ•°é‡

4. **å­æŸ¥è¯¢ä¼˜åŒ–**ï¼š
   - INæ”¹å†™ä¸ºJOIN
   - NOT INæ”¹å†™ä¸ºLEFT JOIN
   - é¿å…å…³è”å­æŸ¥è¯¢

5. **åˆ†é¡µä¼˜åŒ–**ï¼š
   - å»¶è¿Ÿå…³è”
   - æ¸¸æ ‡åˆ†é¡µ
   - æ•°æ®é¢„åŠ è½½

6. **é¿å…ä¸´æ—¶è¡¨å’Œæ–‡ä»¶æ’åº**ï¼š
   - ä¸ºGROUP BYå­—æ®µåˆ›å»ºç´¢å¼•
   - ä¸ºORDER BYå­—æ®µåˆ›å»ºç´¢å¼•

7. **å…¶ä»–ä¼˜åŒ–**ï¼š
   - é¿å…SELECT *
   - ä¼˜åŒ–ORæŸ¥è¯¢
   - é¿å…éšå¼è½¬æ¢
   - æ‰¹é‡æ“ä½œ

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… è¯†åˆ«å’Œåˆ†ææ…¢æŸ¥è¯¢
- âœ… ä¼˜åŒ–COUNTã€JOINã€å­æŸ¥è¯¢
- âœ… ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢
- âœ… é¿å…ä¸´æ—¶è¡¨å’Œæ–‡ä»¶æ’åº
- âœ… åº”ç”¨æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ

ä¸‹ä¸€èŠ‚ï¼š[21-å†™å…¥ä¼˜åŒ–å®æˆ˜](./21-å†™å…¥ä¼˜åŒ–å®æˆ˜.md)
