# 15-è®¢å•ç³»ç»Ÿè®¾è®¡ä¸å®ç°

> ä»é›¶è®¾è®¡å¹¶å®ç°ä¸€ä¸ªå®Œæ•´çš„ç”µå•†è®¢å•ç³»ç»Ÿ

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- è®¾è®¡è®¢å•è¡¨ç»“æ„
- å®ç°è®¢å•åˆ›å»ºæµç¨‹
- å®ç°è®¢å•æ”¯ä»˜æµç¨‹
- å®ç°è®¢å•çŠ¶æ€ç®¡ç†
- å®ç°è®¢å•å–æ¶ˆå’Œé€€æ¬¾
- å®ç°è®¢å•æŸ¥è¯¢ç»Ÿè®¡

---

## ä¸€ã€è®¢å•è¡¨è®¾è®¡

### 1.1 è®¢å•ä¸»è¡¨

```sql
CREATE TABLE orders (
    -- ä¸»é”®
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT 'è®¢å•ID',

    -- è®¢å•å·
    order_no VARCHAR(32) NOT NULL COMMENT 'è®¢å•å·ï¼ˆå”¯ä¸€ï¼‰',

    -- ç”¨æˆ·ä¿¡æ¯
    user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·åï¼ˆå†—ä½™ï¼‰',

    -- é‡‘é¢ï¼ˆå•ä½ï¼šåˆ†ï¼‰
    total_amount BIGINT UNSIGNED NOT NULL COMMENT 'è®¢å•æ€»é‡‘é¢',
    pay_amount BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'å®ä»˜é‡‘é¢',
    discount_amount BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'ä¼˜æƒ é‡‘é¢',
    freight_amount BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'è¿è´¹',

    -- è®¢å•çŠ¶æ€
    status TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-å¾…æ”¯ä»˜ï¼Œ2-å·²æ”¯ä»˜ï¼Œ3-å·²å‘è´§ï¼Œ4-å·²å®Œæˆï¼Œ5-å·²å–æ¶ˆ',

    -- æ”¯ä»˜æ–¹å¼
    pay_method TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'æ”¯ä»˜æ–¹å¼ï¼š0-æœªæ”¯ä»˜ï¼Œ1-å¾®ä¿¡ï¼Œ2-æ”¯ä»˜å®ï¼Œ3-ä½™é¢',
    pay_no VARCHAR(64) NOT NULL DEFAULT '' COMMENT 'æ”¯ä»˜æµæ°´å·',

    -- æ”¶è´§åœ°å€ï¼ˆJSONå¿«ç…§ï¼‰
    shipping_address JSON COMMENT 'æ”¶è´§åœ°å€å¿«ç…§',

    -- å¤‡æ³¨
    user_remark VARCHAR(255) NOT NULL DEFAULT '' COMMENT 'ç”¨æˆ·å¤‡æ³¨',
    admin_remark VARCHAR(255) NOT NULL DEFAULT '' COMMENT 'ç®¡ç†å‘˜å¤‡æ³¨',

    -- æ—¶é—´æˆ³
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¸‹å•æ—¶é—´',
    paid_at DATETIME DEFAULT NULL COMMENT 'æ”¯ä»˜æ—¶é—´',
    shipped_at DATETIME DEFAULT NULL COMMENT 'å‘è´§æ—¶é—´',
    completed_at DATETIME DEFAULT NULL COMMENT 'å®Œæˆæ—¶é—´',
    cancelled_at DATETIME DEFAULT NULL COMMENT 'å–æ¶ˆæ—¶é—´',
    updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,

    -- ç´¢å¼•
    UNIQUE KEY uniq_order_no (order_no),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_paid_at (paid_at),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è®¢å•è¡¨';
```

### 1.2 è®¢å•æ˜ç»†è¡¨

```sql
CREATE TABLE order_items (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT UNSIGNED NOT NULL COMMENT 'è®¢å•ID',

    -- å•†å“ä¿¡æ¯
    product_id BIGINT UNSIGNED NOT NULL COMMENT 'å•†å“ID',
    product_name VARCHAR(200) NOT NULL COMMENT 'å•†å“åç§°ï¼ˆå¿«ç…§ï¼‰',
    product_image VARCHAR(255) NOT NULL DEFAULT '' COMMENT 'å•†å“å›¾ç‰‡ï¼ˆå¿«ç…§ï¼‰',
    sku VARCHAR(100) NOT NULL DEFAULT '' COMMENT 'SKUç¼–ç ',

    -- ä»·æ ¼å’Œæ•°é‡ï¼ˆå•ä½ï¼šåˆ†ï¼‰
    price_cents BIGINT UNSIGNED NOT NULL COMMENT 'æˆäº¤å•ä»·',
    quantity INT UNSIGNED NOT NULL COMMENT 'è´­ä¹°æ•°é‡',
    subtotal BIGINT UNSIGNED NOT NULL COMMENT 'å°è®¡é‡‘é¢',

    -- æ—¶é—´æˆ³
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_order_id (order_id),
    INDEX idx_product_id (product_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è®¢å•æ˜ç»†è¡¨';
```

### 1.3 è®¢å•çŠ¶æ€æ—¥å¿—è¡¨

```sql
CREATE TABLE order_status_logs (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    order_id BIGINT UNSIGNED NOT NULL COMMENT 'è®¢å•ID',

    -- çŠ¶æ€å˜æ›´
    old_status TINYINT UNSIGNED NOT NULL COMMENT 'åŸçŠ¶æ€',
    new_status TINYINT UNSIGNED NOT NULL COMMENT 'æ–°çŠ¶æ€',

    -- æ“ä½œä¿¡æ¯
    operator_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'æ“ä½œäººIDï¼ˆNULLè¡¨ç¤ºç³»ç»Ÿï¼‰',
    operator_type TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT 'æ“ä½œäººç±»å‹ï¼š1-ç”¨æˆ·ï¼Œ2-ç®¡ç†å‘˜ï¼Œ3-ç³»ç»Ÿ',
    remark VARCHAR(255) NOT NULL DEFAULT '' COMMENT 'å¤‡æ³¨',

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_order_id (order_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è®¢å•çŠ¶æ€æ—¥å¿—è¡¨';
```

---

## äºŒã€è®¢å•åˆ›å»ºæµç¨‹

### 2.1 ç”Ÿæˆè®¢å•å·

```python
import time
import random

def generate_order_no():
    """ç”Ÿæˆå”¯ä¸€è®¢å•å·"""
    # æ ¼å¼ï¼šæ—¶é—´æˆ³(14ä½) + éšæœºæ•°(6ä½)
    timestamp = time.strftime('%Y%m%d%H%M%S')
    random_num = str(random.randint(100000, 999999))
    return timestamp + random_num

# ç¤ºä¾‹ï¼š20240115143025123456
```

### 2.2 åˆ›å»ºè®¢å•SQL

```sql
BEGIN;

-- 1. æ’å…¥è®¢å•ä¸»è¡¨
INSERT INTO orders (
    order_no,
    user_id,
    username,
    total_amount,
    pay_amount,
    discount_amount,
    freight_amount,
    shipping_address,
    user_remark,
    status
) VALUES (
    :order_no,
    :user_id,
    (SELECT username FROM users WHERE id = :user_id),
    :total_amount,
    :pay_amount,
    :discount_amount,
    :freight_amount,
    :shipping_address_json,
    :user_remark,
    1  -- å¾…æ”¯ä»˜
);

SET @order_id = LAST_INSERT_ID();

-- 2. æ’å…¥è®¢å•æ˜ç»†
INSERT INTO order_items (
    order_id,
    product_id,
    product_name,
    product_image,
    price_cents,
    quantity,
    subtotal
) VALUES
(:order_id, :product_id_1, :product_name_1, :product_image_1, :price_1, :quantity_1, :subtotal_1),
(:order_id, :product_id_2, :product_name_2, :product_image_2, :price_2, :quantity_2, :subtotal_2);

-- 3. æ‰£å‡åº“å­˜
UPDATE products
SET stock = stock - :quantity_1
WHERE id = :product_id_1
AND stock >= :quantity_1;

UPDATE products
SET stock = stock - :quantity_2
WHERE id = :product_id_2
AND stock >= :quantity_2;

-- 4. è®°å½•çŠ¶æ€æ—¥å¿—
INSERT INTO order_status_logs (
    order_id,
    old_status,
    new_status,
    operator_id,
    operator_type,
    remark
) VALUES (
    @order_id,
    0,  -- åˆå§‹çŠ¶æ€
    1,  -- å¾…æ”¯ä»˜
    :user_id,
    1,  -- ç”¨æˆ·æ“ä½œ
    'åˆ›å»ºè®¢å•'
);

COMMIT;
```

### 2.3 å®Œæ•´åˆ›å»ºè®¢å•ç¤ºä¾‹ï¼ˆPythonï¼‰

```python
def create_order(user_id, items, address_id, user_remark=''):
    """
    åˆ›å»ºè®¢å•
    items: [
        {'product_id': 1, 'quantity': 2},
        {'product_id': 2, 'quantity': 1}
    ]
    """
    # 1. æŸ¥è¯¢å•†å“ä¿¡æ¯å¹¶è®¡ç®—é‡‘é¢
    product_ids = [item['product_id'] for item in items]
    sql = """
        SELECT id, name, image, price_cents, stock
        FROM products
        WHERE id IN (%s)
        AND status = 1
        AND deleted_at IS NULL
    """ % ','.join(['%s'] * len(product_ids))

    products = {p['id']: p for p in db.query(sql, product_ids)}

    # 2. éªŒè¯åº“å­˜å¹¶è®¡ç®—é‡‘é¢
    total_amount = 0
    order_items = []

    for item in items:
        product = products.get(item['product_id'])
        if not product:
            raise ValueError(f"å•†å“{item['product_id']}ä¸å­˜åœ¨")

        if product['stock'] < item['quantity']:
            raise ValueError(f"å•†å“{product['name']}åº“å­˜ä¸è¶³")

        subtotal = product['price_cents'] * item['quantity']
        total_amount += subtotal

        order_items.append({
            'product_id': product['id'],
            'product_name': product['name'],
            'product_image': product['image'],
            'price_cents': product['price_cents'],
            'quantity': item['quantity'],
            'subtotal': subtotal
        })

    # 3. æŸ¥è¯¢æ”¶è´§åœ°å€
    sql = """
        SELECT consignee, phone, province, city, district, address
        FROM user_addresses
        WHERE id = %s AND user_id = %s AND deleted_at IS NULL
    """
    address = db.query_one(sql, (address_id, user_id))
    if not address:
        raise ValueError("æ”¶è´§åœ°å€ä¸å­˜åœ¨")

    # 4. ç”Ÿæˆè®¢å•å·
    order_no = generate_order_no()

    # 5. å¼€å§‹äº‹åŠ¡
    db.begin()

    try:
        # æ’å…¥è®¢å•
        sql = """
            INSERT INTO orders (
                order_no, user_id, username, total_amount, pay_amount,
                shipping_address, user_remark, status
            )
            SELECT
                %s, %s, username, %s, %s, %s, %s, 1
            FROM users
            WHERE id = %s
        """
        db.execute(sql, (
            order_no, user_id, total_amount, total_amount,
            json.dumps(address, ensure_ascii=False), user_remark, user_id
        ))

        order_id = db.last_insert_id()

        # æ’å…¥è®¢å•æ˜ç»†
        sql = """
            INSERT INTO order_items (
                order_id, product_id, product_name, product_image,
                price_cents, quantity, subtotal
            ) VALUES (%s, %s, %s, %s, %s, %s, %s)
        """
        for item in order_items:
            db.execute(sql, (
                order_id,
                item['product_id'],
                item['product_name'],
                item['product_image'],
                item['price_cents'],
                item['quantity'],
                item['subtotal']
            ))

        # æ‰£å‡åº“å­˜
        for item in items:
            sql = """
                UPDATE products
                SET stock = stock - %s
                WHERE id = %s AND stock >= %s
            """
            affected = db.execute(sql, (item['quantity'], item['product_id'], item['quantity']))
            if affected == 0:
                raise ValueError(f"æ‰£å‡åº“å­˜å¤±è´¥ï¼Œå•†å“ID: {item['product_id']}")

        # è®°å½•æ—¥å¿—
        sql = """
            INSERT INTO order_status_logs (
                order_id, old_status, new_status, operator_id, operator_type, remark
            ) VALUES (%s, 0, 1, %s, 1, 'åˆ›å»ºè®¢å•')
        """
        db.execute(sql, (order_id, user_id))

        db.commit()

        return {
            'order_id': order_id,
            'order_no': order_no,
            'total_amount': total_amount / 100
        }

    except Exception as e:
        db.rollback()
        raise e
```

---

## ä¸‰ã€è®¢å•æ”¯ä»˜æµç¨‹

### 3.1 è®¢å•æ”¯ä»˜SQL

```sql
BEGIN;

-- 1. æ£€æŸ¥è®¢å•çŠ¶æ€
SELECT id, status, pay_amount
FROM orders
WHERE order_no = :order_no
AND user_id = :user_id
AND status = 1  -- å¾…æ”¯ä»˜
FOR UPDATE;  -- é”å®šè®¢å•

-- 2. æ›´æ–°è®¢å•çŠ¶æ€
UPDATE orders
SET
    status = 2,  -- å·²æ”¯ä»˜
    pay_method = :pay_method,
    pay_no = :pay_no,
    paid_at = NOW()
WHERE order_no = :order_no
AND user_id = :user_id
AND status = 1;

-- 3. è®°å½•çŠ¶æ€æ—¥å¿—
INSERT INTO order_status_logs (
    order_id,
    old_status,
    new_status,
    operator_id,
    operator_type,
    remark
) VALUES (
    (SELECT id FROM orders WHERE order_no = :order_no),
    1,  -- å¾…æ”¯ä»˜
    2,  -- å·²æ”¯ä»˜
    :user_id,
    1,  -- ç”¨æˆ·æ“ä½œ
    CONCAT('æ”¯ä»˜æˆåŠŸï¼Œæ”¯ä»˜æ–¹å¼ï¼š', :pay_method_name)
);

COMMIT;
```

### 3.2 æ”¯ä»˜å›è°ƒå¤„ç†

```python
def handle_payment_callback(order_no, pay_no, pay_method):
    """
    å¤„ç†æ”¯ä»˜å›è°ƒ
    """
    db.begin()

    try:
        # 1. æŸ¥è¯¢è®¢å•
        sql = """
            SELECT id, user_id, status, pay_amount
            FROM orders
            WHERE order_no = %s
            FOR UPDATE
        """
        order = db.query_one(sql, (order_no,))

        if not order:
            raise ValueError("è®¢å•ä¸å­˜åœ¨")

        if order['status'] != 1:
            # è®¢å•å·²æ”¯ä»˜æˆ–å·²å–æ¶ˆ
            db.commit()
            return

        # 2. æ›´æ–°è®¢å•çŠ¶æ€
        sql = """
            UPDATE orders
            SET
                status = 2,
                pay_method = %s,
                pay_no = %s,
                paid_at = NOW()
            WHERE order_no = %s
            AND status = 1
        """
        db.execute(sql, (pay_method, pay_no, order_no))

        # 3. è®°å½•æ—¥å¿—
        sql = """
            INSERT INTO order_status_logs (
                order_id, old_status, new_status, operator_type, remark
            ) VALUES (%s, 1, 2, 3, 'æ”¯ä»˜æˆåŠŸ')
        """
        db.execute(sql, (order['id'],))

        db.commit()

    except Exception as e:
        db.rollback()
        raise e
```

---

## å››ã€è®¢å•çŠ¶æ€ç®¡ç†

### 4.1 è®¢å•çŠ¶æ€æµè½¬

```sql
-- çŠ¶æ€æµè½¬è§„åˆ™ï¼š
-- 1 (å¾…æ”¯ä»˜) â†’ 2 (å·²æ”¯ä»˜) â†’ 3 (å·²å‘è´§) â†’ 4 (å·²å®Œæˆ)
--            â†“
--            5 (å·²å–æ¶ˆ)

-- æ”¯ä»˜ï¼šå¾…æ”¯ä»˜ â†’ å·²æ”¯ä»˜
UPDATE orders
SET
    status = 2,
    paid_at = NOW()
WHERE id = :order_id
AND status = 1;

-- å‘è´§ï¼šå·²æ”¯ä»˜ â†’ å·²å‘è´§
UPDATE orders
SET
    status = 3,
    shipped_at = NOW()
WHERE id = :order_id
AND status = 2;

-- å®Œæˆï¼šå·²å‘è´§ â†’ å·²å®Œæˆ
UPDATE orders
SET
    status = 4,
    completed_at = NOW()
WHERE id = :order_id
AND status = 3;

-- å–æ¶ˆï¼šå¾…æ”¯ä»˜ â†’ å·²å–æ¶ˆ
UPDATE orders
SET
    status = 5,
    cancelled_at = NOW()
WHERE id = :order_id
AND status = 1;
```

### 4.2 è®¢å•å‘è´§

```sql
BEGIN;

-- 1. æ£€æŸ¥è®¢å•çŠ¶æ€
SELECT id, status
FROM orders
WHERE order_no = :order_no
AND status = 2  -- å·²æ”¯ä»˜
FOR UPDATE;

-- 2. æ›´æ–°è®¢å•çŠ¶æ€
UPDATE orders
SET
    status = 3,
    shipped_at = NOW(),
    admin_remark = CONCAT(admin_remark, ' å¿«é€’å…¬å¸ï¼š', :express_company, ' å¿«é€’å•å·ï¼š', :tracking_no)
WHERE order_no = :order_no
AND status = 2;

-- 3. è®°å½•æ—¥å¿—
INSERT INTO order_status_logs (
    order_id,
    old_status,
    new_status,
    operator_id,
    operator_type,
    remark
) VALUES (
    (SELECT id FROM orders WHERE order_no = :order_no),
    2,
    3,
    :admin_id,
    2,  -- ç®¡ç†å‘˜æ“ä½œ
    CONCAT('è®¢å•å‘è´§ï¼Œå¿«é€’å•å·ï¼š', :tracking_no)
);

COMMIT;
```

### 4.3 è®¢å•å®Œæˆï¼ˆè‡ªåŠ¨ç¡®è®¤æ”¶è´§ï¼‰

```sql
-- å‘è´§å7å¤©è‡ªåŠ¨ç¡®è®¤æ”¶è´§
UPDATE orders
SET
    status = 4,
    completed_at = NOW()
WHERE status = 3  -- å·²å‘è´§
AND shipped_at <= DATE_SUB(NOW(), INTERVAL 7 DAY)
AND id IN (
    SELECT id FROM (
        SELECT id FROM orders WHERE status = 3 LIMIT 1000
    ) AS t
);

-- è®°å½•æ—¥å¿—
INSERT INTO order_status_logs (
    order_id, old_status, new_status, operator_type, remark
)
SELECT
    id, 3, 4, 3, 'ç³»ç»Ÿè‡ªåŠ¨ç¡®è®¤æ”¶è´§'
FROM orders
WHERE status = 4
AND completed_at >= DATE_SUB(NOW(), INTERVAL 1 MINUTE);
```

---

## äº”ã€è®¢å•å–æ¶ˆå’Œé€€æ¬¾

### 5.1 ç”¨æˆ·å–æ¶ˆè®¢å•ï¼ˆæœªæ”¯ä»˜ï¼‰

```sql
BEGIN;

-- 1. æ£€æŸ¥è®¢å•çŠ¶æ€
SELECT id, status
FROM orders
WHERE order_no = :order_no
AND user_id = :user_id
AND status = 1  -- å¾…æ”¯ä»˜
FOR UPDATE;

-- 2. å–æ¶ˆè®¢å•
UPDATE orders
SET
    status = 5,
    cancelled_at = NOW()
WHERE order_no = :order_no
AND user_id = :user_id
AND status = 1;

-- 3. æ¢å¤åº“å­˜
UPDATE products p
JOIN order_items oi ON p.id = oi.product_id
SET p.stock = p.stock + oi.quantity
WHERE oi.order_id = (SELECT id FROM orders WHERE order_no = :order_no);

-- 4. è®°å½•æ—¥å¿—
INSERT INTO order_status_logs (
    order_id, old_status, new_status, operator_id, operator_type, remark
) VALUES (
    (SELECT id FROM orders WHERE order_no = :order_no),
    1, 5, :user_id, 1, 'ç”¨æˆ·å–æ¶ˆè®¢å•'
);

COMMIT;
```

### 5.2 è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ

```sql
-- åˆ›å»ºå30åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ
BEGIN;

-- 1. æŸ¥æ‰¾è¶…æ—¶è®¢å•
SELECT id, order_no
FROM orders
WHERE status = 1
AND created_at <= DATE_SUB(NOW(), INTERVAL 30 MINUTE)
LIMIT 100;

-- 2. æ‰¹é‡å–æ¶ˆè®¢å•
UPDATE orders
SET
    status = 5,
    cancelled_at = NOW()
WHERE status = 1
AND created_at <= DATE_SUB(NOW(), INTERVAL 30 MINUTE)
LIMIT 100;

-- 3. æ¢å¤åº“å­˜
UPDATE products p
JOIN order_items oi ON p.id = oi.product_id
JOIN orders o ON oi.order_id = o.id
SET p.stock = p.stock + oi.quantity
WHERE o.status = 5
AND o.cancelled_at >= DATE_SUB(NOW(), INTERVAL 1 MINUTE);

-- 4. è®°å½•æ—¥å¿—
INSERT INTO order_status_logs (
    order_id, old_status, new_status, operator_type, remark
)
SELECT id, 1, 5, 3, 'è¶…æ—¶æœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ'
FROM orders
WHERE status = 5
AND cancelled_at >= DATE_SUB(NOW(), INTERVAL 1 MINUTE);

COMMIT;
```

---

## å…­ã€è®¢å•æŸ¥è¯¢

### 6.1 ç”¨æˆ·è®¢å•åˆ—è¡¨

```sql
-- æŸ¥è¯¢ç”¨æˆ·è®¢å•åˆ—è¡¨
SELECT
    o.id,
    o.order_no,
    o.total_amount / 100 AS total,
    o.pay_amount / 100 AS pay_amount,
    o.status,
    CASE o.status
        WHEN 1 THEN 'å¾…æ”¯ä»˜'
        WHEN 2 THEN 'å·²æ”¯ä»˜'
        WHEN 3 THEN 'å·²å‘è´§'
        WHEN 4 THEN 'å·²å®Œæˆ'
        WHEN 5 THEN 'å·²å–æ¶ˆ'
    END AS status_text,
    o.created_at,
    o.paid_at,
    COUNT(oi.id) AS item_count
FROM orders o
LEFT JOIN order_items oi ON o.id = oi.order_id
WHERE o.user_id = :user_id
AND o.deleted_at IS NULL
AND (:status IS NULL OR o.status = :status)
GROUP BY o.id
ORDER BY o.created_at DESC
LIMIT 20 OFFSET :offset;
```

### 6.2 è®¢å•è¯¦æƒ…

```sql
-- æŸ¥è¯¢è®¢å•è¯¦æƒ…
SELECT
    o.id,
    o.order_no,
    o.user_id,
    o.username,
    o.total_amount / 100 AS total,
    o.pay_amount / 100 AS pay_amount,
    o.discount_amount / 100 AS discount,
    o.freight_amount / 100 AS freight,
    o.status,
    o.pay_method,
    o.pay_no,
    o.shipping_address,
    o.user_remark,
    o.created_at,
    o.paid_at,
    o.shipped_at,
    o.completed_at,
    o.cancelled_at
FROM orders o
WHERE o.order_no = :order_no
AND o.user_id = :user_id
AND o.deleted_at IS NULL;

-- æŸ¥è¯¢è®¢å•æ˜ç»†
SELECT
    oi.product_id,
    oi.product_name,
    oi.product_image,
    oi.price_cents / 100 AS price,
    oi.quantity,
    oi.subtotal / 100 AS subtotal
FROM order_items oi
JOIN orders o ON oi.order_id = o.id
WHERE o.order_no = :order_no
AND o.user_id = :user_id;

-- æŸ¥è¯¢è®¢å•çŠ¶æ€æ—¥å¿—
SELECT
    osl.old_status,
    osl.new_status,
    CASE osl.new_status
        WHEN 1 THEN 'å¾…æ”¯ä»˜'
        WHEN 2 THEN 'å·²æ”¯ä»˜'
        WHEN 3 THEN 'å·²å‘è´§'
        WHEN 4 THEN 'å·²å®Œæˆ'
        WHEN 5 THEN 'å·²å–æ¶ˆ'
    END AS new_status_text,
    osl.operator_type,
    osl.remark,
    osl.created_at
FROM order_status_logs osl
JOIN orders o ON osl.order_id = o.id
WHERE o.order_no = :order_no
AND o.user_id = :user_id
ORDER BY osl.created_at;
```

---

## ä¸ƒã€è®¢å•ç»Ÿè®¡

### 7.1 è®¢å•ç»Ÿè®¡

```sql
-- è®¢å•æ€»æ•°å’Œé‡‘é¢ç»Ÿè®¡
SELECT
    COUNT(*) AS total_orders,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS pending_orders,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS paid_orders,
    SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS shipped_orders,
    SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) AS completed_orders,
    SUM(CASE WHEN status = 5 THEN 1 ELSE 0 END) AS cancelled_orders,
    SUM(CASE WHEN status IN (2, 3, 4) THEN total_amount ELSE 0 END) / 100 AS total_sales
FROM orders
WHERE deleted_at IS NULL;

-- ä»Šæ—¥è®¢å•ç»Ÿè®¡
SELECT
    COUNT(*) AS order_count,
    SUM(CASE WHEN status IN (2, 3, 4) THEN total_amount ELSE 0 END) / 100 AS total_sales,
    AVG(CASE WHEN status IN (2, 3, 4) THEN total_amount ELSE NULL END) / 100 AS avg_order_amount
FROM orders
WHERE DATE(created_at) = CURDATE()
AND deleted_at IS NULL;

-- æœ€è¿‘30å¤©è®¢å•è¶‹åŠ¿
SELECT
    DATE(created_at) AS date,
    COUNT(*) AS order_count,
    SUM(CASE WHEN status IN (2, 3, 4) THEN total_amount ELSE 0 END) / 100 AS total_sales
FROM orders
WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)
AND deleted_at IS NULL
GROUP BY DATE(created_at)
ORDER BY date;
```

---

## å…«ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **è¡¨è®¾è®¡**ï¼š
   - ordersï¼šè®¢å•ä¸»è¡¨
   - order_itemsï¼šè®¢å•æ˜ç»†è¡¨
   - order_status_logsï¼šçŠ¶æ€æ—¥å¿—è¡¨

2. **è®¢å•åˆ›å»º**ï¼š
   - ç”Ÿæˆè®¢å•å·
   - ä¿å­˜å•†å“å¿«ç…§
   - æ‰£å‡åº“å­˜
   - è®°å½•æ—¥å¿—

3. **è®¢å•æ”¯ä»˜**ï¼š
   - æ”¯ä»˜å›è°ƒå¤„ç†
   - çŠ¶æ€æ›´æ–°
   - äº‹åŠ¡ä¿è¯

4. **è®¢å•çŠ¶æ€**ï¼š
   - çŠ¶æ€æµè½¬
   - è‡ªåŠ¨ç¡®è®¤æ”¶è´§
   - è¶…æ—¶å–æ¶ˆ

5. **è®¢å•å–æ¶ˆ**ï¼š
   - ç”¨æˆ·å–æ¶ˆ
   - è‡ªåŠ¨å–æ¶ˆ
   - æ¢å¤åº“å­˜

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… è®¾è®¡å®Œæ•´çš„è®¢å•è¡¨ç»“æ„
- âœ… å®ç°è®¢å•åˆ›å»ºæµç¨‹
- âœ… å®ç°è®¢å•æ”¯ä»˜å¤„ç†
- âœ… å®ç°è®¢å•çŠ¶æ€ç®¡ç†
- âœ… å®ç°è®¢å•æŸ¥è¯¢ç»Ÿè®¡

ä¸‹ä¸€èŠ‚ï¼š[16-å†…å®¹ç®¡ç†ç³»ç»Ÿè®¾è®¡ä¸å®ç°](./16-å†…å®¹ç®¡ç†ç³»ç»Ÿè®¾è®¡ä¸å®ç°.md)
