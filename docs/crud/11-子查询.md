# 11-å­æŸ¥è¯¢

> æŒæ¡å­æŸ¥è¯¢çš„å„ç§ç±»å‹ï¼Œçµæ´»å¤„ç†å¤æ‚æŸ¥è¯¢éœ€æ±‚

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- ç†è§£å­æŸ¥è¯¢çš„æ¦‚å¿µå’Œåˆ†ç±»
- æŒæ¡WHEREå­æŸ¥è¯¢
- æŒæ¡FROMå­æŸ¥è¯¢
- æŒæ¡SELECTå­æŸ¥è¯¢
- ç†è§£ç›¸å…³å­æŸ¥è¯¢å’Œéç›¸å…³å­æŸ¥è¯¢
- æŒæ¡å­æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

---

## ä¸€ã€å­æŸ¥è¯¢åŸºç¡€

### 1.1 ä»€ä¹ˆæ˜¯å­æŸ¥è¯¢

```sql
-- å­æŸ¥è¯¢ï¼ˆSubqueryï¼‰ï¼šåµŒå¥—åœ¨å…¶ä»–SQLè¯­å¥ä¸­çš„SELECTè¯­å¥

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢ä»·æ ¼é«˜äºå¹³å‡ä»·æ ¼çš„å•†å“
SELECT *
FROM products
WHERE price_cents > (
    SELECT AVG(price_cents) FROM products
);

-- å¤–å±‚æŸ¥è¯¢ï¼šSELECT * FROM products WHERE price_cents > ...
-- å­æŸ¥è¯¢ï¼šSELECT AVG(price_cents) FROM products
```

### 1.2 å­æŸ¥è¯¢çš„ä½ç½®

```sql
-- 1. WHEREå­å¥ä¸­
SELECT * FROM users
WHERE id IN (SELECT user_id FROM orders);

-- 2. FROMå­å¥ä¸­ï¼ˆæ´¾ç”Ÿè¡¨ï¼‰
SELECT * FROM (
    SELECT * FROM users WHERE status = 1
) AS active_users;

-- 3. SELECTå­å¥ä¸­ï¼ˆæ ‡é‡å­æŸ¥è¯¢ï¼‰
SELECT
    id,
    username,
    (SELECT COUNT(*) FROM orders WHERE user_id = users.id) AS order_count
FROM users;

-- 4. HAVINGå­å¥ä¸­
SELECT category_id, AVG(price_cents) AS avg_price
FROM products
GROUP BY category_id
HAVING AVG(price_cents) > (SELECT AVG(price_cents) FROM products);
```

### 1.3 å­æŸ¥è¯¢çš„åˆ†ç±»

**æŒ‰ä½ç½®åˆ†ç±»**ï¼š
1. WHEREå­æŸ¥è¯¢
2. FROMå­æŸ¥è¯¢
3. SELECTå­æŸ¥è¯¢
4. HAVINGå­æŸ¥è¯¢

**æŒ‰ç›¸å…³æ€§åˆ†ç±»**ï¼š
1. **éç›¸å…³å­æŸ¥è¯¢**ï¼šå­æŸ¥è¯¢ç‹¬ç«‹äºå¤–å±‚æŸ¥è¯¢ï¼Œå¯å•ç‹¬æ‰§è¡Œ
2. **ç›¸å…³å­æŸ¥è¯¢**ï¼šå­æŸ¥è¯¢å¼•ç”¨äº†å¤–å±‚æŸ¥è¯¢çš„åˆ—ï¼Œéœ€è¦å¤–å±‚æŸ¥è¯¢é€è¡Œæ‰§è¡Œ

---

## äºŒã€WHEREå­æŸ¥è¯¢

### 2.1 INå­æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æœ‰è®¢å•çš„ç”¨æˆ·
SELECT *
FROM users
WHERE id IN (
    SELECT user_id FROM orders
);

-- æŸ¥è¯¢è´­ä¹°è¿‡æŸå•†å“çš„ç”¨æˆ·
SELECT *
FROM users
WHERE id IN (
    SELECT DISTINCT o.user_id
    FROM orders o
    JOIN order_items oi ON o.id = oi.order_id
    WHERE oi.product_id = 100
);

-- æŸ¥è¯¢æŸåˆ†ç±»ä¸‹çš„å•†å“
SELECT *
FROM products
WHERE category_id IN (
    SELECT id FROM categories WHERE name LIKE 'ç”µå­%'
);
```

### 2.2 NOT INå­æŸ¥è¯¢

```sql
-- æŸ¥è¯¢æ²¡æœ‰è®¢å•çš„ç”¨æˆ·
SELECT *
FROM users
WHERE id NOT IN (
    SELECT user_id FROM orders
);

-- âš ï¸ æ³¨æ„ï¼šNOT INä¸NULLçš„é™·é˜±
-- å¦‚æœå­æŸ¥è¯¢ç»“æœä¸­æœ‰NULLï¼ŒNOT INä¼šè¿”å›ç©ºç»“æœ

-- ç¤ºä¾‹
SELECT * FROM users
WHERE id NOT IN (1, 2, NULL);
-- ç»“æœï¼šç©ºï¼ˆå› ä¸º id != NULL æ€»æ˜¯NULLï¼‰

-- è§£å†³æ–¹æ¡ˆï¼šè¿‡æ»¤NULL
SELECT *
FROM users
WHERE id NOT IN (
    SELECT user_id FROM orders WHERE user_id IS NOT NULL
);

-- æˆ–ä½¿ç”¨NOT EXISTSï¼ˆæ¨èï¼‰
SELECT *
FROM users u
WHERE NOT EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);
```

### 2.3 EXISTSå­æŸ¥è¯¢

```sql
-- EXISTSï¼šæ£€æŸ¥å­æŸ¥è¯¢æ˜¯å¦è¿”å›ç»“æœ

-- æŸ¥è¯¢æœ‰è®¢å•çš„ç”¨æˆ·
SELECT *
FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);

-- NOT EXISTSï¼šæŸ¥è¯¢æ²¡æœ‰è®¢å•çš„ç”¨æˆ·
SELECT *
FROM users u
WHERE NOT EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);

-- æŸ¥è¯¢æœ‰è¯„è®ºçš„æ–‡ç« 
SELECT *
FROM articles a
WHERE EXISTS (
    SELECT 1 FROM comments c WHERE c.article_id = a.id
);
```

**EXISTS vs IN**ï¼š

```sql
-- INï¼šé€‚åˆå­æŸ¥è¯¢ç»“æœé›†å°çš„æƒ…å†µ
SELECT * FROM users
WHERE id IN (SELECT user_id FROM orders);
-- æ‰§è¡Œè¿‡ç¨‹ï¼š
-- 1. å…ˆæ‰§è¡Œå­æŸ¥è¯¢ï¼Œç”Ÿæˆç»“æœé›†
-- 2. å¤–å±‚æŸ¥è¯¢é€è¡Œæ£€æŸ¥idæ˜¯å¦åœ¨ç»“æœé›†ä¸­

-- EXISTSï¼šé€‚åˆå­æŸ¥è¯¢ç»“æœé›†å¤§çš„æƒ…å†µ
SELECT * FROM users u
WHERE EXISTS (SELECT 1 FROM orders o WHERE o.user_id = u.id);
-- æ‰§è¡Œè¿‡ç¨‹ï¼š
-- 1. å¤–å±‚æŸ¥è¯¢é€è¡Œæ‰§è¡Œ
-- 2. æ¯è¡Œæ£€æŸ¥å­æŸ¥è¯¢æ˜¯å¦æœ‰ç»“æœï¼ˆæœ‰ç»“æœå°±è¿”å›TRUEï¼ŒçŸ­è·¯ï¼‰

-- æ€§èƒ½å¯¹æ¯”ï¼š
-- INï¼šå¤–è¡¨å¤§ã€å†…è¡¨å° â†’ æ€§èƒ½å¥½
-- EXISTSï¼šå¤–è¡¨å°ã€å†…è¡¨å¤§ â†’ æ€§èƒ½å¥½
```

### 2.4 æ¯”è¾ƒè¿ç®—ç¬¦å­æŸ¥è¯¢

```sql
-- æŸ¥è¯¢ä»·æ ¼é«˜äºå¹³å‡ä»·æ ¼çš„å•†å“
SELECT *
FROM products
WHERE price_cents > (
    SELECT AVG(price_cents) FROM products
);

-- æŸ¥è¯¢ä»·æ ¼æœ€é«˜çš„å•†å“
SELECT *
FROM products
WHERE price_cents = (
    SELECT MAX(price_cents) FROM products
);

-- æŸ¥è¯¢æŸç”¨æˆ·çš„è®¢å•æ•°é‡å¤§äºå¹³å‡è®¢å•æ•°é‡çš„ç”¨æˆ·
SELECT
    user_id,
    COUNT(*) AS order_count
FROM orders
GROUP BY user_id
HAVING COUNT(*) > (
    SELECT AVG(cnt)
    FROM (
        SELECT COUNT(*) AS cnt FROM orders GROUP BY user_id
    ) AS t
);
```

### 2.5 ALLå’ŒANYå­æŸ¥è¯¢

```sql
-- ALLï¼šæ‰€æœ‰å€¼éƒ½æ»¡è¶³æ¡ä»¶

-- æŸ¥è¯¢ä»·æ ¼é«˜äºæ‰€æœ‰åˆ†ç±»1å•†å“çš„å•†å“
SELECT *
FROM products
WHERE price_cents > ALL (
    SELECT price_cents FROM products WHERE category_id = 1
);
-- ç­‰ä»·äº
SELECT *
FROM products
WHERE price_cents > (
    SELECT MAX(price_cents) FROM products WHERE category_id = 1
);

-- ANYï¼šä»»æ„ä¸€ä¸ªå€¼æ»¡è¶³æ¡ä»¶

-- æŸ¥è¯¢ä»·æ ¼é«˜äºåˆ†ç±»1ä»»æ„å•†å“çš„å•†å“
SELECT *
FROM products
WHERE price_cents > ANY (
    SELECT price_cents FROM products WHERE category_id = 1
);
-- ç­‰ä»·äº
SELECT *
FROM products
WHERE price_cents > (
    SELECT MIN(price_cents) FROM products WHERE category_id = 1
);
```

---

## ä¸‰ã€FROMå­æŸ¥è¯¢ï¼ˆæ´¾ç”Ÿè¡¨ï¼‰

### 3.1 FROMå­æŸ¥è¯¢åŸºç¡€

```sql
-- FROMå­æŸ¥è¯¢ï¼šå°†å­æŸ¥è¯¢ç»“æœä½œä¸ºä¸´æ—¶è¡¨ä½¿ç”¨

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢æ´»è·ƒç”¨æˆ·çš„è®¢å•æ•°é‡
SELECT
    u.id,
    u.username,
    COUNT(o.id) AS order_count
FROM (
    SELECT * FROM users WHERE status = 1
) AS u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.username;

-- âš ï¸ æ³¨æ„ï¼šFROMå­æŸ¥è¯¢å¿…é¡»æœ‰åˆ«å
SELECT * FROM (SELECT * FROM users) AS u;  -- âœ… æ­£ç¡®
SELECT * FROM (SELECT * FROM users);       -- âŒ é”™è¯¯
```

### 3.2 FROMå­æŸ¥è¯¢å®æˆ˜

```sql
-- ç¤ºä¾‹1ï¼šåˆ†é¡µåå†JOINï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
SELECT
    u.username,
    o.order_no,
    o.total_amount / 100 AS total
FROM (
    SELECT * FROM orders
    ORDER BY created_at DESC
    LIMIT 20
) AS o
JOIN users u ON o.user_id = u.id;

-- ç¤ºä¾‹2ï¼šå…ˆèšåˆå†JOIN
SELECT
    u.username,
    t.order_count,
    t.total_spent / 100 AS total_spent
FROM users u
JOIN (
    SELECT
        user_id,
        COUNT(*) AS order_count,
        SUM(total_amount) AS total_spent
    FROM orders
    WHERE status IN (2, 3, 4)
    GROUP BY user_id
) AS t ON u.id = t.user_id
ORDER BY t.total_spent DESC
LIMIT 100;

-- ç¤ºä¾‹3ï¼šå¤šå±‚å­æŸ¥è¯¢
SELECT
    category_name,
    product_count,
    avg_price / 100 AS avg_price_yuan
FROM (
    SELECT
        c.name AS category_name,
        COUNT(p.id) AS product_count,
        AVG(p.price_cents) AS avg_price
    FROM categories c
    LEFT JOIN products p ON c.id = p.category_id
    GROUP BY c.id, c.name
) AS t
WHERE product_count > 10
ORDER BY avg_price DESC;
```

---

## å››ã€SELECTå­æŸ¥è¯¢ï¼ˆæ ‡é‡å­æŸ¥è¯¢ï¼‰

### 4.1 SELECTå­æŸ¥è¯¢åŸºç¡€

```sql
-- SELECTå­æŸ¥è¯¢ï¼šåœ¨SELECTå­å¥ä¸­ä½¿ç”¨å­æŸ¥è¯¢

-- æŸ¥è¯¢ç”¨æˆ·åŠå…¶è®¢å•æ•°é‡
SELECT
    id,
    username,
    (SELECT COUNT(*) FROM orders WHERE user_id = users.id) AS order_count
FROM users;

-- âš ï¸ æ³¨æ„ï¼šSELECTå­æŸ¥è¯¢å¿…é¡»è¿”å›å•ä¸ªå€¼ï¼ˆæ ‡é‡ï¼‰
```

### 4.2 SELECTå­æŸ¥è¯¢å®æˆ˜

```sql
-- ç¤ºä¾‹1ï¼šæŸ¥è¯¢æ–‡ç« åŠç»Ÿè®¡ä¿¡æ¯
SELECT
    id,
    title,
    author_username,
    (SELECT COUNT(*) FROM comments WHERE article_id = articles.id) AS comment_count,
    (SELECT COUNT(*) FROM article_likes WHERE article_id = articles.id) AS like_count,
    view_count,
    created_at
FROM articles
WHERE status = 2
ORDER BY created_at DESC
LIMIT 20;

-- ç¤ºä¾‹2ï¼šæŸ¥è¯¢å•†å“åŠåº“å­˜çŠ¶æ€
SELECT
    id,
    name,
    price_cents / 100 AS price,
    stock,
    (SELECT IFNULL(SUM(quantity), 0)
     FROM order_items
     WHERE product_id = products.id
     AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
    ) AS sales_last_30_days
FROM products
WHERE status = 1;

-- ç¤ºä¾‹3ï¼šæŸ¥è¯¢ç”¨æˆ·åŠæœ€åè®¢å•æ—¶é—´
SELECT
    id,
    username,
    email,
    (SELECT MAX(created_at)
     FROM orders
     WHERE user_id = users.id
    ) AS last_order_at,
    (SELECT COUNT(*)
     FROM orders
     WHERE user_id = users.id
    ) AS order_count
FROM users
WHERE deleted_at IS NULL;
```

---

## äº”ã€ç›¸å…³å­æŸ¥è¯¢ vs éç›¸å…³å­æŸ¥è¯¢

### 5.1 éç›¸å…³å­æŸ¥è¯¢

```sql
-- éç›¸å…³å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢ç‹¬ç«‹äºå¤–å±‚æŸ¥è¯¢ï¼Œåªæ‰§è¡Œä¸€æ¬¡

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢ä»·æ ¼é«˜äºå¹³å‡ä»·æ ¼çš„å•†å“
SELECT *
FROM products
WHERE price_cents > (
    SELECT AVG(price_cents) FROM products
);

-- æ‰§è¡Œè¿‡ç¨‹ï¼š
-- 1. å…ˆæ‰§è¡Œå­æŸ¥è¯¢ï¼šSELECT AVG(price_cents) FROM products  â†’ å‡è®¾ç»“æœæ˜¯50000
-- 2. å†æ‰§è¡Œå¤–å±‚æŸ¥è¯¢ï¼šSELECT * FROM products WHERE price_cents > 50000
```

### 5.2 ç›¸å…³å­æŸ¥è¯¢

```sql
-- ç›¸å…³å­æŸ¥è¯¢ï¼šå­æŸ¥è¯¢å¼•ç”¨å¤–å±‚æŸ¥è¯¢çš„åˆ—ï¼Œå¤–å±‚æ¯è¡Œéƒ½æ‰§è¡Œä¸€æ¬¡

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢æ¯ä¸ªç”¨æˆ·åŠå…¶è®¢å•æ•°é‡
SELECT
    id,
    username,
    (SELECT COUNT(*) FROM orders WHERE user_id = users.id) AS order_count
FROM users;

-- æ‰§è¡Œè¿‡ç¨‹ï¼ˆå‡è®¾usersè¡¨æœ‰3è¡Œï¼‰ï¼š
-- 1. å¤–å±‚æŸ¥è¯¢ç¬¬1è¡Œï¼šid=1
--    æ‰§è¡Œå­æŸ¥è¯¢ï¼šSELECT COUNT(*) FROM orders WHERE user_id = 1
-- 2. å¤–å±‚æŸ¥è¯¢ç¬¬2è¡Œï¼šid=2
--    æ‰§è¡Œå­æŸ¥è¯¢ï¼šSELECT COUNT(*) FROM orders WHERE user_id = 2
-- 3. å¤–å±‚æŸ¥è¯¢ç¬¬3è¡Œï¼šid=3
--    æ‰§è¡Œå­æŸ¥è¯¢ï¼šSELECT COUNT(*) FROM orders WHERE user_id = 3

-- æ€§èƒ½é—®é¢˜ï¼šå¤–å±‚æœ‰Nè¡Œï¼Œå­æŸ¥è¯¢æ‰§è¡ŒNæ¬¡
```

### 5.3 ç›¸å…³å­æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ æ…¢æŸ¥è¯¢ï¼šç›¸å…³å­æŸ¥è¯¢
SELECT
    id,
    username,
    (SELECT COUNT(*) FROM orders WHERE user_id = users.id) AS order_count
FROM users;

-- âœ… ä¼˜åŒ–ï¼šä½¿ç”¨LEFT JOIN
SELECT
    u.id,
    u.username,
    COUNT(o.id) AS order_count
FROM users u
LEFT JOIN orders o ON u.id = o.user_id
GROUP BY u.id, u.username;

-- âŒ æ…¢æŸ¥è¯¢ï¼šæŸ¥è¯¢æ¯ä¸ªåˆ†ç±»çš„å•†å“æ•°é‡
SELECT
    id,
    name,
    (SELECT COUNT(*) FROM products WHERE category_id = categories.id) AS product_count
FROM categories;

-- âœ… ä¼˜åŒ–ï¼šä½¿ç”¨LEFT JOIN
SELECT
    c.id,
    c.name,
    COUNT(p.id) AS product_count
FROM categories c
LEFT JOIN products p ON c.id = p.category_id
GROUP BY c.id, c.name;
```

---

## å…­ã€å­æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

### 6.1 å­æŸ¥è¯¢è½¬JOIN

```sql
-- âŒ æ…¢ï¼šINå­æŸ¥è¯¢
SELECT *
FROM users
WHERE id IN (SELECT user_id FROM orders);

-- âœ… å¿«ï¼šJOIN
SELECT DISTINCT u.*
FROM users u
JOIN orders o ON u.id = o.user_id;

-- âŒ æ…¢ï¼šEXISTSç›¸å…³å­æŸ¥è¯¢
SELECT *
FROM users u
WHERE EXISTS (
    SELECT 1 FROM orders o WHERE o.user_id = u.id
);

-- âœ… å¿«ï¼šJOIN
SELECT DISTINCT u.*
FROM users u
JOIN orders o ON u.id = o.user_id;
```

### 6.2 é¿å…åœ¨å¾ªç¯ä¸­æ‰§è¡Œå­æŸ¥è¯¢

```sql
-- âŒ æ…¢ï¼šSELECTå­æŸ¥è¯¢ï¼ˆæ¯è¡Œæ‰§è¡Œä¸€æ¬¡ï¼‰
SELECT
    id,
    title,
    (SELECT COUNT(*) FROM comments WHERE article_id = articles.id) AS comment_count,
    (SELECT COUNT(*) FROM article_likes WHERE article_id = articles.id) AS like_count
FROM articles;

-- âœ… å¿«ï¼šå†—ä½™å­—æ®µï¼ˆæå‰è®¡ç®—å¥½ï¼‰
ALTER TABLE articles
ADD COLUMN comment_count INT UNSIGNED NOT NULL DEFAULT 0,
ADD COLUMN like_count INT UNSIGNED NOT NULL DEFAULT 0;

SELECT
    id,
    title,
    comment_count,
    like_count
FROM articles;

-- âœ… å¿«ï¼šLEFT JOIN
SELECT
    a.id,
    a.title,
    COUNT(DISTINCT c.id) AS comment_count,
    COUNT(DISTINCT l.id) AS like_count
FROM articles a
LEFT JOIN comments c ON a.id = c.article_id
LEFT JOIN article_likes l ON a.id = l.article_id
GROUP BY a.id, a.title;
```

### 6.3 åˆç†ä½¿ç”¨ç´¢å¼•

```sql
-- å­æŸ¥è¯¢ä¸­çš„å­—æ®µåŠ ç´¢å¼•

-- âŒ æ…¢ï¼šuser_idæ²¡æœ‰ç´¢å¼•
SELECT *
FROM users
WHERE id IN (SELECT user_id FROM orders);

-- âœ… å¿«ï¼šuser_idæœ‰ç´¢å¼•
CREATE INDEX idx_user_id ON orders(user_id);

SELECT *
FROM users
WHERE id IN (SELECT user_id FROM orders);
```

---

## ä¸ƒã€å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šæŸ¥è¯¢æ¯ä¸ªåˆ†ç±»ä¸‹ä»·æ ¼æœ€é«˜çš„å•†å“

```sql
-- æ–¹å¼1ï¼šç›¸å…³å­æŸ¥è¯¢
SELECT *
FROM products p1
WHERE price_cents = (
    SELECT MAX(price_cents)
    FROM products p2
    WHERE p2.category_id = p1.category_id
);

-- æ–¹å¼2ï¼šJOINï¼ˆæ¨èï¼‰
SELECT p.*
FROM products p
JOIN (
    SELECT category_id, MAX(price_cents) AS max_price
    FROM products
    GROUP BY category_id
) AS t ON p.category_id = t.category_id AND p.price_cents = t.max_price;
```

### æ¡ˆä¾‹2ï¼šæŸ¥è¯¢è¿ç»­3å¤©éƒ½æœ‰è®¢å•çš„ç”¨æˆ·

```sql
-- ä½¿ç”¨å­æŸ¥è¯¢
SELECT DISTINCT user_id
FROM orders o1
WHERE EXISTS (
    SELECT 1 FROM orders o2
    WHERE o2.user_id = o1.user_id
    AND DATE(o2.created_at) = DATE_ADD(DATE(o1.created_at), INTERVAL 1 DAY)
)
AND EXISTS (
    SELECT 1 FROM orders o3
    WHERE o3.user_id = o1.user_id
    AND DATE(o3.created_at) = DATE_ADD(DATE(o1.created_at), INTERVAL 2 DAY)
);
```

### æ¡ˆä¾‹3ï¼šæŸ¥è¯¢è¶…è¿‡å¹³å‡ä»·æ ¼çš„å•†å“åŠå…¶è¶…å‡ºç™¾åˆ†æ¯”

```sql
SELECT
    id,
    name,
    price_cents / 100 AS price,
    (SELECT AVG(price_cents) FROM products) / 100 AS avg_price,
    ROUND(
        (price_cents - (SELECT AVG(price_cents) FROM products))
        / (SELECT AVG(price_cents) FROM products)
        * 100,
        2
    ) AS above_avg_percent
FROM products
WHERE price_cents > (SELECT AVG(price_cents) FROM products)
ORDER BY above_avg_percent DESC;

-- ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆé¿å…é‡å¤æ‰§è¡Œå­æŸ¥è¯¢ï¼‰
SELECT
    id,
    name,
    price_cents / 100 AS price,
    t.avg_price,
    ROUND((price_cents - t.avg_price_cents) / t.avg_price_cents * 100, 2) AS above_avg_percent
FROM products
CROSS JOIN (
    SELECT
        AVG(price_cents) AS avg_price_cents,
        AVG(price_cents) / 100 AS avg_price
    FROM products
) AS t
WHERE price_cents > t.avg_price_cents
ORDER BY above_avg_percent DESC;
```

### æ¡ˆä¾‹4ï¼šæŸ¥è¯¢æ¯ä¸ªç”¨æˆ·çš„æœ€åä¸€ç¬”è®¢å•

```sql
-- æ–¹å¼1ï¼šç›¸å…³å­æŸ¥è¯¢
SELECT *
FROM orders o1
WHERE created_at = (
    SELECT MAX(created_at)
    FROM orders o2
    WHERE o2.user_id = o1.user_id
);

-- æ–¹å¼2ï¼šJOINï¼ˆæ¨èï¼‰
SELECT o.*
FROM orders o
JOIN (
    SELECT user_id, MAX(created_at) AS last_order_at
    FROM orders
    GROUP BY user_id
) AS t ON o.user_id = t.user_id AND o.created_at = t.last_order_at;

-- æ–¹å¼3ï¼šçª—å£å‡½æ•°ï¼ˆMySQL 8.0+ï¼‰
SELECT *
FROM (
    SELECT
        *,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY created_at DESC) AS rn
    FROM orders
) AS t
WHERE rn = 1;
```

---

## å…«ã€å¸¸è§é”™è¯¯

### 8.1 å­æŸ¥è¯¢è¿”å›å¤šè¡Œ

```sql
-- âŒ é”™è¯¯ï¼šå­æŸ¥è¯¢è¿”å›å¤šè¡Œï¼Œä½†ä½¿ç”¨äº† = è¿ç®—ç¬¦
SELECT *
FROM products
WHERE category_id = (
    SELECT id FROM categories WHERE name LIKE 'ç”µå­%'
);
-- ERROR: Subquery returns more than 1 row

-- âœ… æ­£ç¡®ï¼šä½¿ç”¨IN
SELECT *
FROM products
WHERE category_id IN (
    SELECT id FROM categories WHERE name LIKE 'ç”µå­%'
);
```

### 8.2 FROMå­æŸ¥è¯¢æ²¡æœ‰åˆ«å

```sql
-- âŒ é”™è¯¯ï¼šæ²¡æœ‰åˆ«å
SELECT * FROM (SELECT * FROM users WHERE status = 1);
-- ERROR: Every derived table must have its own alias

-- âœ… æ­£ç¡®ï¼šåŠ åˆ«å
SELECT * FROM (SELECT * FROM users WHERE status = 1) AS u;
```

### 8.3 SELECTå­æŸ¥è¯¢è¿”å›å¤šåˆ—æˆ–å¤šè¡Œ

```sql
-- âŒ é”™è¯¯ï¼šSELECTå­æŸ¥è¯¢è¿”å›å¤šåˆ—
SELECT
    id,
    (SELECT id, username FROM users WHERE id = 1) AS user_info
FROM orders;
-- ERROR: Operand should contain 1 column(s)

-- âœ… æ­£ç¡®ï¼šåªè¿”å›ä¸€åˆ—
SELECT
    id,
    (SELECT username FROM users WHERE id = 1) AS username
FROM orders;

-- âŒ é”™è¯¯ï¼šSELECTå­æŸ¥è¯¢è¿”å›å¤šè¡Œ
SELECT
    id,
    (SELECT username FROM users) AS username
FROM orders;
-- ERROR: Subquery returns more than 1 row

-- âœ… æ­£ç¡®ï¼šåªè¿”å›ä¸€è¡Œ
SELECT
    id,
    (SELECT username FROM users LIMIT 1) AS username
FROM orders;
```

---

## ä¹ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å­æŸ¥è¯¢åˆ†ç±»**ï¼š
   - WHEREå­æŸ¥è¯¢ï¼ˆIN, EXISTS, æ¯”è¾ƒè¿ç®—ç¬¦ï¼‰
   - FROMå­æŸ¥è¯¢ï¼ˆæ´¾ç”Ÿè¡¨ï¼‰
   - SELECTå­æŸ¥è¯¢ï¼ˆæ ‡é‡å­æŸ¥è¯¢ï¼‰

2. **IN vs EXISTS**ï¼š
   - INï¼šå­æŸ¥è¯¢ç»“æœé›†å°
   - EXISTSï¼šå­æŸ¥è¯¢ç»“æœé›†å¤§

3. **ç›¸å…³å­æŸ¥è¯¢**ï¼š
   - å¼•ç”¨å¤–å±‚æŸ¥è¯¢çš„åˆ—
   - å¤–å±‚æ¯è¡Œéƒ½æ‰§è¡Œä¸€æ¬¡
   - æ€§èƒ½é€šå¸¸è¾ƒå·®

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å­æŸ¥è¯¢è½¬JOIN
   - é¿å…SELECTå­æŸ¥è¯¢
   - ä½¿ç”¨å†—ä½™å­—æ®µ
   - åˆç†ä½¿ç”¨ç´¢å¼•

5. **å¸¸è§é”™è¯¯**ï¼š
   - å­æŸ¥è¯¢è¿”å›å¤šè¡Œ
   - FROMå­æŸ¥è¯¢æ²¡æœ‰åˆ«å
   - SELECTå­æŸ¥è¯¢è¿”å›å¤šåˆ—/å¤šè¡Œ

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… ç†è§£å­æŸ¥è¯¢çš„å„ç§ç±»å‹
- âœ… ç¼–å†™WHEREã€FROMã€SELECTå­æŸ¥è¯¢
- âœ… åŒºåˆ†ç›¸å…³å­æŸ¥è¯¢å’Œéç›¸å…³å­æŸ¥è¯¢
- âœ… ä¼˜åŒ–å­æŸ¥è¯¢æ€§èƒ½

ä¸‹ä¸€èŠ‚ï¼š[12-å¤æ‚æŸ¥è¯¢åœºæ™¯](./12-å¤æ‚æŸ¥è¯¢åœºæ™¯.md)
