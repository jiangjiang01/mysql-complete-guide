# 12-å¤æ‚æŸ¥è¯¢åœºæ™¯

> æŒæ¡UNIONã€è‡ªè¿æ¥ã€çª—å£å‡½æ•°ç­‰é«˜çº§æŸ¥è¯¢æŠ€å·§

---

## ğŸ“– æœ¬ç« ç›®æ ‡

- æŒæ¡UNIONå’ŒUNION ALL
- æŒæ¡è‡ªè¿æ¥æŸ¥è¯¢
- æŒæ¡çª—å£å‡½æ•°ï¼ˆMySQL 8.0+ï¼‰
- æŒæ¡WITH CTEé€’å½’æŸ¥è¯¢
- æŒæ¡æ¡ä»¶èšåˆ
- å®ç°è¡Œè½¬åˆ—å’Œåˆ—è½¬è¡Œ

---

## ä¸€ã€UNIONè”åˆæŸ¥è¯¢

### 1.1 UNION vs UNION ALL

```sql
-- UNIONï¼šåˆå¹¶ç»“æœé›†å¹¶å»é‡
SELECT id, username FROM users WHERE status = 1
UNION
SELECT id, username FROM users WHERE status = 2;

-- UNION ALLï¼šåˆå¹¶ç»“æœé›†ä¸å»é‡ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
SELECT id, username FROM users WHERE status = 1
UNION ALL
SELECT id, username FROM users WHERE status = 2;

-- åŒºåˆ«ï¼š
-- UNIONï¼šä¼šå¯¹ç»“æœæ’åºå»é‡ï¼Œæ…¢
-- UNION ALLï¼šç›´æ¥åˆå¹¶ï¼Œå¿«ï¼ˆæ¨èï¼Œå¦‚æœç¡®å®šæ²¡æœ‰é‡å¤ï¼‰
```

### 1.2 UNIONä½¿ç”¨è§„åˆ™

```sql
-- 1. åˆ—æ•°å¿…é¡»ç›¸åŒ
SELECT id, username FROM users
UNION
SELECT id, title FROM articles;  -- âœ… æ­£ç¡®ï¼ˆä¸¤ä¸ªå­—æ®µï¼‰

SELECT id, username, email FROM users
UNION
SELECT id, title FROM articles;  -- âŒ é”™è¯¯ï¼ˆå­—æ®µæ•°ä¸åŒï¼‰

-- 2. åˆ—çš„æ•°æ®ç±»å‹è¦å…¼å®¹
SELECT id, username FROM users
UNION
SELECT id, name FROM products;  -- âœ… æ­£ç¡®ï¼ˆidéƒ½æ˜¯INTï¼Œnameéƒ½æ˜¯VARCHARï¼‰

-- 3. ORDER BYåªèƒ½åœ¨æœ€å
SELECT id, username FROM users WHERE status = 1
UNION ALL
SELECT id, username FROM users WHERE status = 2
ORDER BY id DESC;  -- âœ… æ­£ç¡®

-- 4. åˆ—åä»¥ç¬¬ä¸€ä¸ªSELECTä¸ºå‡†
SELECT id AS user_id, username AS name FROM users
UNION ALL
SELECT id, name FROM products;
-- ç»“æœåˆ—åï¼šuser_id, name
```

### 1.3 UNIONå®æˆ˜ç¤ºä¾‹

```sql
-- ç¤ºä¾‹1ï¼šåˆå¹¶å¤šä¸ªè¡¨çš„æ•°æ®
-- éœ€æ±‚ï¼šæŸ¥è¯¢æ‰€æœ‰åŠ¨æ€ï¼ˆæ–‡ç« +è§†é¢‘+å›¾ç‰‡ï¼‰

SELECT
    'article' AS type,
    id,
    title AS content,
    user_id,
    created_at
FROM articles
WHERE status = 2

UNION ALL

SELECT
    'video' AS type,
    id,
    title AS content,
    user_id,
    created_at
FROM videos
WHERE status = 2

UNION ALL

SELECT
    'photo' AS type,
    id,
    description AS content,
    user_id,
    created_at
FROM photos
WHERE status = 2

ORDER BY created_at DESC
LIMIT 50;

-- ç¤ºä¾‹2ï¼šåˆ†é¡µä¼˜åŒ–ï¼ˆå…ˆåˆ†é¡µå†UNIONï¼‰
(SELECT * FROM orders WHERE status = 1 ORDER BY created_at DESC LIMIT 10)
UNION ALL
(SELECT * FROM orders WHERE status = 2 ORDER BY created_at DESC LIMIT 10)
UNION ALL
(SELECT * FROM orders WHERE status = 3 ORDER BY created_at DESC LIMIT 10)
ORDER BY created_at DESC
LIMIT 20;

-- ç¤ºä¾‹3ï¼šæŸ¥è¯¢ç”¨æˆ·çš„æ”¶å…¥å’Œæ”¯å‡º
SELECT
    'income' AS type,
    amount,
    created_at
FROM user_income
WHERE user_id = 1

UNION ALL

SELECT
    'expense' AS type,
    -amount AS amount,  -- æ”¯å‡ºä¸ºè´Ÿæ•°
    created_at
FROM user_expense
WHERE user_id = 1

ORDER BY created_at DESC;
```

---

## äºŒã€è‡ªè¿æ¥æŸ¥è¯¢

### 2.1 è‡ªè¿æ¥åŸºç¡€

```sql
-- è‡ªè¿æ¥ï¼šè¡¨ä¸è‡ªå·±è¿æ¥

-- ç¤ºä¾‹ï¼šå‘˜å·¥è¡¨ï¼ˆåŒ…å«ä¸Šçº§IDï¼‰
CREATE TABLE employees (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    manager_id INT
);

INSERT INTO employees VALUES
(1, 'Alice', NULL),   -- CEO
(2, 'Bob', 1),        -- Aliceçš„ä¸‹å±
(3, 'Charlie', 1),    -- Aliceçš„ä¸‹å±
(4, 'David', 2),      -- Bobçš„ä¸‹å±
(5, 'Eve', 2);        -- Bobçš„ä¸‹å±

-- æŸ¥è¯¢å‘˜å·¥åŠå…¶ä¸Šçº§
SELECT
    e.name AS employee,
    m.name AS manager
FROM employees e
LEFT JOIN employees m ON e.manager_id = m.id;

-- ç»“æœï¼š
-- Alice   | NULL
-- Bob     | Alice
-- Charlie | Alice
-- David   | Bob
-- Eve     | Bob
```

### 2.2 è‡ªè¿æ¥å®æˆ˜ç¤ºä¾‹

```sql
-- ç¤ºä¾‹1ï¼šæŸ¥è¯¢åŒä¸€åˆ†ç±»ä¸‹çš„ç›¸å…³å•†å“
SELECT
    p1.id,
    p1.name,
    GROUP_CONCAT(p2.name SEPARATOR ', ') AS related_products
FROM products p1
JOIN products p2 ON p1.category_id = p2.category_id AND p1.id != p2.id
WHERE p1.id = 100
GROUP BY p1.id, p1.name
LIMIT 5;

-- ç¤ºä¾‹2ï¼šæŸ¥è¯¢è¯„è®ºåŠå…¶å›å¤
CREATE TABLE comments (
    id INT PRIMARY KEY,
    article_id INT,
    parent_id INT,  -- çˆ¶è¯„è®ºID
    content TEXT,
    user_id INT
);

-- æŸ¥è¯¢è¯„è®ºåŠå…¶å›å¤
SELECT
    c1.id AS comment_id,
    c1.content AS comment,
    c2.id AS reply_id,
    c2.content AS reply
FROM comments c1
LEFT JOIN comments c2 ON c1.id = c2.parent_id
WHERE c1.article_id = 1
AND c1.parent_id IS NULL  -- åªæŸ¥ä¸€çº§è¯„è®º
ORDER BY c1.id, c2.id;

-- ç¤ºä¾‹3ï¼šæŸ¥è¯¢è¿ç»­ç™»å½•çš„ç”¨æˆ·
SELECT DISTINCT l1.user_id
FROM login_logs l1
JOIN login_logs l2 ON l1.user_id = l2.user_id
    AND DATE(l2.login_at) = DATE_ADD(DATE(l1.login_at), INTERVAL 1 DAY)
JOIN login_logs l3 ON l1.user_id = l3.user_id
    AND DATE(l3.login_at) = DATE_ADD(DATE(l1.login_at), INTERVAL 2 DAY);
```

---

## ä¸‰ã€çª—å£å‡½æ•°ï¼ˆMySQL 8.0+ï¼‰

### 3.1 çª—å£å‡½æ•°åŸºç¡€

```sql
-- çª—å£å‡½æ•°ï¼šåœ¨æŸ¥è¯¢ç»“æœä¸Šè¿›è¡Œè®¡ç®—ï¼Œä¸æ”¹å˜è¡Œæ•°

-- è¯­æ³•
SELECT
    column1,
    column2,
    çª—å£å‡½æ•°() OVER (
        [PARTITION BY column]
        [ORDER BY column]
        [ROWS/RANGE BETWEEN ...]
    )
FROM table;

-- å¸¸ç”¨çª—å£å‡½æ•°ï¼š
-- ROW_NUMBER()ï¼šè¡Œå·
-- RANK()ï¼šæ’åï¼ˆæœ‰å¹¶åˆ—ï¼Œè·³å·ï¼‰
-- DENSE_RANK()ï¼šæ’åï¼ˆæœ‰å¹¶åˆ—ï¼Œä¸è·³å·ï¼‰
-- LAG()ï¼šä¸Šä¸€è¡Œçš„å€¼
-- LEAD()ï¼šä¸‹ä¸€è¡Œçš„å€¼
-- FIRST_VALUE()ï¼šåˆ†ç»„å†…ç¬¬ä¸€ä¸ªå€¼
-- LAST_VALUE()ï¼šåˆ†ç»„å†…æœ€åä¸€ä¸ªå€¼
-- SUM/AVG/COUNT/MAX/MIN() OVERï¼šèšåˆå‡½æ•°
```

### 3.2 ROW_NUMBERã€RANKã€DENSE_RANK

```sql
-- ç¤ºä¾‹æ•°æ®
CREATE TABLE scores (
    id INT,
    student VARCHAR(50),
    score INT
);

INSERT INTO scores VALUES
(1, 'Alice', 95),
(2, 'Bob', 90),
(3, 'Charlie', 90),
(4, 'David', 85),
(5, 'Eve', 85),
(6, 'Frank', 80);

-- æ’å
SELECT
    student,
    score,
    ROW_NUMBER() OVER (ORDER BY score DESC) AS row_num,
    RANK() OVER (ORDER BY score DESC) AS rank_num,
    DENSE_RANK() OVER (ORDER BY score DESC) AS dense_rank_num
FROM scores;

-- ç»“æœï¼š
-- student | score | row_num | rank_num | dense_rank_num
-- --------|-------|---------|----------|---------------
-- Alice   | 95    | 1       | 1        | 1
-- Bob     | 90    | 2       | 2        | 2
-- Charlie | 90    | 3       | 2        | 2
-- David   | 85    | 4       | 4        | 3
-- Eve     | 85    | 5       | 4        | 3
-- Frank   | 80    | 6       | 6        | 4
```

### 3.3 PARTITION BYåˆ†ç»„æ’å

```sql
-- æŒ‰åˆ†ç±»æ’å
SELECT
    category_id,
    name,
    price_cents / 100 AS price,
    ROW_NUMBER() OVER (PARTITION BY category_id ORDER BY price_cents DESC) AS rank_in_category
FROM products;

-- æŸ¥è¯¢æ¯ä¸ªåˆ†ç±»çš„å‰3åå•†å“
SELECT *
FROM (
    SELECT
        category_id,
        name,
        price_cents / 100 AS price,
        ROW_NUMBER() OVER (PARTITION BY category_id ORDER BY price_cents DESC) AS rn
    FROM products
) AS t
WHERE rn <= 3;

-- æŸ¥è¯¢æ¯ä¸ªç”¨æˆ·çš„æœ€åä¸€ç¬”è®¢å•
SELECT *
FROM (
    SELECT
        *,
        ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY created_at DESC) AS rn
    FROM orders
) AS t
WHERE rn = 1;
```

### 3.4 LAGå’ŒLEAD

```sql
-- LAGï¼šè·å–ä¸Šä¸€è¡Œçš„å€¼
-- LEADï¼šè·å–ä¸‹ä¸€è¡Œçš„å€¼

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢è®¢å•åŠä¸ä¸Šä¸€ç¬”è®¢å•çš„é‡‘é¢å·®
SELECT
    id,
    order_no,
    total_amount / 100 AS amount,
    LAG(total_amount, 1) OVER (ORDER BY created_at) / 100 AS prev_amount,
    (total_amount - LAG(total_amount, 1) OVER (ORDER BY created_at)) / 100 AS diff
FROM orders
WHERE user_id = 1;

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢ç”¨æˆ·æ¯æ¬¡ç™»å½•ä¸ä¸Šæ¬¡ç™»å½•çš„é—´éš”
SELECT
    user_id,
    login_at,
    LAG(login_at, 1) OVER (PARTITION BY user_id ORDER BY login_at) AS prev_login_at,
    TIMESTAMPDIFF(HOUR,
        LAG(login_at, 1) OVER (PARTITION BY user_id ORDER BY login_at),
        login_at
    ) AS hours_since_last_login
FROM login_logs;
```

### 3.5 èšåˆçª—å£å‡½æ•°

```sql
-- ç´¯è®¡æ±‚å’Œ
SELECT
    order_date,
    amount,
    SUM(amount) OVER (ORDER BY order_date) AS cumulative_amount
FROM daily_sales
ORDER BY order_date;

-- ç§»åŠ¨å¹³å‡ï¼ˆæœ€è¿‘7å¤©ï¼‰
SELECT
    order_date,
    amount,
    AVG(amount) OVER (
        ORDER BY order_date
        ROWS BETWEEN 6 PRECEDING AND CURRENT ROW
    ) AS moving_avg_7days
FROM daily_sales;

-- å æ¯”è®¡ç®—
SELECT
    category_id,
    product_count,
    SUM(product_count) OVER () AS total,
    product_count * 100.0 / SUM(product_count) OVER () AS percentage
FROM (
    SELECT category_id, COUNT(*) AS product_count
    FROM products
    GROUP BY category_id
) AS t;
```

---

## å››ã€WITH CTEï¼ˆå…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼‰

### 4.1 CTEåŸºç¡€

```sql
-- WITH CTEï¼šå®šä¹‰ä¸´æ—¶ç»“æœé›†

-- è¯­æ³•
WITH cte_name AS (
    SELECT ...
)
SELECT * FROM cte_name;

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢æ´»è·ƒç”¨æˆ·çš„è®¢å•
WITH active_users AS (
    SELECT id, username
    FROM users
    WHERE status = 1
    AND last_login_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
)
SELECT
    au.username,
    COUNT(o.id) AS order_count
FROM active_users au
LEFT JOIN orders o ON au.id = o.user_id
GROUP BY au.id, au.username;
```

### 4.2 å¤šä¸ªCTE

```sql
-- å®šä¹‰å¤šä¸ªCTE
WITH
active_users AS (
    SELECT id, username
    FROM users
    WHERE status = 1
),
user_orders AS (
    SELECT
        user_id,
        COUNT(*) AS order_count,
        SUM(total_amount) AS total_spent
    FROM orders
    WHERE status IN (2, 3, 4)
    GROUP BY user_id
)
SELECT
    u.username,
    IFNULL(uo.order_count, 0) AS order_count,
    IFNULL(uo.total_spent, 0) / 100 AS total_spent
FROM active_users u
LEFT JOIN user_orders uo ON u.id = uo.user_id
ORDER BY total_spent DESC
LIMIT 100;
```

### 4.3 é€’å½’CTE

```sql
-- é€’å½’CTEï¼šå¤„ç†æ ‘å½¢ç»“æ„

-- ç¤ºä¾‹ï¼šæŸ¥è¯¢åˆ†ç±»æ ‘
CREATE TABLE categories (
    id INT PRIMARY KEY,
    name VARCHAR(50),
    parent_id INT
);

INSERT INTO categories VALUES
(1, 'ç”µå­äº§å“', NULL),
(2, 'æ‰‹æœº', 1),
(3, 'ç”µè„‘', 1),
(4, 'iPhone', 2),
(5, 'Android', 2),
(6, 'ç¬”è®°æœ¬', 3),
(7, 'å°å¼æœº', 3);

-- æŸ¥è¯¢æŸåˆ†ç±»çš„æ‰€æœ‰å­åˆ†ç±»ï¼ˆé€’å½’ï¼‰
WITH RECURSIVE category_tree AS (
    -- åˆå§‹æŸ¥è¯¢ï¼ˆé”šç‚¹ï¼‰
    SELECT id, name, parent_id, 1 AS level
    FROM categories
    WHERE id = 1

    UNION ALL

    -- é€’å½’æŸ¥è¯¢
    SELECT c.id, c.name, c.parent_id, ct.level + 1
    FROM categories c
    JOIN category_tree ct ON c.parent_id = ct.id
)
SELECT
    CONCAT(REPEAT('  ', level - 1), name) AS category_tree
FROM category_tree
ORDER BY id;

-- ç»“æœï¼š
-- ç”µå­äº§å“
--   æ‰‹æœº
--     iPhone
--     Android
--   ç”µè„‘
--     ç¬”è®°æœ¬
--     å°å¼æœº
```

---

## äº”ã€æ¡ä»¶èšåˆ

### 5.1 CASE WHENèšåˆ

```sql
-- ç»Ÿè®¡è®¢å•çŠ¶æ€åˆ†å¸ƒ
SELECT
    COUNT(*) AS total_orders,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS pending,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS paid,
    SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS shipped,
    SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) AS completed,
    SUM(CASE WHEN status = 5 THEN 1 ELSE 0 END) AS cancelled
FROM orders;

-- ç»Ÿè®¡ç”¨æˆ·æ¶ˆè´¹åˆ†å¸ƒ
SELECT
    COUNT(*) AS total_users,
    SUM(CASE WHEN total_spent = 0 THEN 1 ELSE 0 END) AS no_purchase,
    SUM(CASE WHEN total_spent > 0 AND total_spent < 10000 THEN 1 ELSE 0 END) AS low_spender,
    SUM(CASE WHEN total_spent >= 10000 AND total_spent < 100000 THEN 1 ELSE 0 END) AS mid_spender,
    SUM(CASE WHEN total_spent >= 100000 THEN 1 ELSE 0 END) AS high_spender
FROM (
    SELECT
        u.id,
        IFNULL(SUM(o.total_amount), 0) AS total_spent
    FROM users u
    LEFT JOIN orders o ON u.id = o.user_id
    GROUP BY u.id
) AS t;
```

### 5.2 IFèšåˆ

```sql
-- IFæ›´ç®€æ´ï¼Œä½†åŠŸèƒ½æœ‰é™

-- ç»Ÿè®¡å•†å“çŠ¶æ€
SELECT
    COUNT(*) AS total,
    SUM(IF(status = 1, 1, 0)) AS active,
    SUM(IF(status = 2, 1, 0)) AS inactive,
    SUM(IF(stock > 0, 1, 0)) AS in_stock,
    SUM(IF(stock = 0, 1, 0)) AS out_of_stock
FROM products;

-- ç»Ÿè®¡è®¢å•é‡‘é¢
SELECT
    SUM(IF(status = 2, total_amount, 0)) / 100 AS paid_amount,
    SUM(IF(status = 4, total_amount, 0)) / 100 AS completed_amount
FROM orders;
```

---

## å…­ã€è¡Œè½¬åˆ—ä¸åˆ—è½¬è¡Œ

### 6.1 è¡Œè½¬åˆ—ï¼ˆPIVOTï¼‰

```sql
-- MySQLæ²¡æœ‰PIVOTå‡½æ•°ï¼Œä½¿ç”¨CASE WHENæ¨¡æ‹Ÿ

-- ç¤ºä¾‹ï¼šç»Ÿè®¡æ¯æœˆå„çŠ¶æ€è®¢å•æ•°é‡
-- åŸå§‹æ•°æ®ï¼š
-- month  | status | count
-- -------|--------|------
-- 2024-01| 1      | 100
-- 2024-01| 2      | 200
-- 2024-02| 1      | 150

-- è¡Œè½¬åˆ—
SELECT
    DATE_FORMAT(created_at, '%Y-%m') AS month,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) AS pending,
    SUM(CASE WHEN status = 2 THEN 1 ELSE 0 END) AS paid,
    SUM(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS shipped,
    SUM(CASE WHEN status = 4 THEN 1 ELSE 0 END) AS completed
FROM orders
WHERE created_at >= '2024-01-01'
GROUP BY DATE_FORMAT(created_at, '%Y-%m')
ORDER BY month;

-- ç»“æœï¼š
-- month   | pending | paid | shipped | completed
-- --------|---------|------|---------|----------
-- 2024-01 | 100     | 200  | 150     | 120
-- 2024-02 | 150     | 250  | 180     | 160
```

### 6.2 åˆ—è½¬è¡Œï¼ˆUNPIVOTï¼‰

```sql
-- MySQLæ²¡æœ‰UNPIVOTå‡½æ•°ï¼Œä½¿ç”¨UNION ALLæ¨¡æ‹Ÿ

-- åŸå§‹æ•°æ®ï¼ˆä¸€è¡Œå¤šåˆ—ï¼‰ï¼š
-- product | Q1_sales | Q2_sales | Q3_sales | Q4_sales
-- --------|----------|----------|----------|----------
-- iPhone  | 1000     | 1200     | 1500     | 2000

CREATE TABLE product_sales (
    product VARCHAR(50),
    Q1_sales INT,
    Q2_sales INT,
    Q3_sales INT,
    Q4_sales INT
);

-- åˆ—è½¬è¡Œ
SELECT product, 'Q1' AS quarter, Q1_sales AS sales FROM product_sales
UNION ALL
SELECT product, 'Q2' AS quarter, Q2_sales AS sales FROM product_sales
UNION ALL
SELECT product, 'Q3' AS quarter, Q3_sales AS sales FROM product_sales
UNION ALL
SELECT product, 'Q4' AS quarter, Q4_sales AS sales FROM product_sales
ORDER BY product, quarter;

-- ç»“æœï¼š
-- product | quarter | sales
-- --------|---------|-------
-- iPhone  | Q1      | 1000
-- iPhone  | Q2      | 1200
-- iPhone  | Q3      | 1500
-- iPhone  | Q4      | 2000
```

---

## ä¸ƒã€å®æˆ˜æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šç”¨æˆ·ç•™å­˜åˆ†æ

```sql
-- æŸ¥è¯¢ç”¨æˆ·7æ—¥ç•™å­˜ç‡
WITH first_login AS (
    SELECT user_id, MIN(DATE(login_at)) AS first_day
    FROM login_logs
    GROUP BY user_id
),
day7_retention AS (
    SELECT
        fl.user_id,
        fl.first_day,
        CASE
            WHEN EXISTS (
                SELECT 1 FROM login_logs ll
                WHERE ll.user_id = fl.user_id
                AND DATE(ll.login_at) = DATE_ADD(fl.first_day, INTERVAL 7 DAY)
            ) THEN 1
            ELSE 0
        END AS retained
    FROM first_login fl
)
SELECT
    first_day,
    COUNT(*) AS new_users,
    SUM(retained) AS retained_users,
    ROUND(SUM(retained) * 100.0 / COUNT(*), 2) AS retention_rate
FROM day7_retention
GROUP BY first_day
ORDER BY first_day DESC;
```

### æ¡ˆä¾‹2ï¼šåŒæ¯”ç¯æ¯”åˆ†æ

```sql
-- æŸ¥è¯¢æœˆåº¦é”€å”®åŒæ¯”ç¯æ¯”
WITH monthly_sales AS (
    SELECT
        DATE_FORMAT(created_at, '%Y-%m') AS month,
        SUM(total_amount) / 100 AS sales
    FROM orders
    WHERE status IN (2, 3, 4)
    GROUP BY DATE_FORMAT(created_at, '%Y-%m')
)
SELECT
    month,
    sales,
    LAG(sales, 1) OVER (ORDER BY month) AS prev_month_sales,
    LAG(sales, 12) OVER (ORDER BY month) AS same_month_last_year_sales,
    ROUND((sales - LAG(sales, 1) OVER (ORDER BY month)) / LAG(sales, 1) OVER (ORDER BY month) * 100, 2) AS mom_growth,
    ROUND((sales - LAG(sales, 12) OVER (ORDER BY month)) / LAG(sales, 12) OVER (ORDER BY month) * 100, 2) AS yoy_growth
FROM monthly_sales
ORDER BY month DESC;
```

### æ¡ˆä¾‹3ï¼šRFMç”¨æˆ·åˆ†å±‚

```sql
-- RFMæ¨¡å‹ï¼šRecencyï¼ˆæœ€è¿‘æ¶ˆè´¹ï¼‰ã€Frequencyï¼ˆæ¶ˆè´¹é¢‘ç‡ï¼‰ã€Monetaryï¼ˆæ¶ˆè´¹é‡‘é¢ï¼‰
WITH user_rfm AS (
    SELECT
        user_id,
        DATEDIFF(CURDATE(), MAX(created_at)) AS recency,
        COUNT(*) AS frequency,
        SUM(total_amount) / 100 AS monetary
    FROM orders
    WHERE status IN (2, 3, 4)
    GROUP BY user_id
),
rfm_score AS (
    SELECT
        user_id,
        recency,
        frequency,
        monetary,
        NTILE(5) OVER (ORDER BY recency) AS r_score,
        NTILE(5) OVER (ORDER BY frequency DESC) AS f_score,
        NTILE(5) OVER (ORDER BY monetary DESC) AS m_score
    FROM user_rfm
)
SELECT
    user_id,
    recency,
    frequency,
    monetary,
    r_score,
    f_score,
    m_score,
    CASE
        WHEN r_score >= 4 AND f_score >= 4 AND m_score >= 4 THEN 'é‡è¦ä»·å€¼å®¢æˆ·'
        WHEN r_score >= 4 AND f_score >= 3 THEN 'é‡è¦å‘å±•å®¢æˆ·'
        WHEN r_score >= 3 AND f_score >= 3 AND m_score >= 3 THEN 'é‡è¦ä¿æŒå®¢æˆ·'
        WHEN r_score <= 2 AND f_score >= 3 THEN 'é‡è¦æŒ½ç•™å®¢æˆ·'
        ELSE 'ä¸€èˆ¬å®¢æˆ·'
    END AS user_type
FROM rfm_score;
```

---

## å…«ã€æœ¬ç« æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **UNION**ï¼š
   - UNIONï¼šå»é‡ï¼Œæ…¢
   - UNION ALLï¼šä¸å»é‡ï¼Œå¿«ï¼ˆæ¨èï¼‰

2. **è‡ªè¿æ¥**ï¼š
   - è¡¨ä¸è‡ªå·±è¿æ¥
   - é€‚åˆå±‚çº§ç»“æ„ã€ç›¸å…³æ•°æ®æŸ¥è¯¢

3. **çª—å£å‡½æ•°ï¼ˆMySQL 8.0+ï¼‰**ï¼š
   - ROW_NUMBERã€RANKã€DENSE_RANK
   - LAGã€LEAD
   - èšåˆçª—å£å‡½æ•°

4. **WITH CTE**ï¼š
   - æé«˜å¯è¯»æ€§
   - æ”¯æŒé€’å½’æŸ¥è¯¢

5. **æ¡ä»¶èšåˆ**ï¼š
   - CASE WHEN + SUM/COUNT
   - IF + SUM/COUNT

6. **è¡Œè½¬åˆ—/åˆ—è½¬è¡Œ**ï¼š
   - è¡Œè½¬åˆ—ï¼šCASE WHENæ¨¡æ‹ŸPIVOT
   - åˆ—è½¬è¡Œï¼šUNION ALLæ¨¡æ‹ŸUNPIVOT

### ä¸‹ä¸€æ­¥

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… ä½¿ç”¨UNIONåˆå¹¶æŸ¥è¯¢ç»“æœ
- âœ… ç¼–å†™è‡ªè¿æ¥æŸ¥è¯¢
- âœ… ä½¿ç”¨çª—å£å‡½æ•°è¿›è¡Œé«˜çº§åˆ†æ
- âœ… ä½¿ç”¨CTEç®€åŒ–å¤æ‚æŸ¥è¯¢

**ğŸ‰ æ­å–œå®Œæˆç¬¬ä¸‰ç« ï¼**

ä¸‹ä¸€ç« ï¼š[ç¬¬å››ç«  - ä¸šåŠ¡åœºæ™¯å®æˆ˜](./14-ç”¨æˆ·ç³»ç»Ÿè®¾è®¡ä¸å®ç°.md)
