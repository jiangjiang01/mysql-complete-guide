# MySQL 实操环境准备

> 在开始学习之前，我们需要先搭建一个本地MySQL环境用于实际操作

---

## 一、环境要求

- 操作系统：macOS / Linux / Windows
- MySQL版本：5.7 或 8.0（推荐 8.0）
- 客户端工具：MySQL命令行客户端
- 磁盘空间：至少 10GB 可用空间

---

## 二、MySQL 安装

### 方式一：Docker 安装（推荐）

**优点**：干净、隔离、易于管理

```bash
# 1. 拉取MySQL镜像（8.0版本）
docker pull mysql:8.0

# 2. 启动MySQL容器
docker run --name mysql-study \
  -e MYSQL_ROOT_PASSWORD=123456 \
  -p 3306:3306 \
  -v ~/mysql-data:/var/lib/mysql \
  -d mysql:8.0 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci

# 3. 验证容器是否启动成功
docker ps | grep mysql-study

# 4. 进入MySQL容器
docker exec -it mysql-study mysql -uroot -p123456
```

### 方式二：macOS Homebrew 安装

```bash
# 1. 安装MySQL
brew install mysql

# 2. 启动MySQL服务
brew services start mysql

# 3. 安全配置（可选）
mysql_secure_installation

# 4. 连接MySQL
mysql -uroot -p
```

### 方式三：Linux 安装

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server

# CentOS/RHEL
sudo yum install mysql-server

# 启动服务
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 连接
mysql -uroot -p
```

---

## 三、初始化配置

连接到MySQL后，执行以下初始化操作：

```sql
-- 1. 查看MySQL版本
SELECT VERSION();

-- 2. 查看字符集
SHOW VARIABLES LIKE 'character%';

-- 3. 创建学习用的数据库
CREATE DATABASE mysql_study DEFAULT CHARACTER SET utf8mb4;

-- 4. 使用该数据库
USE mysql_study;

-- 5. 创建测试用户（可选）
CREATE USER 'student'@'localhost' IDENTIFIED BY 'student123';
GRANT ALL PRIVILEGES ON mysql_study.* TO 'student'@'localhost';
FLUSH PRIVILEGES;
```

---

## 四、重要参数配置

为了更好地学习MySQL内部机制，建议配置以下参数：

### 查找配置文件位置

```bash
# macOS/Linux
mysql --help | grep my.cnf

# 或者
mysqladmin variables | grep 'config-file'
```

### 编辑配置文件

在 `my.cnf` 或 `my.ini` 中添加：

```ini
[mysqld]
# 服务器ID（用于主从复制实验）
server-id=1

# 开启binlog（重要！）
log-bin=mysql-bin
binlog_format=ROW
expire_logs_days=7

# redo log配置
innodb_log_file_size=256M
innodb_log_files_in_group=4
innodb_flush_log_at_trx_commit=1

# binlog持久化
sync_binlog=1

# 慢查询日志
slow_query_log=1
slow_query_log_file=/var/log/mysql/mysql-slow.log
long_query_time=2

# 通用查询日志（调试用，生产环境关闭）
general_log=0
general_log_file=/var/log/mysql/mysql-general.log

# 字符集
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# 其他性能参数
innodb_buffer_pool_size=1G
max_connections=200
```

### 重启MySQL使配置生效

```bash
# Docker方式
docker restart mysql-study

# Homebrew方式
brew services restart mysql

# Linux systemd方式
sudo systemctl restart mysqld
```

---

## 五、验证环境

执行以下SQL验证环境是否正确配置：

```sql
-- 1. 验证binlog是否开启
SHOW VARIABLES LIKE 'log_bin';
-- 应该显示 ON

-- 2. 验证binlog格式
SHOW VARIABLES LIKE 'binlog_format';
-- 应该显示 ROW

-- 3. 验证redo log配置
SHOW VARIABLES LIKE 'innodb_log%';

-- 4. 查看存储引擎
SHOW ENGINES;
-- InnoDB应该是默认引擎

-- 5. 查看当前连接信息
SHOW PROCESSLIST;

-- 6. 查看数据库列表
SHOW DATABASES;
```

---

## 六、准备示例数据

创建课程中使用的基础表结构：

```sql
USE mysql_study;

-- 创建简单测试表T（课程第1讲中的例子）
CREATE TABLE T (
    ID INT PRIMARY KEY,
    c INT
) ENGINE=InnoDB;

-- 插入测试数据
INSERT INTO T VALUES (1, 1), (2, 2), (3, 3), (4, 4), (5, 5);

-- 验证数据
SELECT * FROM T;

-- 查看表结构
DESC T;

-- 查看表的创建语句
SHOW CREATE TABLE T;
```

---

## 七、常用管理命令

### 启动/停止/重启MySQL

```bash
# Docker方式
docker start mysql-study
docker stop mysql-study
docker restart mysql-study

# macOS Homebrew
brew services start mysql
brew services stop mysql
brew services restart mysql

# Linux systemd
sudo systemctl start mysqld
sudo systemctl stop mysqld
sudo systemctl restart mysqld
sudo systemctl status mysqld
```

### 连接MySQL

```bash
# 本地连接
mysql -uroot -p

# 指定数据库连接
mysql -uroot -p mysql_study

# 远程连接
mysql -h 127.0.0.1 -P 3306 -uroot -p

# 执行SQL文件
mysql -uroot -p mysql_study < script.sql
```

### 查看日志

```bash
# Docker方式查看容器日志
docker logs mysql-study
docker logs -f mysql-study  # 实时跟踪

# 查看错误日志
tail -f /var/log/mysql/error.log

# 查看慢查询日志
tail -f /var/log/mysql/mysql-slow.log

# 查看binlog
mysqlbinlog mysql-bin.000001
```

---

## 八、工作目录说明

```
~/mysql-study/
├── scripts/          # SQL脚本文件
│   ├── 01-basic/    # 基础篇脚本
│   ├── 02-practice/ # 实践篇脚本
│   └── backup/      # 备份文件
├── logs/            # 日志文件（如果本地安装）
└── data/            # 数据文件（Docker挂载目录）
```

创建工作目录：

```bash
mkdir -p ~/mysql-study/{scripts/{01-basic,02-practice,backup},logs,data}
```

---

## 九、客户端工具推荐

### 命令行工具

1. **MySQL CLI**（官方命令行）- 已安装
2. **mycli** - 带语法高亮和自动补全

```bash
# macOS
brew install mycli

# Linux
pip install mycli

# 使用
mycli -uroot -p
```

### 图形化工具（可选）

- **MySQL Workbench**（官方免费）
- **DBeaver**（开源免费）
- **Sequel Pro / Sequel Ace**（macOS）
- **Navicat**（商业软件）

---

## 十、故障排查

### 无法启动MySQL

```bash
# 1. 查看错误日志
docker logs mysql-study
# 或
tail -f /var/log/mysql/error.log

# 2. 检查端口占用
lsof -i:3306
netstat -an | grep 3306

# 3. 检查磁盘空间
df -h

# 4. 重置MySQL（慎用）
docker rm -f mysql-study
# 重新创建容器
```

### 忘记root密码

```bash
# Docker方式
docker exec -it mysql-study bash
mysqld_safe --skip-grant-tables &
mysql
# 执行SQL重置密码
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';
FLUSH PRIVILEGES;
```

### 连接被拒绝

```sql
-- 检查用户权限
SELECT user, host FROM mysql.user;

-- 创建允许远程连接的用户
CREATE USER 'root'@'%' IDENTIFIED BY '123456';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%';
FLUSH PRIVILEGES;
```

---

## 十一、性能监控命令

```sql
-- 查看当前所有连接
SHOW FULL PROCESSLIST;

-- 查看InnoDB状态
SHOW ENGINE INNODB STATUS;

-- 查看表状态
SHOW TABLE STATUS LIKE 'T';

-- 查看索引使用情况
SHOW INDEX FROM T;

-- 查看变量
SHOW VARIABLES LIKE '%timeout%';

-- 查看状态
SHOW STATUS LIKE 'Threads%';
```

---

## 十二、环境验证清单

完成以下检查确保环境就绪：

- [ ] MySQL服务正常启动
- [ ] 能够通过命令行连接MySQL
- [ ] binlog已开启（log_bin = ON）
- [ ] 创建了 mysql_study 数据库
- [ ] 创建了测试表 T 并插入数据
- [ ] 能够执行 SELECT、INSERT、UPDATE 操作
- [ ] 查看日志文件路径正确
- [ ] 配置参数符合课程要求

验证脚本：

```sql
-- 执行以下检查
SELECT
    '环境检查' AS check_item,
    CASE
        WHEN @@version LIKE '8.0%' OR @@version LIKE '5.7%' THEN '通过'
        ELSE '版本不符'
    END AS mysql_version,
    CASE
        WHEN @@log_bin = 1 THEN '通过'
        ELSE 'binlog未开启'
    END AS binlog_status,
    CASE
        WHEN @@binlog_format = 'ROW' THEN '通过'
        ELSE 'binlog格式不正确'
    END AS binlog_format_check;

-- 查看数据库
SHOW DATABASES LIKE 'mysql_study';

-- 查看测试表
SELECT COUNT(*) AS table_exists
FROM information_schema.tables
WHERE table_schema = 'mysql_study' AND table_name = 'T';
```

---

## 准备完成！

环境搭建完成后，你可以开始：

1. **基础篇**：学习MySQL架构、日志系统、事务、索引、锁机制
2. **实践篇**：深入索引优化、性能调优、高可用架构
3. **进阶篇**：join优化、临时表、特殊场景处理

**下一步**：开始 `01-基础篇实操教程.md`
